<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Vocabulary Quiz - Gemini Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        /* Setup Screen */
        .setup-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 30px;
            text-align: center;
        }

        .setup-screen h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            color: #34495e;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .setup-screen p {
            font-size: 1.3rem;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .setup-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
            backdrop-filter: blur(10px);
        }

        .api-key-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .api-key-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
        }

        #apiKey {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8f4fd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 5px;
            background: #fafbfc;
            transition: border-color 0.3s;
        }

        #apiKey:focus {
            outline: none;
            border-color: #3498db;
        }

        .api-key-status {
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .api-key-status.saved {
            color: #27ae60;
        }

        .api-key-status.missing {
            color: #e74c3c;
        }

        #textInput {
            width: 100%;
            height: 160px;
            padding: 20px;
            border: 2px solid #e8f4fd;
            border-radius: 12px;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
            resize: none;
            background: #fafbfc;
            transition: border-color 0.3s;
        }

        #textInput:focus {
            outline: none;
            border-color: #3498db;
        }

        .setup-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setup-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }

        /* Processing Screen */
        .processing-screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 30px;
            text-align: center;
        }

        .processing-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 600px;
        }

        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 1.3rem;
            color: #34495e;
        }

        /* Preview Screen */
        .preview-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #f8fafe;
        }

        .preview-screen.active { display: flex; }

        /* Header for preview */
        .preview-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .preview-title {
            font-size: 2rem;
            font-weight: 800;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .preview-controls {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .word-count {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Preview content */
        .preview-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafe;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .preview-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #5a67d8;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .preview-word {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .preview-ipa {
            font-size: 1rem;
            color: #5a67d8;
            font-style: italic;
            margin-bottom: 5px;
        }

        .preview-meaning {
            font-size: 1rem;
            color: #27ae60;
        }

        /* Preview bottom controls */
        .preview-controls-bottom {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            border-top: 1px solid #e9ecef;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }

        /* Quiz Screen */
        .quiz-screen {
            display: none;
            height: 100vh;
            flex-direction: column;
            background: #f8fafe;
        }

        .quiz-screen.active { display: flex; }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .title {
            font-size: 2rem;
            font-weight: 800;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .count-display {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Main Content Area */
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Questions Grid - 2 cards per row */
        .questions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .vocab-card {
            background: white;
            border-radius: 15px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-left: 5px solid #e3f2fd;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            justify-content: space-between;
        }

        .vocab-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            border-left-color: #3498db;
        }

        .card-number {
            position: absolute;
            top: -8px;
            left: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .vocab-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
            flex: 1;
        }

        .vocab-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 32px;
        }

        .vocab-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #7f8c8d;
            min-width: 60px;
            flex-shrink: 0;
        }

        .vocab-value {
            flex: 1;
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .word-text {
            color: #2c3e50;
        }

        .meaning-text {
            color: #27ae60;
        }

        .ipa-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: auto;
        }

        .ipa-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #95a5a6;
            min-width: 35px;
        }

        .ipa-text {
            font-size: 1.1rem;
            color: #7f8c8d;
            font-style: italic;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .blank-space {
            display: flex;
            align-items: center;
            min-height: 32px;
            border-bottom: 3px dashed #bdc3c7;
            min-width: 150px;
            padding: 4px 8px;
            position: relative;
            transition: all 0.3s;
            background: #f8f9fa;
            border-radius: 4px;
            flex: 1;
        }

        .blank-space.revealed {
            border-bottom-color: transparent;
            background: transparent;
        }

        .blank-placeholder {
            color: #bdc3c7;
            font-style: italic;
            font-size: 1rem;
        }

        .answer-text {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            padding: 4px 8px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: 700;
            font-size: 1.3rem;
            background: rgba(255,255,255,0.95);
            border-radius: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .answer-text.show {
            opacity: 1;
        }

        .answer-text.word-answer {
            color: #2c3e50;
        }

        .answer-text.meaning-answer {
            color: #27ae60;
        }

        /* Bottom Controls */
        .bottom-controls {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            border-top: 1px solid #e9ecef;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-btn:hover { 
            transform: scale(1.05);
        }

        .reveal-btn { 
            background: linear-gradient(135deg, #f39c12, #e67e22); 
            color: white; 
        }

        .hide-btn { 
            background: linear-gradient(135deg, #95a5a6, #7f8c8d); 
            color: white; 
        }

        .reset-btn { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
        }

        /* Keyboard hints */
        .shortcuts {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            opacity: 0.8;
            backdrop-filter: blur(5px);
        }

        /* Error message */
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        /* Responsive adjustments */
        @media (max-width: 1000px) {
            .questions-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .vocab-value {
                font-size: 1.1rem;
            }
            
            .vocab-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .vocab-label {
                font-size: 0.8rem;
            }
            
            .blank-space {
                min-width: 100%;
            }
        }

        @media (min-width: 1400px) {
            .vocab-value {
                font-size: 1.4rem;
            }
            
            .questions-grid {
                gap: 20px;
            }
            
            .vocab-card {
                min-height: 140px;
            }
        }

        @media (min-width: 1800px) {
            .vocab-value {
                font-size: 1.5rem;
            }
            
            .vocab-card {
                min-height: 160px;
                padding: 22px;
            }
        }
    </style>
</head>
<body>
    <!-- Setup Screen -->
    <div id="setupScreen" class="setup-screen">
        <h1>üìö Vocabulary Cards</h1>
        <p>Clean ‚Ä¢ Intuitive ‚Ä¢ TV Optimized ‚Ä¢ Gemini Enhanced</p>
        
        <div class="setup-box">
            <div class="api-key-group">
                <div class="api-key-label">üîë Gemini API Key:</div>
                <input type="text" id="apiKey" placeholder="Enter your Gemini API key">
                <div class="api-key-status" id="apiKeyStatus"></div>
                <small style="color: #7f8c8d;">Get your key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
            </div>

            <div class="api-key-group">
                <div class="api-key-label">üìù File name to save <span style="color: #e74c3c;">*</span>:</div>
                <input type="text" id="fileName" placeholder="Enter filename (e.g., unit-01-vocabulary)" required>
                <div class="api-key-status" id="fileNameStatus"></div>
                <small style="color: #7f8c8d;">File will be saved as .md in vocabquiz folder</small>
            </div>

            <textarea id="textInput" placeholder="Paste your vocabulary here (any format)..."></textarea>
            
            <div>
                <button class="setup-btn btn-primary" onclick="processAndStart('type1')">üìù Meaning ‚Üí Word</button>
                <button class="setup-btn btn-secondary" onclick="processAndStart('type2')">üî§ Word ‚Üí Meaning</button>
                <button class="setup-btn btn-success" onclick="processAndStart('mixed')">üé≤ Mixed Quiz</button>
            </div>
        </div>
    </div>

    <!-- Processing Screen -->
    <div id="processingScreen" class="processing-screen">
        <div class="processing-box">
            <div class="loading"></div>
            <div class="processing-text">Processing with Gemini AI...</div>
        </div>
    </div>

    <!-- Preview Screen -->
    <div id="previewScreen" class="preview-screen">
        <div class="preview-header">
            <div class="preview-title">üìù Gemini Processed Vocabulary</div>
            <div class="preview-controls">
                <div class="word-count" id="wordCount">0 words</div>
                <button class="header-btn" onclick="backToSetup()">‚Üê Back to Edit</button>
            </div>
        </div>

        <div class="preview-content">
            <div class="preview-grid" id="previewGrid">
                <!-- Preview items will be generated here -->
            </div>
        </div>

        <div class="preview-controls-bottom">
            <button class="control-btn btn-primary" onclick="confirmAndStartQuiz('type1')">üìù Start: Meaning ‚Üí Word</button>
            <button class="control-btn btn-secondary" onclick="confirmAndStartQuiz('type2')">üî§ Start: Word ‚Üí Meaning</button>
            <button class="control-btn btn-success" onclick="confirmAndStartQuiz('mixed')">üé≤ Start: Mixed Quiz</button>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="quiz-screen">
        <div class="header">
            <div class="title" id="quizTitle">Vocabulary Quiz</div>
            <div class="controls">
                <div class="count-display"><span id="total">0</span> Cards</div>
                <button class="header-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                <button class="header-btn" onclick="backToPreview()">‚Üê Back</button>
            </div>
        </div>

        <div class="content-area">
            <div class="questions-grid" id="questionsGrid">
                <!-- Questions will be generated here -->
            </div>
        </div>

        <div class="bottom-controls">
            <button class="control-btn reveal-btn" id="toggleBtn" onclick="toggleAnswers()">üëÅ Show Answers</button>
            <button class="control-btn reset-btn" onclick="backToPreview()">üîÑ New Quiz</button>
        </div>

        <div class="shortcuts">
            <strong>Teacher Controls:</strong><br>
            SPACEBAR: Toggle answers<br>
            ESC: Back to preview<br>
            F: Toggle fullscreen
        </div>
    </div>

    <script>
        let vocabulary = [];
        let currentQuestions = [];
        let quizType = '';
        let answersVisible = false;
        let pendingQuizType = '';

        // Check for saved API key on load
        window.onload = function() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                updateApiKeyStatus(true);
            } else {
                updateApiKeyStatus(false);
            }
        };

        // Update API key status indicator
        function updateApiKeyStatus(saved) {
            const status = document.getElementById('apiKeyStatus');
            if (saved) {
                status.className = 'api-key-status saved';
                status.innerHTML = '‚úì API key saved';
            } else {
                status.className = 'api-key-status missing';
                status.innerHTML = '‚ö† No API key saved';
            }
        }

        // Save API key when it changes
        document.getElementById('apiKey').addEventListener('input', function(e) {
            if (e.target.value) {
                localStorage.setItem('gemini_api_key', e.target.value);
                updateApiKeyStatus(true);
            } else {
                localStorage.removeItem('gemini_api_key');
                updateApiKeyStatus(false);
            }
        });

        // Validate filename when it changes
        document.getElementById('fileName').addEventListener('input', function(e) {
            updateFileNameStatus(e.target.value.trim());
        });

        function updateFileNameStatus(fileName) {
            const status = document.getElementById('fileNameStatus');
            if (fileName) {
                // Basic filename validation
                const sanitized = sanitizeFileName(fileName);
                if (sanitized !== fileName) {
                    status.className = 'api-key-status missing';
                    status.innerHTML = '‚ö† Invalid characters will be removed';
                } else {
                    status.className = 'api-key-status saved';
                    status.innerHTML = '‚úì Valid filename';
                }
            } else {
                status.className = 'api-key-status missing';
                status.innerHTML = '‚ö† Filename is required';
            }
        }

        function sanitizeFileName(fileName) {
            return fileName
                .replace(/[^a-zA-Z0-9\-_]/g, '-')
                .replace(/--+/g, '-')
                .replace(/^-|-$/g, '')
                .toLowerCase();
        }

        async function processAndStart(type) {
            const apiKey = document.getElementById('apiKey').value.trim();
            const text = document.getElementById('textInput').value.trim();
            const fileName = document.getElementById('fileName').value.trim();

            if (!apiKey) {
                alert('Please enter your Gemini API key');
                return;
            }

            if (!fileName) {
                alert('Please enter a filename to save the vocabulary');
                document.getElementById('fileName').focus();
                return;
            }

            if (!text) {
                alert('Please paste your vocabulary!');
                return;
            }

            pendingQuizType = type;
            
            // Show processing screen
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('processingScreen').style.display = 'flex';

            try {
                const processedText = await processWithGemini(text, apiKey);
                vocabulary = parseGeminiOutput(processedText);
                
                if (vocabulary.length === 0) {
                    throw new Error('No vocabulary found in Gemini output');
                }

                // Save vocabulary
                await saveVocabulary(sanitizeFileName(fileName));

                showPreview();
            } catch (error) {
                console.error('Processing error:', error);
                alert('Error processing with Gemini: ' + error.message);
                
                // Go back to setup
                document.getElementById('processingScreen').style.display = 'none';
                document.getElementById('setupScreen').style.display = 'flex';
            }
        }

        async function processWithGemini(text, apiKey) {
            const prompt = `Convert the following vocabulary list into a standardized 3-line format. Each vocabulary entry should be formatted as:
word/phrase
/IPA pronunciation/
Vietnamese meaning

Important rules:
- Each entry must be exactly 3 lines
- Line 1: The English word or phrase (remove any part of speech like (n), (v), (adj))
- Line 2: IPA pronunciation in forward slashes (if not provided, write //)
- Line 3: Vietnamese meaning
- Leave a blank line between entries
- Do not add any extra text, explanations, or formatting
- If IPA is not provided in the input, use // as placeholder

Input vocabulary:
${text}

Output only the formatted vocabulary, nothing else:`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 2048,
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Gemini API error');
            }

            const data = await response.json();
            const processedText = data.candidates[0].content.parts[0].text;
            console.log('Gemini processed text:', processedText);
            return processedText;
        }

        function parseGeminiOutput(text) {
            const entries = text.trim().split(/\n\s*\n/);
            const parsed = [];

            for (const entry of entries) {
                const lines = entry.trim().split('\n').filter(line => line.trim());
                
                if (lines.length >= 2) {
                    let word = lines[0].trim();
                    let ipa = '';
                    let meaning = '';

                    if (lines.length === 3) {
                        ipa = lines[1].trim();
                        meaning = lines[2].trim();
                    } else if (lines.length === 2) {
                        meaning = lines[1].trim();
                    }

                    // Clean up IPA
                    if (ipa && ipa !== '//') {
                        if (!ipa.startsWith('/')) ipa = '/' + ipa;
                        if (!ipa.endsWith('/')) ipa = ipa + '/';
                    } else {
                        ipa = '';
                    }

                    parsed.push({ word, ipa, meaning });
                }
            }

            return parsed;
        }

        async function saveVocabulary(fileName) {
            try {
                const response = await fetch('http://localhost:3001/api/vocabulary/save-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vocabulary: vocabulary,
                        source: 'Vocabulary Quiz',
                        fileName: fileName
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save vocabulary');
                }

                const result = await response.json();
                console.log('Vocabulary saved:', result);
            } catch (error) {
                console.error('Error saving vocabulary:', error);
                // Don't block the user from using the app even if save fails
            }
        }

        function showPreview() {
            document.getElementById('processingScreen').style.display = 'none';
            document.getElementById('previewScreen').classList.add('active');
            
            document.getElementById('wordCount').textContent = `${vocabulary.length} words`;
            
            const grid = document.getElementById('previewGrid');
            grid.innerHTML = vocabulary.map((item, index) => `
                <div class="preview-item">
                    <div class="preview-word">${index + 1}. ${item.word}</div>
                    ${item.ipa ? `<div class="preview-ipa">${item.ipa}</div>` : ''}
                    <div class="preview-meaning">${item.meaning}</div>
                </div>
            `).join('');
        }

        function confirmAndStartQuiz(type) {
            quizType = type;
            generateQuiz();
            showQuizScreen();
        }

        function generateQuiz() {
            currentQuestions = [];
            const shuffled = [...vocabulary].sort(() => Math.random() - 0.5);
            
            shuffled.forEach((item, index) => {
                let questionType = quizType;
                if (quizType === 'mixed') {
                    questionType = Math.random() > 0.5 ? 'type1' : 'type2';
                }
                
                currentQuestions.push({
                    id: index,
                    type: questionType,
                    word: item.word,
                    meaning: item.meaning,
                    ipa: item.ipa || ''
                });
            });
        }

        function showQuizScreen() {
            document.getElementById('previewScreen').classList.remove('active');
            document.getElementById('quizScreen').classList.add('active');
            
            const typeNames = {
                'type1': 'üìù Fill in the Word',
                'type2': 'üî§ Fill in the Meaning',
                'mixed': 'üé≤ Mixed Quiz'
            };
            
            document.getElementById('quizTitle').textContent = typeNames[quizType];
            document.getElementById('total').textContent = currentQuestions.length;
            
            displayQuestions();
        }

        function displayQuestions() {
            const grid = document.getElementById('questionsGrid');
            grid.innerHTML = currentQuestions.map(q => {
                if (q.type === 'type1') {
                    // Show meaning, hide word
                    return `
                        <div class="vocab-card">
                            <div class="card-number">${q.id + 1}</div>
                            <div class="vocab-content">
                                <div class="vocab-row">
                                    <span class="vocab-label">Word:</span>
                                    <div class="blank-space" id="blank-${q.id}">
                                        <span class="blank-placeholder">___________</span>
                                        <div class="answer-text word-answer" id="answer-${q.id}">${q.word}</div>
                                    </div>
                                </div>
                                <div class="vocab-row">
                                    <span class="vocab-label">Meaning:</span>
                                    <div class="vocab-value meaning-text">${q.meaning}</div>
                                </div>
                                ${q.ipa ? `
                                <div class="ipa-row">
                                    <span class="ipa-label">IPA:</span>
                                    <div class="ipa-text">${q.ipa}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Show word, hide meaning
                    return `
                        <div class="vocab-card">
                            <div class="card-number">${q.id + 1}</div>
                            <div class="vocab-content">
                                <div class="vocab-row">
                                    <span class="vocab-label">Word:</span>
                                    <div class="vocab-value word-text">${q.word}</div>
                                </div>
                                <div class="vocab-row">
                                    <span class="vocab-label">Meaning:</span>
                                    <div class="blank-space" id="blank-${q.id}">
                                        <span class="blank-placeholder">___________</span>
                                        <div class="answer-text meaning-answer" id="answer-${q.id}">${q.meaning}</div>
                                    </div>
                                </div>
                                ${q.ipa ? `
                                <div class="ipa-row">
                                    <span class="ipa-label">IPA:</span>
                                    <div class="ipa-text">${q.ipa}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            answersVisible = false;
            updateToggleButton();
        }

        function toggleAnswers() {
            answersVisible = !answersVisible;
            
            currentQuestions.forEach(q => {
                const answerEl = document.getElementById(`answer-${q.id}`);
                const blankEl = document.getElementById(`blank-${q.id}`);
                const placeholderEl = blankEl.querySelector('.blank-placeholder');
                
                if (answersVisible) {
                    answerEl.classList.add('show');
                    blankEl.classList.add('revealed');
                    placeholderEl.style.opacity = '0';
                } else {
                    answerEl.classList.remove('show');
                    blankEl.classList.remove('revealed');
                    placeholderEl.style.opacity = '1';
                }
            });
            
            updateToggleButton();
        }

        function updateToggleButton() {
            const btn = document.getElementById('toggleBtn');
            if (answersVisible) {
                btn.textContent = 'üôà Hide Answers';
                btn.className = 'control-btn hide-btn';
            } else {
                btn.textContent = 'üëÅ Show Answers';
                btn.className = 'control-btn reveal-btn';
            }
        }

        function backToSetup() {
            document.getElementById('previewScreen').classList.remove('active');
            document.getElementById('setupScreen').style.display = 'flex';
        }

        function backToPreview() {
            document.getElementById('quizScreen').classList.remove('active');
            document.getElementById('previewScreen').classList.add('active');
            answersVisible = false;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('quizScreen').classList.contains('active')) {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        toggleAnswers();
                        break;
                    case 'Escape':
                        backToPreview();
                        break;
                    case 'f':
                    case 'F':
                        toggleFullscreen();
                        break;
                }
            }
        });
    </script>
</body>
</html>