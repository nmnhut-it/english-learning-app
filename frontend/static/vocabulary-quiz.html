<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Quiz - Gemini Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            color: #5a67d8;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: #e2e8f0;
            color: #64748b;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: #5a67d8;
            color: white;
        }

        .step.completed .step-circle {
            background: #10b981;
            color: white;
        }

        .step-label {
            font-size: 0.9rem;
            color: #64748b;
        }

        .step.active .step-label {
            color: #5a67d8;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #5a67d8;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .api-key-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .api-key-status.saved {
            color: #10b981;
        }

        .api-key-status.missing {
            color: #ef4444;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: #5a67d8;
        }

        .btn-primary:hover {
            background: #4c51bf;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 103, 216, 0.3);
        }

        .btn-secondary {
            background: #64748b;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        /* Preview Section */
        .preview-section {
            display: none;
        }

        .preview-container {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preview-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
        }

        .word-count {
            background: #5a67d8;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .vocabulary-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .vocabulary-word {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .vocabulary-ipa {
            color: #5a67d8;
            font-style: italic;
            margin-bottom: 5px;
        }

        .vocabulary-meaning {
            color: #4a5568;
        }

        /* Quiz Section */
        .quiz-section {
            display: none;
        }

        .quiz-container {
            text-align: center;
            padding: 40px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .quiz-card {
            background: #f8fafc;
            border: 3px solid #e2e8f0;
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .quiz-progress {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #64748b;
        }

        .quiz-question {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #2d3748;
            line-height: 1.4;
        }

        .quiz-answer {
            font-size: 1.5rem;
            color: #5a67d8;
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .quiz-answer.show {
            opacity: 1;
        }

        .quiz-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5a67d8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-message {
            text-align: center;
            padding: 20px;
            color: #5a67d8;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Vocabulary Quiz - Gemini Enhanced</h1>
        
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-label">Setup</div>
            </div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-label">Preview</div>
            </div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <div class="step-label">Quiz</div>
            </div>
        </div>

        <!-- Setup Section -->
        <div class="setup-section" id="setupSection">
            <div class="input-group">
                <label for="apiKey">Gemini API Key:</label>
                <input type="text" id="apiKey" placeholder="Enter your Gemini API key">
                <div class="api-key-status" id="apiKeyStatus"></div>
                <small style="color: #64748b;">Get your key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
            </div>

            <div class="input-group">
                <label for="vocabularyInput">Paste your vocabulary here (any format):</label>
                <textarea id="vocabularyInput" placeholder="Example:
apple - qu·∫£ t√°o
banana : qu·∫£ chu·ªëi
orange, qu·∫£ cam

or

dog
/d…îÀê…°/
con ch√≥

or any other format..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="processVocabulary()">
                    Process with Gemini
                </button>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="previewSection">
            <div class="preview-header">
                <div class="preview-title">üìù Gemini Processed Result</div>
                <div class="word-count" id="wordCount">0 words</div>
            </div>
            
            <div class="preview-container" id="previewContainer">
                <!-- Processed vocabulary will appear here -->
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="goBackToSetup()">
                    ‚Üê Back to Edit
                </button>
                <button class="btn-success" onclick="startQuiz(1)">
                    Start Quiz: Meaning ‚Üí Word
                </button>
                <button class="btn-warning" onclick="startQuiz(2)">
                    Start Quiz: Word ‚Üí Meaning
                </button>
                <button class="btn-primary" onclick="startQuiz(3)">
                    Start Quiz: Mixed Mode
                </button>
            </div>
        </div>

        <!-- Quiz Section -->
        <div class="quiz-section" id="quizSection">
            <div class="quiz-progress" id="quizProgress">
                Question 1 of 10
            </div>
            
            <div class="quiz-card">
                <div class="quiz-question" id="quizQuestion">
                    <!-- Question will appear here -->
                </div>
                <div class="quiz-answer" id="quizAnswer">
                    <!-- Answer will appear here -->
                </div>
            </div>

            <div class="quiz-controls">
                <button class="btn-secondary" onclick="previousCard()">
                    ‚Üê Previous
                </button>
                <button class="btn-primary" onclick="toggleAnswer()">
                    Show/Hide Answer (Space)
                </button>
                <button class="btn-secondary" onclick="nextCard()">
                    Next ‚Üí
                </button>
                <button class="btn-warning" onclick="exitQuiz()">
                    Exit Quiz (Esc)
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let vocabularyData = [];
        let currentCardIndex = 0;
        let quizMode = 1;
        let processedText = '';

        // Check for saved API key on load
        window.onload = function() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                updateApiKeyStatus(true);
            } else {
                updateApiKeyStatus(false);
            }
        };

        // Update API key status indicator
        function updateApiKeyStatus(saved) {
            const status = document.getElementById('apiKeyStatus');
            if (saved) {
                status.className = 'api-key-status saved';
                status.innerHTML = '‚úì API key saved';
            } else {
                status.className = 'api-key-status missing';
                status.innerHTML = '‚ö† No API key saved';
            }
        }

        // Save API key when it changes
        document.getElementById('apiKey').addEventListener('input', function(e) {
            if (e.target.value) {
                localStorage.setItem('gemini_api_key', e.target.value);
                updateApiKeyStatus(true);
            } else {
                localStorage.removeItem('gemini_api_key');
                updateApiKeyStatus(false);
            }
        });

        // Process vocabulary with Gemini
        async function processVocabulary() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const text = document.getElementById('vocabularyInput').value.trim();

            if (!apiKey) {
                alert('Please enter your Gemini API key');
                return;
            }

            if (!text) {
                alert('Please paste your vocabulary');
                return;
            }

            // Show loading state
            const setupSection = document.getElementById('setupSection');
            setupSection.innerHTML += '<div class="processing-message"><span class="loading"></span>Processing with Gemini AI...</div>';

            try {
                processedText = await processWithGemini(text, apiKey);
                const parsed = parseGeminiOutput(processedText);
                
                if (parsed.length === 0) {
                    throw new Error('Failed to parse Gemini output');
                }

                vocabularyData = parsed;
                showPreview();
            } catch (error) {
                console.error('Gemini processing error:', error);
                alert('Error processing with Gemini: ' + error.message);
                
                // Remove loading message
                const loadingMsg = setupSection.querySelector('.processing-message');
                if (loadingMsg) loadingMsg.remove();
            }
        }

        // Process text with Gemini API
        async function processWithGemini(text, apiKey) {
            const prompt = `Convert the following vocabulary list into a standardized 3-line format. Each vocabulary entry should be formatted as:
word/phrase
/IPA pronunciation/
Vietnamese meaning

Important rules:
- Each entry must be exactly 3 lines
- Line 1: The English word or phrase
- Line 2: IPA pronunciation in forward slashes (if not provided, write //)
- Line 3: Vietnamese meaning
- Leave a blank line between entries
- Do not add any extra text, explanations, or formatting
- If IPA is not provided in the input, use // as placeholder

Input vocabulary:
${text}

Output only the formatted vocabulary, nothing else:`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 2048,
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Gemini API error');
            }

            const data = await response.json();
            const processedText = data.candidates[0].content.parts[0].text;
            console.log('Gemini processed text:', processedText);
            return processedText;
        }

        // Parse Gemini output into vocabulary array
        function parseGeminiOutput(text) {
            const entries = text.trim().split(/\n\s*\n/);
            const vocabulary = [];

            for (const entry of entries) {
                const lines = entry.trim().split('\n').filter(line => line.trim());
                
                if (lines.length >= 2) {
                    let word = lines[0].trim();
                    let ipa = '';
                    let meaning = '';

                    if (lines.length === 3) {
                        // Standard 3-line format
                        ipa = lines[1].trim();
                        meaning = lines[2].trim();
                    } else if (lines.length === 2) {
                        // 2-line format (no IPA)
                        meaning = lines[1].trim();
                    }

                    // Clean up IPA formatting
                    if (ipa && !ipa.startsWith('/')) {
                        ipa = '/' + ipa;
                    }
                    if (ipa && !ipa.endsWith('/')) {
                        ipa = ipa + '/';
                    }

                    vocabulary.push({ word, ipa, meaning });
                }
            }

            console.log('Parsed vocabulary:', vocabulary);
            return vocabulary;
        }

        // Show preview of processed vocabulary
        function showPreview() {
            // Update step indicator
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');

            // Hide setup, show preview
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'block';

            // Update word count
            document.getElementById('wordCount').textContent = `${vocabularyData.length} words`;

            // Display vocabulary items
            const container = document.getElementById('previewContainer');
            container.innerHTML = '';

            vocabularyData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'vocabulary-item';
                itemDiv.innerHTML = `
                    <div class="vocabulary-word">${index + 1}. ${item.word}</div>
                    ${item.ipa ? `<div class="vocabulary-ipa">${item.ipa}</div>` : ''}
                    <div class="vocabulary-meaning">${item.meaning}</div>
                `;
                container.appendChild(itemDiv);
            });
        }

        // Go back to setup
        function goBackToSetup() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');

            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('setupSection').style.display = 'block';

            // Remove any loading message
            const loadingMsg = document.querySelector('.processing-message');
            if (loadingMsg) loadingMsg.remove();
        }

        // Start quiz with selected mode
        function startQuiz(mode) {
            if (vocabularyData.length === 0) {
                alert('No vocabulary data available');
                return;
            }

            quizMode = mode;
            currentCardIndex = 0;

            // Update step indicator
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');

            // Hide preview, show quiz
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('quizSection').style.display = 'block';

            // Shuffle vocabulary for random order
            vocabularyData = shuffleArray([...vocabularyData]);

            // Show first card
            showCard();
        }

        // Shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Show current card
        function showCard() {
            const card = vocabularyData[currentCardIndex];
            const progress = document.getElementById('quizProgress');
            const question = document.getElementById('quizQuestion');
            const answer = document.getElementById('quizAnswer');

            progress.textContent = `Question ${currentCardIndex + 1} of ${vocabularyData.length}`;
            answer.classList.remove('show');

            let currentMode = quizMode;
            if (quizMode === 3) {
                // Mixed mode - randomly choose
                currentMode = Math.random() < 0.5 ? 1 : 2;
            }

            if (currentMode === 1) {
                // Meaning ‚Üí Word
                question.innerHTML = card.meaning;
                answer.innerHTML = `${card.word}${card.ipa ? '<br>' + card.ipa : ''}`;
            } else {
                // Word ‚Üí Meaning
                question.innerHTML = `${card.word}${card.ipa ? '<br><span style="font-size: 0.8em; color: #5a67d8;">' + card.ipa + '</span>' : ''}`;
                answer.innerHTML = card.meaning;
            }
        }

        // Toggle answer visibility
        function toggleAnswer() {
            document.getElementById('quizAnswer').classList.toggle('show');
        }

        // Next card
        function nextCard() {
            if (currentCardIndex < vocabularyData.length - 1) {
                currentCardIndex++;
                showCard();
            } else {
                if (confirm('You\'ve completed all cards! Start over?')) {
                    currentCardIndex = 0;
                    vocabularyData = shuffleArray([...vocabularyData]);
                    showCard();
                }
            }
        }

        // Previous card
        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                showCard();
            }
        }

        // Exit quiz
        function exitQuiz() {
            if (confirm('Exit quiz and return to preview?')) {
                // Reset step indicator
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step2').classList.remove('completed');
                document.getElementById('step2').classList.add('active');

                // Show preview
                document.getElementById('quizSection').style.display = 'none';
                document.getElementById('previewSection').style.display = 'block';
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('quizSection').style.display === 'block') {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        toggleAnswer();
                        break;
                    case 'ArrowRight':
                        nextCard();
                        break;
                    case 'ArrowLeft':
                        previousCard();
                        break;
                    case 'Escape':
                        exitQuiz();
                        break;
                }
            }
        });
    </script>
</body>
</html>