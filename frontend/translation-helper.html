<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Translation Helper - Teacher Aid</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            display: none;
        }

        .result-container.active {
            display: block;
        }

        .sentence-analysis {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sentence-header {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .word-analysis {
            margin: 15px 0;
        }

        .word-item {
            display: inline-block;
            margin: 5px;
            padding: 8px 15px;
            background: #e3f2fd;
            border-radius: 20px;
            border: 1px solid #90caf9;
        }

        .word-item strong {
            color: #1976d2;
        }

        .phrase-analysis {
            margin: 15px 0;
            padding: 15px;
            background: #f3e5f5;
            border-radius: 8px;
        }

        .translation-final {
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 8px;
            font-size: 1.1em;
            border-left: 4px solid #4caf50;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            padding: 15px;
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            color: #c62828;
            margin-top: 20px;
        }

        .success-message {
            padding: 15px;
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            color: #2e7d32;
            margin-top: 20px;
        }

        .saved-indicator {
            display: inline-block;
            padding: 5px 10px;
            background: #4caf50;
            color: white;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .teacher-notes-section {
            margin-top: 20px;
            padding: 20px;
            background: #fff3e0;
            border-radius: 8px;
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .tag {
            padding: 5px 15px;
            background: #e1bee7;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .tag .remove {
            cursor: pointer;
            color: #6a1b9a;
            font-weight: bold;
        }

        .previous-translations {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .translation-item {
            padding: 10px;
            margin: 10px 0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .translation-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö English Translation Helper</h1>
            <p>Ph√¢n t√≠ch t·ª´ng t·ª´ v√† d·ªãch c√¢u - Teacher Aid System</p>
        </div>

        <div class="content">
            <!-- API Configuration -->
            <div class="section">
                <div class="section-title">üîß Configuration</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="apiKey">Gemini API Key (Optional)</label>
                        <input type="password" id="apiKey" placeholder="AIzaSy...">
                    </div>
                    <div class="form-group">
                        <label for="backendUrl">Backend URL</label>
                        <input type="text" id="backendUrl" value="http://localhost:3001" placeholder="http://localhost:3001">
                    </div>
                </div>
            </div>

            <!-- Lesson Information -->
            <div class="section">
                <div class="section-title">üìò Lesson Information</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="grade">Grade</label>
                        <select id="grade">
                            <option value="1">Grade 1</option>
                            <option value="2">Grade 2</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10" selected>Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="book">Book</label>
                        <select id="book">
                            <option value="Global Success" selected>Global Success</option>
                            <option value="English">English</option>
                            <option value="i-Learn Smart World">i-Learn Smart World</option>
                            <option value="Friends Plus">Friends Plus</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="unit">Unit</label>
                        <input type="number" id="unit" min="1" max="20" value="1">
                    </div>
                    <div class="form-group">
                        <label for="lesson">Lesson</label>
                        <select id="lesson">
                            <option value="Getting Started">Getting Started</option>
                            <option value="Language">Language</option>
                            <option value="Reading" selected>Reading</option>
                            <option value="Speaking">Speaking</option>
                            <option value="Listening">Listening</option>
                            <option value="Writing">Writing</option>
                            <option value="Communication and Culture">Communication and Culture</option>
                            <option value="Looking Back and Project">Looking Back and Project</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Input Text -->
            <div class="section">
                <div class="section-title">üìù Text to Translate</div>
                <div class="form-group">
                    <label for="inputText">English Text</label>
                    <textarea id="inputText" placeholder="Enter the English text you want to analyze and translate..."></textarea>
                </div>
                <div class="form-group">
                    <label for="context">Context (Optional)</label>
                    <input type="text" id="context" placeholder="e.g., Lesson about environment, technology, etc.">
                </div>
            </div>

            <!-- Previous Translations -->
            <div id="previousTranslations" class="previous-translations" style="display: none;">
                <div class="section-title">üìã Previous Translations</div>
                <div id="previousList"></div>
            </div>

            <!-- Action Buttons -->
            <div class="btn-group">
                <button id="translateBtn" class="btn">üîç Analyze & Translate</button>
                <button id="loadPreviousBtn" class="btn btn-secondary">üìÇ Load Previous</button>
                <button id="viewDashboardBtn" class="btn btn-success">üìä Teacher Dashboard</button>
            </div>

            <!-- Results -->
            <div id="resultContainer" class="result-container">
                <div class="section-title">üìä Analysis Results</div>
                <div id="resultContent"></div>
                
                <!-- Teacher Notes Section -->
                <div class="teacher-notes-section">
                    <div class="section-title">üìù Teacher Notes (Optional)</div>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                        ‚úÖ Translation auto-saved! Add notes below if needed.
                    </p>
                    <div class="form-group">
                        <label for="teacherNotes">Add notes for future reference</label>
                        <textarea id="teacherNotes" placeholder="Add teaching tips, common mistakes, or additional explanations..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="tags">Tags (comma-separated)</label>
                        <input type="text" id="tags" placeholder="grammar, vocabulary, speaking, etc.">
                    </div>
                    <button id="saveToBackendBtn" class="btn btn-success">üíæ Update with Notes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DEFAULT_API_KEY = 'AIzaSyB-UDl_l6FGu4d1KkRG2QE2ZC2Tlx8w0MY';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent';

        // Lesson options based on grade level
        const lessonOptions = {
            primary: [
                'Lesson 1', 'Lesson 2', 'Lesson 3', 'Review'
            ],
            thcs: [
                'Getting Started', 'A Closer Look 1', 'A Closer Look 2',
                'Communication', 'Skills 1 - Reading', 'Skills 1 - Speaking',
                'Skills 2 - Listening', 'Skills 2 - Writing', 'Looking Back', 'Project'
            ],
            thpt: [
                'Getting Started', 'Language', 'Reading', 'Speaking',
                'Listening', 'Writing', 'Communication and Culture', 'Looking Back and Project'
            ]
        };

        // Current translation data
        let currentTranslation = null;

        // Update lesson options based on grade
        document.getElementById('grade').addEventListener('change', (e) => {
            const grade = parseInt(e.target.value);
            const lessonSelect = document.getElementById('lesson');
            
            let options;
            if (grade <= 5) {
                options = lessonOptions.primary;
            } else if (grade <= 9) {
                options = lessonOptions.thcs;
            } else {
                options = lessonOptions.thpt;
            }
            
            lessonSelect.innerHTML = options.map(opt => 
                `<option value="${opt}">${opt}</option>`
            ).join('');
        });

        // Translation function
        async function translateText() {
            const apiKey = document.getElementById('apiKey').value || DEFAULT_API_KEY;
            const text = document.getElementById('inputText').value.trim();
            const grade = document.getElementById('grade').value;
            const book = document.getElementById('book').value;
            const unit = document.getElementById('unit').value;
            const lesson = document.getElementById('lesson').value;
            const context = document.getElementById('context').value;

            if (!text) {
                alert('Please enter text to translate');
                return;
            }

            // Show loading
            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');
            resultContainer.classList.add('active');
            resultContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing text...</p>
                </div>
            `;

            const prompt = createPrompt(text, grade, book, unit, lesson, context);

            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            topK: 1,
                            topP: 0.95,
                            maxOutputTokens: 8192
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();
                const analysisText = result.candidates[0].content.parts[0].text;
                
                // Parse and display results
                const parsedData = parseAnalysis(analysisText, text);
                currentTranslation = {
                    metadata: {
                        timestamp: new Date().toISOString(),
                        book: book,
                        grade: parseInt(grade),
                        unit: parseInt(unit),
                        lesson: lesson,
                        context: context,
                        totalSentences: parsedData.length
                    },
                    originalText: text,
                    analysis: parsedData
                };

                displayResults(parsedData);

                // AUTO-SAVE after Gemini response is rendered
                autoSaveTranslation();

            } catch (error) {
                console.error('Translation error:', error);
                resultContent.innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Auto-save function (called automatically after translation)
        async function autoSaveTranslation() {
            if (!currentTranslation) return;

            const backendUrl = document.getElementById('backendUrl').value;
            
            try {
                const response = await fetch(`${backendUrl}/api/translations/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentTranslation)
                });

                if (!response.ok) {
                    console.error('Auto-save failed:', response.status);
                    return;
                }

                const result = await response.json();
                
                // Show auto-save indicator
                const indicator = document.createElement('div');
                indicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; animation: fadeIn 0.5s;';
                indicator.innerHTML = '‚úÖ Auto-saved & Vocabulary exported';
                document.body.appendChild(indicator);
                
                // Remove indicator after 3 seconds
                setTimeout(() => {
                    indicator.style.animation = 'fadeOut 0.5s';
                    setTimeout(() => indicator.remove(), 500);
                }, 3000);

                console.log(`‚úÖ Auto-saved translation with ${result.data.analysis.length} sentences`);
                console.log(`‚úÖ Vocabulary auto-exported to: ${new Date().toISOString().split('T')[0]}/grade-${currentTranslation.metadata.grade}-unit-${currentTranslation.metadata.unit}-${currentTranslation.metadata.lesson.toLowerCase().replace(/\s+/g, '-')}.json`);

            } catch (error) {
                console.error('Auto-save error:', error);
                // Don't show error to user - auto-save is silent
            }
        }

        function createPrompt(text, grade, book, unit, lesson, context) {
            return `H√£y ph√¢n t√≠ch v√† d·ªãch ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Anh sau sang ti·∫øng Vi·ªát.

TH√îNG TIN B√ÄI H·ªåC:
- S√°ch: ${book}
- L·ªõp: ${grade}
- Unit: ${unit}
- B√†i: ${lesson}
${context ? `- Ng·ªØ c·∫£nh: ${context}` : ''}

VƒÇN B·∫¢N C·∫¶N D·ªäCH:
${text}

Y√äU C·∫¶U OUTPUT (JSON FORMAT):
Tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON v·ªõi m·ªói c√¢u ƒë∆∞·ª£c ph√¢n t√≠ch theo c·∫•u tr√∫c sau:
[
  {
    "index": 1,
    "original": "c√¢u ti·∫øng Anh g·ªëc",
    "words": [
      {"word": "t·ª´1", "meaning": "nghƒ©a1", "ipa": "/phi√™n √¢m/"},
      {"word": "t·ª´2", "meaning": "nghƒ©a2", "ipa": "/phi√™n √¢m/"}
    ],
    "phrases": [
      {"phrase": "c·ª•m t·ª´ 1", "meaning": "nghƒ©a c·ª•m t·ª´ 1"}
    ],
    "translation": "C√¢u d·ªãch ho√†n ch·ªânh sang ti·∫øng Vi·ªát"
  }
]

L∆ØU √ù:
1. Phi√™n √¢m IPA chu·∫©n British English
2. D·ªãch t·ª± nhi√™n, ph√π h·ª£p v·ªõi h·ªçc sinh
3. Gi·ªØ nguy√™n t√™n ri√™ng
4. Ch·ªâ tr·∫£ v·ªÅ JSON, kh√¥ng th√™m text kh√°c`;
        }

        function parseAnalysis(text, originalText) {
            try {
                // Try to parse as JSON first
                const jsonMatch = text.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                console.log('Parsing as markdown format');
            }

            // Fallback to markdown parsing
            const sentences = [];
            const lines = text.split('\n');
            let currentSentence = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('## C√¢u') || line.startsWith('### C√¢u')) {
                    if (currentSentence) {
                        sentences.push(currentSentence);
                    }

                    const match = line.match(/C√¢u (\d+):\s*"?(.+?)"?$/);
                    if (match) {
                        currentSentence = {
                            index: parseInt(match[1]),
                            original: match[2].replace(/"/g, ''),
                            words: [],
                            phrases: [],
                            translation: ''
                        };
                    }
                } else if (currentSentence) {
                    // Parse words
                    if (line.startsWith('- **') && line.includes(':')) {
                        const wordMatch = line.match(/- \*\*(.+?)\*\*:\s*(.+?)(?:\s*\/(.+?)\/)?\s*$/);
                        if (wordMatch) {
                            currentSentence.words.push({
                                word: wordMatch[1],
                                meaning: wordMatch[2],
                                ipa: wordMatch[3] || ''
                            });
                        }
                    }
                    // Parse translation
                    else if (line.startsWith('‚Üí')) {
                        currentSentence.translation = line.substring(1).trim();
                    }
                }
            }

            if (currentSentence) {
                sentences.push(currentSentence);
            }

            return sentences;
        }

        function displayResults(sentences) {
            const resultContent = document.getElementById('resultContent');
            
            let html = '';
            sentences.forEach(sentence => {
                html += `
                    <div class="sentence-analysis">
                        <div class="sentence-header">
                            C√¢u ${sentence.index}: "${sentence.original}"
                        </div>
                        
                        <div class="word-analysis">
                            <strong>Ph√¢n t√≠ch t·ª´ng t·ª´:</strong><br>
                            ${sentence.words.map(w => `
                                <span class="word-item">
                                    <strong>${w.word}</strong>: ${w.meaning} ${w.ipa ? `/${w.ipa}/` : ''}
                                </span>
                            `).join('')}
                        </div>
                        
                        ${sentence.phrases && sentence.phrases.length > 0 ? `
                            <div class="phrase-analysis">
                                <strong>C·ª•m t·ª´ quan tr·ªçng:</strong><br>
                                ${sentence.phrases.map(p => `
                                    <div>‚Ä¢ <strong>${p.phrase}</strong>: ${p.meaning}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="translation-final">
                            <strong>D·ªãch:</strong> ${sentence.translation}
                        </div>
                    </div>
                `;
            });

            resultContent.innerHTML = html;
        }

        // Save to backend
        async function saveToBackend() {
            if (!currentTranslation) {
                alert('No translation to save');
                return;
            }

            const backendUrl = document.getElementById('backendUrl').value;
            const teacherNotes = document.getElementById('teacherNotes').value;
            const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);

            // Add teacher notes and tags to translation
            const translationToSave = {
                ...currentTranslation,
                teacherNotes: teacherNotes,
                tags: tags
            };

            try {
                const response = await fetch(`${backendUrl}/api/translations/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(translationToSave)
                });

                if (!response.ok) {
                    throw new Error(`Save failed: ${response.status}`);
                }

                const result = await response.json();
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = `
                    <strong>‚úÖ Saved successfully!</strong><br>
                    ID: ${result.data.id}<br>
                    <small>You can now access this translation from the Teacher Dashboard</small>
                `;
                document.getElementById('resultContainer').appendChild(successMsg);

                // Clear teacher notes after saving
                document.getElementById('teacherNotes').value = '';
                document.getElementById('tags').value = '';

            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save translation: ' + error.message);
            }
        }

        // Load previous translations
        async function loadPrevious() {
            const backendUrl = document.getElementById('backendUrl').value;
            const grade = document.getElementById('grade').value;
            const book = document.getElementById('book').value;
            const unit = document.getElementById('unit').value;
            const lesson = document.getElementById('lesson').value;

            try {
                const response = await fetch(
                    `${backendUrl}/api/translations/${grade}/${book}/${unit}/${lesson}`
                );

                if (!response.ok) {
                    throw new Error(`Load failed: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    displayPreviousTranslations(result.data);
                } else {
                    alert('No previous translations found for this lesson');
                }

            } catch (error) {
                console.error('Load error:', error);
                alert('Failed to load previous translations: ' + error.message);
            }
        }

        function displayPreviousTranslations(translations) {
            const container = document.getElementById('previousTranslations');
            const list = document.getElementById('previousList');
            
            let html = '';
            translations.forEach(trans => {
                const date = new Date(trans.metadata.timestamp).toLocaleString();
                html += `
                    <div class="translation-item" onclick="loadTranslation('${trans.id}')">
                        <strong>${date}</strong><br>
                        <small>${trans.originalText.substring(0, 100)}...</small>
                        ${trans.teacherNotes ? `<br><em>Notes: ${trans.teacherNotes.substring(0, 50)}...</em>` : ''}
                    </div>
                `;
            });

            list.innerHTML = html;
            container.style.display = 'block';
        }

        async function loadTranslation(id) {
            const backendUrl = document.getElementById('backendUrl').value;
            const grade = document.getElementById('grade').value;
            const book = document.getElementById('book').value;
            const unit = document.getElementById('unit').value;
            const lesson = document.getElementById('lesson').value;

            try {
                const response = await fetch(
                    `${backendUrl}/api/translations/${grade}/${book}/${unit}/${lesson}/${id}`
                );

                if (!response.ok) {
                    throw new Error(`Load failed: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.data) {
                    currentTranslation = result.data;
                    document.getElementById('inputText').value = result.data.originalText;
                    document.getElementById('context').value = result.data.metadata.context || '';
                    displayResults(result.data.analysis);
                    document.getElementById('resultContainer').classList.add('active');
                    
                    if (result.data.teacherNotes) {
                        document.getElementById('teacherNotes').value = result.data.teacherNotes;
                    }
                    if (result.data.tags) {
                        document.getElementById('tags').value = result.data.tags.join(', ');
                    }
                }

            } catch (error) {
                console.error('Load error:', error);
                alert('Failed to load translation: ' + error.message);
            }
        }

        // Event listeners
        document.getElementById('translateBtn').addEventListener('click', translateText);
        document.getElementById('saveToBackendBtn').addEventListener('click', saveToBackend);
        document.getElementById('loadPreviousBtn').addEventListener('click', loadPrevious);
        document.getElementById('viewDashboardBtn').addEventListener('click', () => {
            window.open('/teacher-dashboard.html', '_blank');
        });

        // Enter key support for text area
        document.getElementById('inputText').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                translateText();
            }
        });
    </script>
</body>
</html>