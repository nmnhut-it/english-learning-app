<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unit 4: The World Around Us - Past Continuous & Used To | English Grammar Games</title>
  <meta name="description" content="Practice past continuous, past simple, and used to with interactive exercises">

  <!-- Shared Styles -->
  <link rel="stylesheet" href="../css/shared.css">
</head>
<body>
  <!-- Game Header -->
  <header class="game-header">
    <div class="container">
      <div class="game-header__container">
        <div class="game-header__info-section">
          <h1 class="game-header__title">Unit 4: The World Around Us</h1>
          <p class="game-header__subtitle">Past Continuous & Used To</p>

          <div class="game-info">
            <div class="game-info__item">
              <span class="game-info__label">GiÃ¡o viÃªn:</span>
              <span class="game-info__value">Nguyá»…n Minh Nhá»±t</span>
            </div>
            <div class="game-info__item">
              <span class="game-info__label">Há»c sinh:</span>
              <span class="game-info__value"></span>
            </div>
          </div>
        </div>

        <div class="game-header__stats">
          <div class="stat">
            <span class="stat__label">Äiá»ƒm</span>
            <span class="stat__value stat__value--primary" id="current-score">â­ 0</span>
          </div>

          <div class="stat">
            <span class="stat__label">Tiáº¿n Ä‘á»™</span>
            <span class="stat__value" id="progress-count">0 / 0</span>
          </div>

          <div class="stat" id="combo-display" style="display: none;">
            <span class="stat__label">Combo</span>
            <span class="stat__value" id="combo-count">0</span>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress">
        <div class="progress__bar" id="progress-bar" style="width: 0%;"></div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Theory Panel (Collapsible) -->
    <div class="theory-panel" id="theory-panel">
      <button class="theory-panel__toggle" id="theory-toggle">
        <span>ğŸ“– TÃ i liá»‡u ngá»¯ phÃ¡p</span>
        <span class="theory-panel__icon" id="theory-icon">â–¼</span>
      </button>

      <div class="theory-panel__content" id="theory-content">
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">ğŸ“š 1. Past Continuous (QuÃ¡ khá»© tiáº¿p diá»…n)</h3>

          <p><strong>ğŸ¯ Khi nÃ o dÃ¹ng?</strong></p>
          <p>DÃ¹ng Ä‘á»ƒ diá»…n táº£ má»™t hÃ nh Ä‘á»™ng <strong>Ä‘ang xáº£y ra</strong> táº¡i má»™t thá»i Ä‘iá»ƒm cá»¥ thá»ƒ trong quÃ¡ khá»©.</p>

          <p><strong>ğŸ“ Cáº¥u trÃºc:</strong></p>
          <ul>
            <li><strong>âœ… Kháº³ng Ä‘á»‹nh:</strong> S + was/were + V-ing
              <div class="theory-panel__example">
                I <strong>was watching</strong> TV at 8 PM yesterday. <em>(TÃ´i Ä‘ang xem TV lÃºc 8 giá» tá»‘i hÃ´m qua)</em><br>
                They <strong>were playing</strong> football. <em>(Há» Ä‘ang chÆ¡i bÃ³ng Ä‘Ã¡)</em>
              </div>
            </li>
            <li><strong>âŒ Phá»§ Ä‘á»‹nh:</strong> S + was/were + not + V-ing
              <div class="theory-panel__example">
                I <strong>wasn't studying</strong> at that time. <em>(TÃ´i khÃ´ng há»c vÃ o lÃºc Ä‘Ã³)</em><br>
                We <strong>weren't sleeping</strong>. <em>(ChÃºng tÃ´i khÃ´ng ngá»§)</em>
              </div>
            </li>
            <li><strong>â“ CÃ¢u há»i:</strong> Was/Were + S + V-ing?
              <div class="theory-panel__example">
                <strong>Were</strong> you <strong>doing</strong> homework? <em>(Báº¡n cÃ³ Ä‘ang lÃ m bÃ i táº­p khÃ´ng?)</em><br>
                What <strong>were</strong> they <strong>eating</strong>? <em>(Há» Ä‘ang Äƒn gÃ¬?)</em>
              </div>
            </li>
          </ul>

          <p><strong>ğŸ’¡ LÆ°u Ã½:</strong></p>
          <ul>
            <li>DÃ¹ng <strong>was</strong> vá»›i: I, he, she, it</li>
            <li>DÃ¹ng <strong>were</strong> vá»›i: you, we, they</li>
          </ul>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">âš¡ 2. Past Continuous + Past Simple vá»›i WHEN</h3>

          <p><strong>ğŸ¯ Khi nÃ o dÃ¹ng?</strong></p>
          <p>Khi cÃ³ <strong>hai hÃ nh Ä‘á»™ng</strong> xáº£y ra trong quÃ¡ khá»©:</p>
          <ul>
            <li><strong>HÃ nh Ä‘á»™ng dÃ i</strong> (Ä‘ang diá»…n ra) â†’ dÃ¹ng <strong>Past Continuous</strong></li>
            <li><strong>HÃ nh Ä‘á»™ng ngáº¯n</strong> (xen vÃ o) â†’ dÃ¹ng <strong>Past Simple</strong></li>
          </ul>

          <p><strong>ğŸ“ Cáº¥u trÃºc:</strong></p>
          <div class="theory-panel__example">
            <strong>S + was/were + V-ing + when + S + V2/V-ed</strong><br><br>
            I <strong>was cooking</strong> dinner <strong>when</strong> the phone <strong>rang</strong>.<br>
            <em>(TÃ´i Ä‘ang náº¥u bá»¯a tá»‘i thÃ¬ Ä‘iá»‡n thoáº¡i reo)</em><br><br>
            They <strong>were driving</strong> home <strong>when</strong> it <strong>started</strong> to rain.<br>
            <em>(Há» Ä‘ang lÃ¡i xe vá» nhÃ  thÃ¬ trá»i báº¯t Ä‘áº§u mÆ°a)</em>
          </div>

          <p><strong>ğŸ’¡ CÃ¡ch nhá»›:</strong></p>
          <p>HÃ£y tÆ°á»Ÿng tÆ°á»£ng báº¡n Ä‘ang lÃ m má»™t viá»‡c gÃ¬ Ä‘Ã³ (hÃ nh Ä‘á»™ng dÃ i), rá»“i bá»—ng nhiÃªn cÃ³ chuyá»‡n khÃ¡c xáº£y ra (hÃ nh Ä‘á»™ng ngáº¯n xen vÃ o)!</p>

          <div class="theory-panel__example">
            <strong>VÃ­ dá»¥ thá»±c táº¿:</strong><br>
            â€¢ She <strong>was reading</strong> a book when her mom <strong>called</strong>. <em>(CÃ´ áº¥y Ä‘ang Ä‘á»c sÃ¡ch thÃ¬ máº¹ gá»i)</em><br>
            â€¢ We <strong>were having</strong> lunch when someone <strong>knocked</strong> on the door. <em>(ChÃºng tÃ´i Ä‘ang Äƒn trÆ°a thÃ¬ cÃ³ ngÆ°á»i gÃµ cá»­a)</em>
          </div>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">ğŸ•°ï¸ 3. Used to (ÄÃ£ tá»«ng / ThÆ°á»ng)</h3>

          <p><strong>ğŸ¯ Khi nÃ o dÃ¹ng?</strong></p>
          <p>DÃ¹ng Ä‘á»ƒ nÃ³i vá» <strong>thÃ³i quen</strong> hoáº·c <strong>tÃ¬nh huá»‘ng</strong> trong quÃ¡ khá»© mÃ  <strong>hiá»‡n táº¡i khÃ´ng cÃ²n ná»¯a</strong>.</p>

          <p><strong>ğŸ“ Cáº¥u trÃºc:</strong></p>
          <ul>
            <li><strong>âœ… Kháº³ng Ä‘á»‹nh:</strong> S + used to + V (nguyÃªn máº«u)
              <div class="theory-panel__example">
                I <strong>used to play</strong> football every day. <em>(TÃ´i tá»«ng chÆ¡i bÃ³ng má»—i ngÃ y - bÃ¢y giá» khÃ´ng cÃ²n)</em><br>
                She <strong>used to live</strong> in Hanoi. <em>(CÃ´ áº¥y tá»«ng sá»‘ng á»Ÿ HÃ  Ná»™i - giá» khÃ´ng cÃ²n)</em>
              </div>
            </li>
            <li><strong>âŒ Phá»§ Ä‘á»‹nh:</strong> S + didn't use to + V (nguyÃªn máº«u)
              <div class="theory-panel__example">
                I <strong>didn't use to like</strong> vegetables. <em>(TÃ´i khÃ´ng thÃ­ch rau trÆ°á»›c Ä‘Ã¢y - giá» thÃ­ch)</em><br>
                We <strong>didn't use to have</strong> a car. <em>(ChÃºng tÃ´i khÃ´ng cÃ³ xe trÆ°á»›c Ä‘Ã¢y)</em>
              </div>
            </li>
            <li><strong>â“ CÃ¢u há»i:</strong> Did + S + use to + V (nguyÃªn máº«u)?
              <div class="theory-panel__example">
                <strong>Did</strong> you <strong>use to play</strong> games? <em>(Báº¡n cÃ³ thÆ°á»ng chÆ¡i game khÃ´ng?)</em><br>
                <strong>Did</strong> they <strong>use to travel</strong> a lot? <em>(Há» cÃ³ thÆ°á»ng Ä‘i du lá»‹ch khÃ´ng?)</em>
              </div>
            </li>
          </ul>

          <p><strong>ğŸ’¡ LÆ°u Ã½ quan trá»ng:</strong></p>
          <ul>
            <li>âœ… Kháº³ng Ä‘á»‹nh: <strong>used to</strong> (cÃ³ -d)</li>
            <li>âŒ Phá»§ Ä‘á»‹nh/CÃ¢u há»i: <strong>use to</strong> (khÃ´ng cÃ³ -d) vÃ¬ Ä‘Ã£ cÃ³ "didn't" hoáº·c "did"</li>
          </ul>

          <div class="theory-panel__example">
            <strong>So sÃ¡nh:</strong><br>
            â€¢ I <strong>used to</strong> drink coffee. âœ… (Kháº³ng Ä‘á»‹nh - cÃ³ -d)<br>
            â€¢ I didn't <strong>use to</strong> drink coffee. âœ… (Phá»§ Ä‘á»‹nh - khÃ´ng -d)<br>
            â€¢ Did you <strong>use to</strong> drink coffee? âœ… (CÃ¢u há»i - khÃ´ng -d)
          </div>
        </div>

        <div class="theory-panel__section" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px;">
          <h3 class="theory-panel__heading">ğŸ“ TÃ³m táº¯t cho GiÃ¡o viÃªn</h3>
          <ul style="margin: 10px 0;">
            <li><strong>Past Continuous:</strong> Nháº¥n máº¡nh hÃ nh Ä‘á»™ng Ä‘ang diá»…n ra trong quÃ¡ khá»© (was/were + V-ing)</li>
            <li><strong>When káº¿t há»£p:</strong> HÃ nh Ä‘á»™ng dÃ i (Past Continuous) + hÃ nh Ä‘á»™ng ngáº¯n xen vÃ o (Past Simple)</li>
            <li><strong>Used to:</strong> ThÃ³i quen/tÃ¬nh huá»‘ng quÃ¡ khá»© khÃ´ng cÃ²n (kháº³ng Ä‘á»‹nh cÃ³ -d, phá»§ Ä‘á»‹nh/há»i khÃ´ng -d)</li>
            <li><strong>Äiá»ƒm hay nháº§m:</strong> Há»c sinh thÆ°á»ng quÃªn -ing trong Past Continuous, hoáº·c nháº§m "used to" vs "use to"</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Exercise Container -->
    <div id="exercise-container">
      <!-- Exercises will be rendered here dynamically -->
      <div class="card text-center">
        <h2>Loading...</h2>
        <p>Please wait while we load the exercises.</p>
      </div>
    </div>
  </main>

  <!-- Core JavaScript (loaded first) -->
  <script src="../js/core/utils.js"></script>
  <script src="../js/core/storage.js"></script>
  <script src="../js/core/telegram-sender.js"></script>
  <script src="../js/core/game-engine.js"></script>

  <!-- Exercise Type Handlers (mobile-friendly types only) -->
  <script src="../js/exercises/multiple-choice.js"></script>
  <script src="../js/exercises/word-rearrange.js"></script>

  <!-- Initialize Game -->
  <script>
    const UNIT_ID = 'unit-4-world-around-us';
    const DATA_PATH = '../data/unit-4-world-around-us.json';

    // Theory panel toggle
    const theoryToggle = document.getElementById('theory-toggle');
    const theoryContent = document.getElementById('theory-content');
    const theoryIcon = document.getElementById('theory-icon');

    theoryToggle.addEventListener('click', () => {
      const isExpanded = theoryContent.classList.contains('theory-panel__content--expanded');

      if (isExpanded) {
        theoryContent.classList.remove('theory-panel__content--expanded');
        theoryIcon.classList.remove('theory-panel__icon--rotated');
      } else {
        theoryContent.classList.add('theory-panel__content--expanded');
        theoryIcon.classList.add('theory-panel__icon--rotated');
      }
    });

    // Combo display logic
    function updateComboDisplay() {
      const comboDisplay = document.getElementById('combo-display');
      const comboCount = document.getElementById('combo-count');
      const state = GameEngine.getState();

      if (state.comboCount >= 3) {
        comboDisplay.style.display = 'flex';
        comboCount.textContent = state.comboCount + 'x ğŸ”¥';
      } else {
        comboDisplay.style.display = 'none';
      }
    }

    // Override GameEngine.updateUI to include combo display
    const originalUpdateUI = GameEngine.updateUI.bind(GameEngine);
    GameEngine.updateUI = function() {
      originalUpdateUI();
      updateComboDisplay();
    };

    // Load unit data and start game
    async function loadAndStartGame() {
      try {
        const response = await fetch(DATA_PATH);

        if (!response.ok) {
          throw new Error(`Failed to load data: ${response.status}`);
        }

        const unitData = await response.json();

        console.log('Unit data loaded:', unitData);
        console.log('Registered exercise handlers:', Object.keys(GameEngine.exerciseHandlers));

        GameEngine.init(unitData, UNIT_ID);

      } catch (error) {
        console.error('Error loading game data:', error);

        const container = document.getElementById('exercise-container');
        container.innerHTML = `
          <div class="card">
            <h2 style="color: var(--danger);">Error Loading Game</h2>
            <p>Sorry, we couldn't load the exercise data. Please try refreshing the page.</p>
            <p style="font-size: var(--font-size-sm); color: var(--text-light);">Error: ${error.message}</p>
            <button class="btn btn--primary mt-2" onclick="location.reload()">Reload Page</button>
          </div>
        `;
      }
    }

    // Start game when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAndStartGame);
    } else {
      loadAndStartGame();
    }
  </script>
</body>
</html>
