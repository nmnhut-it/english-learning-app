<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ã”n Thi VÃ o Lá»›p 10 - Äá»c Hiá»ƒu | English Grammar Games</title>
  <meta name="description" content="Luyá»‡n táº­p Ä‘á»c hiá»ƒu tiáº¿ng Anh thi vÃ o lá»›p 10 vá»›i bÃ i táº­p tÆ°Æ¡ng tÃ¡c">

  <!-- Shared Styles -->
  <link rel="stylesheet" href="../css/shared.css">
</head>
<body>
  <!-- Game Header -->
  <header class="game-header">
    <div class="container">
      <div class="game-header__container">
        <div class="game-header__info-section">
          <h1 class="game-header__title">Ã”n Thi VÃ o Lá»›p 10</h1>
          <p class="game-header__subtitle">Reading Comprehension - Äá»c Hiá»ƒu</p>

          <div class="game-info">
            <div class="game-info__item">
              <span class="game-info__label">GiÃ¡o viÃªn:</span>
              <span class="game-info__value">Nguyá»…n Minh Nhá»±t</span>
            </div>
            <div class="game-info__item">
              <span class="game-info__label">Há»c sinh:</span>
              <span class="game-info__value"></span>
            </div>
          </div>
        </div>

        <div class="game-header__stats">
          <div class="stat">
            <span class="stat__label">Äiá»ƒm</span>
            <span class="stat__value stat__value--primary" id="current-score">â­ 0</span>
          </div>

          <div class="stat">
            <span class="stat__label">Tiáº¿n Ä‘á»™</span>
            <span class="stat__value" id="progress-count">0 / 0</span>
          </div>

          <div class="stat" id="combo-display" style="display: none;">
            <span class="stat__label">Combo</span>
            <span class="stat__value" id="combo-count">0</span>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress">
        <div class="progress__bar" id="progress-bar" style="width: 0%;"></div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Tips Panel (Collapsible) -->
    <div class="theory-panel" id="theory-panel">
      <button class="theory-panel__toggle" id="theory-toggle">
        <span>ğŸ’¡ Máº¹o lÃ m bÃ i Ä‘á»c hiá»ƒu</span>
        <span class="theory-panel__icon" id="theory-icon">â–¼</span>
      </button>

      <div class="theory-panel__content" id="theory-content">
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">ğŸ“– Chiáº¿n lÆ°á»£c lÃ m bÃ i Ä‘á»c hiá»ƒu</h3>

          <h4 style="margin-top: 1rem; color: var(--primary);">1. Äá»c cÃ¢u há»i trÆ°á»›c</h4>
          <p>Äá»c lÆ°á»›t qua cÃ¡c cÃ¢u há»i Ä‘á»ƒ biáº¿t cáº§n tÃ¬m thÃ´ng tin gÃ¬ trong bÃ i.</p>

          <h4 style="margin-top: 1rem; color: var(--primary);">2. XÃ¡c Ä‘á»‹nh tá»« khÃ³a</h4>
          <p>Gáº¡ch chÃ¢n tá»« khÃ³a trong cÃ¢u há»i, sau Ä‘Ã³ tÃ¬m tá»« Ä‘Ã³ hoáº·c tá»« Ä‘á»“ng nghÄ©a trong bÃ i Ä‘á»c.</p>

          <h4 style="margin-top: 1rem; color: var(--primary);">3. CÃ¡c dáº¡ng cÃ¢u há»i thÆ°á»ng gáº·p</h4>
          <div class="theory-panel__example">
            <strong>Main idea:</strong> "What is the passage mainly about?" â†’ Äá»c cÃ¢u Ä‘áº§u má»—i Ä‘oáº¡n<br><br>
            <strong>Detail:</strong> "According to the passage..." â†’ TÃ¬m chi tiáº¿t cá»¥ thá»ƒ trong bÃ i<br><br>
            <strong>Reference:</strong> "The word 'it' refers to..." â†’ Xem danh tá»« á»Ÿ cÃ¢u trÆ°á»›c<br><br>
            <strong>NOT true:</strong> "Which is NOT mentioned?" â†’ Loáº¡i 3 Ä‘Ã¡p Ã¡n Ä‘Ãºng<br><br>
            <strong>Inference:</strong> "It can be inferred that..." â†’ Suy luáº­n tá»« thÃ´ng tin trong bÃ i
          </div>

          <h4 style="margin-top: 1rem; color: var(--primary);">4. Quáº£n lÃ½ thá»i gian</h4>
          <p>KhÃ´ng dÃ nh quÃ¡ nhiá»u thá»i gian cho má»™t cÃ¢u. Náº¿u khÃ³, Ä‘Ã¡nh dáº¥u vÃ  quay láº¡i sau.</p>
        </div>
      </div>
    </div>

    <!-- Exercise Container -->
    <div id="exercise-container" class="exercise-container">
      <!-- Loading state -->
      <div class="card loading-card">
        <div class="loading-spinner"></div>
        <p>Äang táº£i bÃ i táº­p...</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="game-footer">
    <div class="container">
      <p>Â© 2024 English Grammar Games - Nguyá»…n Minh Nhá»±t</p>
      <a href="../index.html" class="btn btn--secondary btn--small">ğŸ  Vá» trang chá»§</a>
    </div>
  </footer>

  <!-- Core JavaScript (loaded first) -->
  <script src="../js/core/utils.js"></script>
  <script src="../js/core/storage.js"></script>
  <script src="../js/core/telegram-sender.js"></script>
  <script src="../js/core/game-engine.js"></script>

  <!-- Exercise Type Handlers -->
  <script src="../js/exercises/reading-comprehension.js"></script>

  <!-- Initialize Game -->
  <script>
    const UNIT_ID = 'on-thi-10-doc-hieu';
    const DATA_PATH = '../data/on-thi-10-doc-hieu.json';

    // Theory panel toggle
    const theoryToggle = document.getElementById('theory-toggle');
    const theoryContent = document.getElementById('theory-content');
    const theoryIcon = document.getElementById('theory-icon');

    theoryToggle.addEventListener('click', () => {
      const isExpanded = theoryContent.classList.contains('theory-panel__content--expanded');

      if (isExpanded) {
        theoryContent.classList.remove('theory-panel__content--expanded');
        theoryIcon.classList.remove('theory-panel__icon--rotated');
      } else {
        theoryContent.classList.add('theory-panel__content--expanded');
        theoryIcon.classList.add('theory-panel__icon--rotated');
      }
    });

    // Combo display logic
    function updateComboDisplay() {
      const comboDisplay = document.getElementById('combo-display');
      const comboCount = document.getElementById('combo-count');
      const state = GameEngine.getState();

      if (state.comboCount >= 3) {
        comboDisplay.style.display = 'flex';
        comboCount.textContent = state.comboCount + 'x ğŸ”¥';
      } else {
        comboDisplay.style.display = 'none';
      }
    }

    // Override GameEngine.updateUI to include combo display
    const originalUpdateUI = GameEngine.updateUI.bind(GameEngine);
    GameEngine.updateUI = function() {
      originalUpdateUI();
      updateComboDisplay();
    };

    // Custom question counter for reading comprehension
    // Since each exercise is a passage with multiple questions
    GameEngine.calculateTotalQuestions = function(exercises) {
      return exercises.reduce((total, exercise) => {
        if (exercise.type === 'reading-comprehension') {
          return total + (exercise.questions?.length || 1);
        }
        return total + 1;
      }, 0);
    };

    // Custom answer handler for reading comprehension
    const originalHandleAnswer = GameEngine.handleAnswer.bind(GameEngine);
    GameEngine.handleAnswer = function(userAnswer, exercise) {
      if (exercise.type === 'reading-comprehension' && typeof userAnswer === 'object') {
        // Handle reading comprehension with partial scoring
        const correctCount = userAnswer.correctCount || 0;
        const totalQuestions = userAnswer.totalQuestions || 1;
        const pointsPerQuestion = (exercise.points || 50) / totalQuestions;

        // Update state
        this.state.correctAnswers += correctCount;
        this.state.score += Math.round(correctCount * pointsPerQuestion);

        // Track answer history
        const answerRecord = {
          questionId: exercise.id,
          questionText: exercise.title,
          userAnswer: `${correctCount}/${totalQuestions} Ä‘Ãºng`,
          correctAnswer: `Xem chi tiáº¿t bÃªn trÃªn`,
          isCorrect: correctCount === totalQuestions,
          exercise: exercise,
          timeSpent: Date.now() - this.questionStartTime,
          points: Math.round(correctCount * pointsPerQuestion)
        };

        this.state.answerHistory.push(answerRecord);

        // Show feedback
        const container = document.getElementById('exercise-container');
        const handler = this.exerciseHandlers[exercise.type];
        if (handler) {
          handler.showFeedback(container, correctCount > 0, exercise);
        }

        // Play sound based on results
        if (correctCount === totalQuestions) {
          Utils.playSound('correct');
        } else if (correctCount > 0) {
          Utils.playSound('correct'); // partial success
        } else {
          Utils.playSound('wrong');
        }

        this.updateUI();
        this.enableNextButton();
      } else {
        // Default handling for other exercise types
        originalHandleAnswer(userAnswer, exercise);
      }
    };

    // Load unit data and start game
    async function loadAndStartGame() {
      try {
        const response = await fetch(DATA_PATH);

        if (!response.ok) {
          throw new Error(`Failed to load data: ${response.status}`);
        }

        const unitData = await response.json();
        GameEngine.init(unitData, UNIT_ID);

      } catch (error) {
        console.error('Error loading game data:', error);
        const container = document.getElementById('exercise-container');
        container.innerHTML = `
          <div class="card error-card">
            <h2>âš ï¸ Lá»—i táº£i dá»¯ liá»‡u</h2>
            <p>KhÃ´ng thá»ƒ táº£i bÃ i táº­p. Vui lÃ²ng thá»­ láº¡i.</p>
            <button class="btn btn--primary" onclick="location.reload()">Táº£i láº¡i</button>
          </div>
        `;
      }
    }

    // Start game when page loads
    loadAndStartGame();
  </script>
</body>
</html>
