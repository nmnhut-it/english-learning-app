<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unit 7: First Aid - Reported Speech | English Grammar Games</title>
  <meta name="description" content="Practice reported speech with said and told, changing tenses and time words">

  <!-- Shared Styles -->
  <link rel="stylesheet" href="../css/shared.css">
</head>
<body>
  <!-- Game Header -->
  <header class="game-header">
    <div class="container">
      <div class="game-header__container">
        <div class="game-header__info-section">
          <h1 class="game-header__title">Unit 7: First Aid</h1>
          <p class="game-header__subtitle">Reported Speech</p>
          <div class="game-info">
            <div class="game-info__item">
              <span class="game-info__label">Gi√°o vi√™n:</span>
              <span class="game-info__value">Nguy·ªÖn Minh Nh·ª±t</span>
            </div>
            <div class="game-info__item">
              <span class="game-info__label">H·ªçc sinh:</span>
              <span class="game-info__value"></span>
            </div>
          </div>
        </div>

        <div class="game-header__stats">
          <div class="stat">
            <span class="stat__label">ƒêi·ªÉm</span>
            <span class="stat__value stat__value--primary" id="current-score">‚≠ê 0</span>
          </div>

          <div class="stat">
            <span class="stat__label">Ti·∫øn ƒë·ªô</span>
            <span class="stat__value" id="progress-count">0 / 0</span>
          </div>

          <div class="stat" id="combo-display" style="display: none;">
            <span class="stat__label">Combo</span>
            <span class="stat__value" id="combo-count">0</span>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress">
        <div class="progress__bar" id="progress-bar" style="width: 0%;"></div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Theory Panel (Collapsible) -->
    <div class="theory-panel" id="theory-panel">
      <button class="theory-panel__toggle" id="theory-toggle">
        <span>üìñ T√†i li·ªáu ng·ªØ ph√°p</span>
        <span class="theory-panel__icon" id="theory-icon">‚ñº</span>
      </button>

      <div class="theory-panel__content" id="theory-content">
        <!-- Ph·∫ßn 1: Gi·ªõi thi·ªáu Reported Speech -->
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">C√¢u t∆∞·ªùng thu·∫≠t l√† g√¨?</h3>
          <p>Khi b·∫°n k·ªÉ l·∫°i l·ªùi ai ƒë√≥ n√≥i, b·∫°n c√≥ 2 c√°ch:</p>
          <p><strong>1. Direct Speech (C√¢u tr·ª±c ti·∫øp):</strong> Tr√≠ch d·∫´n NGUY√äN VƒÇN l·ªùi h·ªç n√≥i, ƒë·∫∑t trong ngo·∫∑c k√©p.</p>
          <p><strong>2. Reported Speech (C√¢u t∆∞·ªùng thu·∫≠t):</strong> K·ªÇ L·∫†I l·ªùi h·ªç n√≥i theo c√°ch c·ªßa m√¨nh, KH√îNG d√πng ngo·∫∑c k√©p.</p>
          <div class="theory-panel__example">
            <strong>T√¨nh hu·ªëng:</strong> B√°c sƒ© kh√°m v√† n√≥i "Tay em b·ªã g√£y r·ªìi."<br><br>
            <strong>Direct:</strong> The doctor said, <span style="color: var(--info);">"It's broken."</span><br>
            <strong>Reported:</strong> The doctor said it <span style="color: var(--primary);">was</span> broken.<br><br>
            <em>Ch√∫ √Ω: "is" ƒë·ªïi th√†nh "was" - ƒë√¢y l√† quy t·∫Øc quan tr·ªçng nh·∫•t!</em>
          </div>
        </div>

        <!-- Ph·∫ßn 2: Quy t·∫Øc l√πi th√¨ -->
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">Quy t·∫Øc "L√πi m·ªôt th√¨" (Backshift)</h3>
          <p>Khi chuy·ªÉn sang c√¢u t∆∞·ªùng thu·∫≠t, ƒë·ªông t·ª´ ph·∫£i <strong>L√ôI 1 TH√å</strong> v·ªÅ qu√° kh·ª©:</p>
          <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
            <tr style="background: var(--info); color: white;">
              <th style="padding: 10px; text-align: center;">C√¢u tr·ª±c ti·∫øp</th>
              <th style="padding: 10px; text-align: center;"></th>
              <th style="padding: 10px; text-align: center;">C√¢u t∆∞·ªùng thu·∫≠t</th>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 10px; text-align: center;"><strong>am / is / are</strong></td>
              <td style="padding: 10px; text-align: center;">‚Üí</td>
              <td style="padding: 10px; text-align: center;"><strong>was / were</strong></td>
            </tr>
            <tr>
              <td style="padding: 10px; text-align: center;"><strong>do / does</strong></td>
              <td style="padding: 10px; text-align: center;">‚Üí</td>
              <td style="padding: 10px; text-align: center;"><strong>did</strong></td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 10px; text-align: center;"><strong>have / has</strong></td>
              <td style="padding: 10px; text-align: center;">‚Üí</td>
              <td style="padding: 10px; text-align: center;"><strong>had</strong></td>
            </tr>
            <tr>
              <td style="padding: 10px; text-align: center;"><strong>can</strong></td>
              <td style="padding: 10px; text-align: center;">‚Üí</td>
              <td style="padding: 10px; text-align: center;"><strong>could</strong></td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 10px; text-align: center;"><strong>will</strong></td>
              <td style="padding: 10px; text-align: center;">‚Üí</td>
              <td style="padding: 10px; text-align: center;"><strong>would</strong></td>
            </tr>
            <tr>
              <td style="padding: 10px; text-align: center;"><strong>have to</strong></td>
              <td style="padding: 10px; text-align: center;">‚Üí</td>
              <td style="padding: 10px; text-align: center;"><strong>had to</strong></td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 10px; text-align: center;"><strong>don't / doesn't</strong></td>
              <td style="padding: 10px; text-align: center;">‚Üí</td>
              <td style="padding: 10px; text-align: center;"><strong>didn't</strong></td>
            </tr>
          </table>
          <div class="theory-panel__example">
            <strong>V√≠ d·ª• th·ª±c t·∫ø:</strong><br>
            "I <span style="color: var(--danger);">am</span> tired." ‚Üí He said he <span style="color: var(--primary);">was</span> tired.<br>
            "I <span style="color: var(--danger);">can</span> help." ‚Üí She said she <span style="color: var(--primary);">could</span> help.<br>
            "We <span style="color: var(--danger);">will</span> come." ‚Üí They said they <span style="color: var(--primary);">would</span> come.
          </div>
        </div>

        <!-- Ph·∫ßn 3: Said vs Told -->
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">Khi n√†o d√πng SAID, khi n√†o d√πng TOLD?</h3>
          <p>ƒê√¢y l√† l·ªói ph·ªï bi·∫øn nh·∫•t! Ghi nh·ªõ:</p>
          <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
            <tr style="background: var(--primary); color: white;">
              <th style="padding: 10px;">SAID</th>
              <th style="padding: 10px;">TOLD</th>
            </tr>
            <tr>
              <td style="padding: 10px; vertical-align: top;">
                <strong>KH√îNG c√≥ ng∆∞·ªùi nghe</strong><br>
                S + <strong>said</strong> + (that) + clause<br><br>
                <em>She <strong>said</strong> she was tired.</em>
              </td>
              <td style="padding: 10px; vertical-align: top;">
                <strong>C√ì ng∆∞·ªùi nghe</strong> (me/you/him/her/us/them)<br>
                S + <strong>told</strong> + object + (that) + clause<br><br>
                <em>She <strong>told me</strong> she was tired.</em>
              </td>
            </tr>
          </table>
          <div class="theory-panel__example" style="background: #ffebee; border-left-color: var(--danger);">
            <strong>L·ªói sai th∆∞·ªùng g·∫∑p:</strong><br>
            ‚ùå He <span style="color: var(--danger); text-decoration: line-through;">said me</span> he was tired. (SAI!)<br>
            ‚ùå She <span style="color: var(--danger); text-decoration: line-through;">told</span> she was happy. (SAI - thi·∫øu ng∆∞·ªùi nghe!)<br>
            ‚ùå He <span style="color: var(--danger); text-decoration: line-through;">told to me</span> he was coming. (SAI - kh√¥ng c√≥ "to"!)<br><br>
            <strong>C√°ch ƒë√∫ng:</strong><br>
            ‚úì He <span style="color: var(--primary);">told me</span> he was tired.<br>
            ‚úì She <span style="color: var(--primary);">said</span> she was happy.<br>
            ‚úì He <span style="color: var(--primary);">told me</span> he was coming.
          </div>
          <p style="margin-top: 10px;"><strong>M·∫πo nh·ªõ:</strong> TOLD = TOLD somebody (lu√¥n c√≥ ai ƒë√≥ ƒë·ª©ng sau)</p>
        </div>

        <!-- Ph·∫ßn 4: ƒê·ªïi ƒë·∫°i t·ª´ -->
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">ƒê·ªïi ƒë·∫°i t·ª´ (Pronoun Changes)</h3>
          <p>Khi k·ªÉ l·∫°i l·ªùi ng∆∞·ªùi kh√°c, ph·∫£i ƒë·ªïi ƒë·∫°i t·ª´ cho ph√π h·ª£p:</p>
          <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
            <tr style="background: var(--bg-light);">
              <th style="padding: 8px;">Tr·ª±c ti·∫øp</th>
              <th style="padding: 8px;">T∆∞·ªùng thu·∫≠t</th>
            </tr>
            <tr>
              <td style="padding: 8px; text-align: center;"><strong>I</strong></td>
              <td style="padding: 8px; text-align: center;"><strong>he / she</strong></td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 8px; text-align: center;"><strong>my</strong></td>
              <td style="padding: 8px; text-align: center;"><strong>his / her</strong></td>
            </tr>
            <tr>
              <td style="padding: 8px; text-align: center;"><strong>we</strong></td>
              <td style="padding: 8px; text-align: center;"><strong>they</strong></td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 8px; text-align: center;"><strong>you</strong> (n√≥i v·ªõi ai)</td>
              <td style="padding: 8px; text-align: center;"><strong>I / me</strong> (ng∆∞·ªùi ƒë∆∞·ª£c n√≥i)</td>
            </tr>
          </table>
          <div class="theory-panel__example">
            <strong>V√≠ d·ª•:</strong><br>
            "<span style="color: var(--danger);">I</span> love <span style="color: var(--danger);">my</span> dog." ‚Üí He said <span style="color: var(--primary);">he</span> loved <span style="color: var(--primary);">his</span> dog.<br>
            "<span style="color: var(--danger);">You</span> have to help <span style="color: var(--danger);">me</span>." (n√≥i v·ªõi t√¥i) ‚Üí He told me <span style="color: var(--primary);">I</span> had to help <span style="color: var(--primary);">him</span>.
          </div>
        </div>

        <!-- Ph·∫ßn 5: ƒê·ªïi t·ª´ ch·ªâ th·ªùi gian -->
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">ƒê·ªïi t·ª´ ch·ªâ th·ªùi gian & n∆°i ch·ªën</h3>
          <p>V√¨ c√¢u ƒë∆∞·ª£c k·ªÉ l·∫°i ·ªü th·ªùi ƒëi·ªÉm kh√°c, n√™n c√°c t·ª´ ch·ªâ th·ªùi gian c≈©ng ph·∫£i thay ƒë·ªïi:</p>
          <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
            <tr style="background: var(--info); color: white;">
              <th style="padding: 10px;">Tr·ª±c ti·∫øp</th>
              <th style="padding: 10px;"></th>
              <th style="padding: 10px;">T∆∞·ªùng thu·∫≠t</th>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 8px; text-align: center;"><strong>today</strong></td>
              <td style="padding: 8px; text-align: center;">‚Üí</td>
              <td style="padding: 8px; text-align: center;"><strong>that day</strong></td>
            </tr>
            <tr>
              <td style="padding: 8px; text-align: center;"><strong>tonight</strong></td>
              <td style="padding: 8px; text-align: center;">‚Üí</td>
              <td style="padding: 8px; text-align: center;"><strong>that night</strong></td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 8px; text-align: center;"><strong>tomorrow</strong></td>
              <td style="padding: 8px; text-align: center;">‚Üí</td>
              <td style="padding: 8px; text-align: center;"><strong>the next day / the following day</strong></td>
            </tr>
            <tr>
              <td style="padding: 8px; text-align: center;"><strong>yesterday</strong></td>
              <td style="padding: 8px; text-align: center;">‚Üí</td>
              <td style="padding: 8px; text-align: center;"><strong>the day before / the previous day</strong></td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 8px; text-align: center;"><strong>now</strong></td>
              <td style="padding: 8px; text-align: center;">‚Üí</td>
              <td style="padding: 8px; text-align: center;"><strong>then</strong></td>
            </tr>
            <tr>
              <td style="padding: 8px; text-align: center;"><strong>here</strong></td>
              <td style="padding: 8px; text-align: center;">‚Üí</td>
              <td style="padding: 8px; text-align: center;"><strong>there</strong></td>
            </tr>
            <tr style="background: var(--bg-light);">
              <td style="padding: 8px; text-align: center;"><strong>this</strong></td>
              <td style="padding: 8px; text-align: center;">‚Üí</td>
              <td style="padding: 8px; text-align: center;"><strong>that</strong></td>
            </tr>
            <tr>
              <td style="padding: 8px; text-align: center;"><strong>next week</strong></td>
              <td style="padding: 8px; text-align: center;">‚Üí</td>
              <td style="padding: 8px; text-align: center;"><strong>the following week / the next week</strong></td>
            </tr>
          </table>
          <div class="theory-panel__example">
            <strong>V√≠ d·ª•:</strong><br>
            "I'm working <span style="color: var(--danger);">now</span>." ‚Üí She said she was working <span style="color: var(--primary);">then</span>.<br>
            "I'll come <span style="color: var(--danger);">tomorrow</span>." ‚Üí He said he would come <span style="color: var(--primary);">the next day</span>.
          </div>
        </div>

        <!-- Ph·∫ßn 6: T·ªïng k·∫øt v·ªõi v√≠ d·ª• ho√†n ch·ªânh -->
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">T·ªïng k·∫øt: 3 b∆∞·ªõc chuy·ªÉn c√¢u t∆∞·ªùng thu·∫≠t</h3>
          <p>Khi chuy·ªÉn t·ª´ c√¢u tr·ª±c ti·∫øp sang c√¢u t∆∞·ªùng thu·∫≠t, l√†m theo 3 b∆∞·ªõc:</p>
          <ol>
            <li><strong>B∆∞·ªõc 1:</strong> Ch·ªçn <strong>said</strong> ho·∫∑c <strong>told</strong> (c√≥ ng∆∞·ªùi nghe ‚Üí told)</li>
            <li><strong>B∆∞·ªõc 2:</strong> <strong>L√πi th√¨</strong> ƒë·ªông t·ª´ (is‚Üíwas, can‚Üícould, will‚Üíwould...)</li>
            <li><strong>B∆∞·ªõc 3:</strong> <strong>ƒê·ªïi ƒë·∫°i t·ª´</strong> v√† <strong>t·ª´ ch·ªâ th·ªùi gian</strong></li>
          </ol>
          <div class="theory-panel__example" style="background: #e8f5e9; border-left-color: var(--primary);">
            <strong>V√≠ d·ª• ho√†n ch·ªânh:</strong><br><br>
            <strong>Direct:</strong> Tom says to me: "I <span style="color: var(--danger);">can't</span> find <span style="color: var(--danger);">my</span> book <span style="color: var(--danger);">here</span>."<br><br>
            <strong>Ph√¢n t√≠ch:</strong><br>
            - C√≥ "to me" ‚Üí d√πng <strong>told me</strong><br>
            - can't ‚Üí <strong>couldn't</strong><br>
            - I ‚Üí <strong>he</strong>, my ‚Üí <strong>his</strong><br>
            - here ‚Üí <strong>there</strong><br><br>
            <strong>Reported:</strong> Tom <span style="color: var(--primary);">told me</span> <span style="color: var(--primary);">he</span> <span style="color: var(--primary);">couldn't</span> find <span style="color: var(--primary);">his</span> book <span style="color: var(--primary);">there</span>.
          </div>
        </div>
      </div>
    </div>
    <!-- Exercise Container -->
    <div id="exercise-container">
      <!-- Exercises will be rendered here dynamically -->
      <div class="card text-center">
        <h2>Loading...</h2>
        <p>Please wait while we load the exercises.</p>
      </div>
    </div>
  </main>

  <!-- Core JavaScript (loaded first) -->
  <script src="../js/core/utils.js"></script>
  <script src="../js/core/storage.js"></script>
  <script src="../js/core/telegram-sender.js"></script>
  <script src="../js/core/game-engine.js"></script>

  <!-- Exercise Type Handlers (mobile-friendly types only) -->
  <script src="../js/exercises/multiple-choice.js"></script>
  <script src="../js/exercises/word-rearrange.js"></script>

  <!-- Initialize Game -->
  <script>
    const UNIT_ID = 'unit-7-first-aid';
    const DATA_PATH = '../data/unit-7-first-aid.json';

    // Theory panel toggle
    const theoryToggle = document.getElementById('theory-toggle');
    const theoryContent = document.getElementById('theory-content');
    const theoryIcon = document.getElementById('theory-icon');

    theoryToggle.addEventListener('click', () => {
      const isExpanded = theoryContent.classList.contains('theory-panel__content--expanded');

      if (isExpanded) {
        theoryContent.classList.remove('theory-panel__content--expanded');
        theoryIcon.classList.remove('theory-panel__icon--rotated');
      } else {
        theoryContent.classList.add('theory-panel__content--expanded');
        theoryIcon.classList.add('theory-panel__icon--rotated');
      }
    });

    // Combo display logic
    function updateComboDisplay() {
      const comboDisplay = document.getElementById('combo-display');
      const comboCount = document.getElementById('combo-count');
      const state = GameEngine.getState();

      if (state.comboCount >= 3) {
        comboDisplay.style.display = 'flex';
        comboCount.textContent = state.comboCount + 'x üî•';
      } else {
        comboDisplay.style.display = 'none';
      }
    }

    // Override GameEngine.updateUI to include combo display
    const originalUpdateUI = GameEngine.updateUI.bind(GameEngine);
    GameEngine.updateUI = function() {
      originalUpdateUI();
      updateComboDisplay();
    };

    // Load unit data and start game
    async function loadAndStartGame() {
      try {
        const response = await fetch(DATA_PATH);

        if (!response.ok) {
          throw new Error(`Failed to load data: ${response.status}`);
        }

        const unitData = await response.json();

        console.log('Unit data loaded:', unitData);
        console.log('Registered exercise handlers:', Object.keys(GameEngine.exerciseHandlers));

        GameEngine.init(unitData, UNIT_ID);

      } catch (error) {
        console.error('Error loading game data:', error);

        const container = document.getElementById('exercise-container');
        container.innerHTML = `
          <div class="card">
            <h2 style="color: var(--danger);">Error Loading Game</h2>
            <p>Sorry, we couldn't load the exercise data. Please try refreshing the page.</p>
            <p style="font-size: var(--font-size-sm); color: var(--text-light);">Error: ${error.message}</p>
            <button class="btn btn--primary mt-2" onclick="location.reload()">Reload Page</button>
          </div>
        `;
      }
    }

    // Start game when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAndStartGame);
    } else {
      loadAndStartGame();
    }
  </script>
</body>
</html>
