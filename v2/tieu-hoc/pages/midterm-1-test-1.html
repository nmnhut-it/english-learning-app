<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Äá» thi giá»¯a kÃ¬ 1 Tiáº¿ng Anh 11 - Äá» sá»‘ 1 | English Grammar Games</title>
  <meta name="description" content="Practice midterm exam for English 11 - Global Success">

  <!-- Shared Styles -->
  <link rel="stylesheet" href="../css/shared.css">
</head>
<body>
  <!-- Game Header -->
  <header class="game-header">
    <div class="container">
      <div class="game-header__container">
        <div class="game-header__info-section">
          <h1 class="game-header__title">Äá» thi giá»¯a kÃ¬ 1 Tiáº¿ng Anh 11 - Äá» sá»‘ 1</h1>
          <p class="game-header__subtitle">Global Success - Comprehensive Test</p>
          <div class="game-info">
            <div class="game-info__item">
              <span class="game-info__label">GiÃ¡o viÃªn:</span>
              <span class="game-info__value">Nguyá»…n Minh Nhá»±t</span>
            </div>
            <div class="game-info__item">
              <span class="game-info__label">Há»c sinh:</span>
              <span class="game-info__value">Lá»›p 11</span>
            </div>
          </div>
        </div>

        <div class="game-header__stats">
          <div class="stat">
            <span class="stat__label">Äiá»ƒm</span>
            <span class="stat__value stat__value--primary" id="current-score">â­ 0</span>
          </div>

          <div class="stat">
            <span class="stat__label">Tiáº¿n Ä‘á»™</span>
            <span class="stat__value" id="progress-count">0 / 0</span>
          </div>

          <div class="stat" id="combo-display" style="display: none;">
            <span class="stat__label">Combo</span>
            <span class="stat__value" id="combo-count">0</span>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress">
        <div class="progress__bar" id="progress-bar" style="width: 0%;"></div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Theory Panel (Collapsible) -->
    <div class="theory-panel" id="theory-panel">
      <button class="theory-panel__toggle" id="theory-toggle">
        <span>ğŸ“– HÆ°á»›ng dáº«n lÃ m bÃ i</span>
        <span class="theory-panel__icon" id="theory-icon">â–¼</span>
      </button>

      <div class="theory-panel__content" id="theory-content">
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">Cáº¥u trÃºc Ä‘á» thi</h3>
          <p>Äá» thi kiá»ƒm tra toÃ n diá»‡n cÃ¡c ká»¹ nÄƒng:</p>
          <ul>
            <li><strong>Phonetics:</strong> PhÃ¡t Ã¢m vÃ  trá»ng Ã¢m</li>
            <li><strong>Grammar:</strong> ThÃ¬ hiá»‡n táº¡i hoÃ n thÃ nh, hiá»‡n táº¡i tiáº¿p diá»…n</li>
            <li><strong>Vocabulary:</strong> Tá»« Ä‘á»“ng nghÄ©a, trÃ¡i nghÄ©a, tá»« loáº¡i</li>
            <li><strong>Reading:</strong> Äá»c hiá»ƒu Ä‘oáº¡n vÄƒn</li>
            <li><strong>Writing:</strong> Chuyá»ƒn Ä‘á»•i cÃ¢u Ä‘á»“ng nghÄ©a</li>
          </ul>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">Ngá»¯ phÃ¡p trá»ng tÃ¢m</h3>

          <p><strong>1. Present Perfect (Hiá»‡n táº¡i hoÃ n thÃ nh):</strong></p>
          <div class="theory-panel__example">
            S + have/has + V3/V-ed
          </div>
          <p>Dáº¥u hiá»‡u: recently, just, already, yet, ever, never, since, for</p>
          <ul>
            <li>The government <strong>has proposed</strong> changes recently.</li>
            <li>She <strong>has taken care of</strong> me since I was a child.</li>
          </ul>

          <p><strong>2. Present Continuous (Hiá»‡n táº¡i tiáº¿p diá»…n):</strong></p>
          <div class="theory-panel__example">
            S + am/is/are + V-ing
          </div>
          <p>Dáº¥u hiá»‡u: now, at the moment, currently</p>
          <ul>
            <li>He <strong>is tasting</strong> something in the kitchen now.</li>
          </ul>

          <p><strong>3. Linking Verbs (Äá»™ng tá»« ná»‘i):</strong></p>
          <p>KhÃ´ng chia á»Ÿ thÃ¬ tiáº¿p diá»…n: be, seem, appear, look, taste (khi chá»‰ tÃ­nh cháº¥t)</p>
          <ul>
            <li>The proposal <strong>seems</strong> good. (NOT is seeming)</li>
          </ul>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">Máº¹o lÃ m bÃ i</h3>
          <ul>
            <li><strong>Phonetics:</strong> ChÃº Ã½ Ã¢m cuá»‘i vÃ  vá»‹ trÃ­ trá»ng Ã¢m</li>
            <li><strong>Grammar:</strong> TÃ¬m dáº¥u hiá»‡u thá»i gian (time markers)</li>
            <li><strong>Vocabulary:</strong> XÃ¡c Ä‘á»‹nh tá»« loáº¡i cáº§n Ä‘iá»n (noun, adj, adv, verb)</li>
            <li><strong>Reading:</strong> Äá»c cÃ¢u há»i trÆ°á»›c, sau Ä‘Ã³ tÃ¬m thÃ´ng tin trong Ä‘oáº¡n vÄƒn</li>
            <li><strong>Writing:</strong> Giá»¯ nguyÃªn Ã½ nghÄ©a cÃ¢u gá»‘c</li>
          </ul>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">Cáº¥u trÃºc chuyá»ƒn Ä‘á»•i cÃ¢u quan trá»ng</h3>
          <ul>
            <li><strong>never + such:</strong> This is the most beautiful â†’ I have never visited such a beautiful city</li>
            <li><strong>ago â†’ for:</strong> began...ago â†’ has V-ed for...</li>
            <li><strong>advice â†’ should:</strong> My advice is â†’ You should...</li>
            <li><strong>allow to V â†’ let V:</strong> allow me to stay â†’ let me stay</li>
            <li><strong>so...that â†’ such...that:</strong> so expensive that â†’ such an expensive car that</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Exercise Container -->
    <div id="exercise-container">
      <!-- Exercises will be rendered here dynamically -->
      <div class="card text-center">
        <h2>Loading...</h2>
        <p>Please wait while we load the exercises.</p>
      </div>
    </div>
  </main>

  <!-- Core JavaScript (loaded first) -->
  <script src="../js/core/utils.js"></script>
  <script src="../js/core/storage.js"></script>
  <script src="../js/core/telegram-sender.js"></script>
  <script src="../js/core/game-engine.js"></script>

  <!-- Exercise Type Handlers -->
  <script src="../js/exercises/multiple-choice.js"></script>
  <script src="../js/exercises/fill-blank.js"></script>
  <script src="../js/exercises/sentence-rewrite.js"></script>

  <!-- Initialize Game -->
  <script>
    const UNIT_ID = 'midterm-1-test-1';
    const DATA_PATH = '../data/midterm-1-test-1.json';

    // Theory panel toggle
    const theoryToggle = document.getElementById('theory-toggle');
    const theoryContent = document.getElementById('theory-content');
    const theoryIcon = document.getElementById('theory-icon');

    theoryToggle.addEventListener('click', () => {
      const isExpanded = theoryContent.classList.contains('theory-panel__content--expanded');

      if (isExpanded) {
        theoryContent.classList.remove('theory-panel__content--expanded');
        theoryIcon.classList.remove('theory-panel__icon--rotated');
      } else {
        theoryContent.classList.add('theory-panel__content--expanded');
        theoryIcon.classList.add('theory-panel__icon--rotated');
      }
    });

    // Combo display logic
    function updateComboDisplay() {
      const comboDisplay = document.getElementById('combo-display');
      const comboCount = document.getElementById('combo-count');
      const state = GameEngine.getState();

      if (state.comboCount >= 3) {
        comboDisplay.style.display = 'flex';
        comboCount.textContent = state.comboCount + 'x ğŸ”¥';
      } else {
        comboDisplay.style.display = 'none';
      }
    }

    // Override GameEngine.updateUI to include combo display
    const originalUpdateUI = GameEngine.updateUI.bind(GameEngine);
    GameEngine.updateUI = function() {
      originalUpdateUI();
      updateComboDisplay();
    };

    // Load unit data and start game
    async function loadAndStartGame() {
      try {
        const response = await fetch(DATA_PATH);

        if (!response.ok) {
          throw new Error(`Failed to load data: ${response.status}`);
        }

        const unitData = await response.json();

        console.log('Unit data loaded:', unitData);
        console.log('Registered exercise handlers:', Object.keys(GameEngine.exerciseHandlers));

        GameEngine.init(unitData, UNIT_ID);

      } catch (error) {
        console.error('Error loading game data:', error);

        const container = document.getElementById('exercise-container');
        container.innerHTML = `
          <div class="card">
            <h2 style="color: var(--danger);">Error Loading Game</h2>
            <p>Sorry, we couldn't load the exercise data. Please try refreshing the page.</p>
            <p style="font-size: var(--font-size-sm); color: var(--text-light);">Error: ${error.message}</p>
            <button class="btn btn--primary mt-2" onclick="location.reload()">Reload Page</button>
          </div>
        `;
      }
    }

    // Start game when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAndStartGame);
    } else {
      loadAndStartGame();
    }
  </script>
</body>
</html>
