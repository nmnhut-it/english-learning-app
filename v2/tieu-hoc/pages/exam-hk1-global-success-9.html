<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê·ªÅ thi cu·ªëi HK1 - Ti·∫øng Anh 9 Global Success | English Grammar Games</title>
  <meta name="description" content="√în t·∫≠p ƒë·ªÅ thi cu·ªëi h·ªçc k√¨ 1 Ti·∫øng Anh 9 - Global Success v·ªõi gi·∫£i th√≠ch chi ti·∫øt">

  <!-- Shared Styles -->
  <link rel="stylesheet" href="../css/shared.css">
</head>
<body>
  <!-- Game Header -->
  <header class="game-header">
    <div class="container">
      <div class="game-header__container">
        <div class="game-header__info-section">
          <h1 class="game-header__title">ƒê·ªÅ thi cu·ªëi H·ªçc k√¨ 1 - Ti·∫øng Anh 9</h1>
          <p class="game-header__subtitle">Global Success - Comprehensive Test</p>
          <div class="game-info">
            <div class="game-info__item">
              <span class="game-info__label">Gi√°o vi√™n:</span>
              <span class="game-info__value">Nguy·ªÖn Minh Nh·ª±t</span>
            </div>
            <div class="game-info__item">
              <span class="game-info__label">H·ªçc sinh:</span>
              <span class="game-info__value">L·ªõp 9</span>
            </div>
          </div>
        </div>

        <div class="game-header__stats">
          <div class="stat">
            <span class="stat__label">ƒêi·ªÉm</span>
            <span class="stat__value stat__value--primary" id="current-score">0</span>
          </div>

          <div class="stat">
            <span class="stat__label">Ti·∫øn ƒë·ªô</span>
            <span class="stat__value" id="progress-count">0 / 0</span>
          </div>

          <div class="stat" id="combo-display" style="display: none;">
            <span class="stat__label">Combo</span>
            <span class="stat__value" id="combo-count">0</span>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress">
        <div class="progress__bar" id="progress-bar" style="width: 0%;"></div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <!-- Theory Panel (Collapsible) -->
    <div class="theory-panel" id="theory-panel">
      <button class="theory-panel__toggle" id="theory-toggle">
        <span>üìñ Ki·∫øn th·ª©c tr·ªçng t√¢m</span>
        <span class="theory-panel__icon" id="theory-icon">‚ñº</span>
      </button>

      <div class="theory-panel__content" id="theory-content">
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">C·∫•u tr√∫c ƒë·ªÅ thi HK1 l·ªõp 9</h3>
          <ul>
            <li><strong>Phonetics:</strong> Tr·ªçng √¢m t·ª´ 2-3 √¢m ti·∫øt</li>
            <li><strong>Vocabulary:</strong> T·ª´ ƒë·ªìng nghƒ©a, tr√°i nghƒ©a</li>
            <li><strong>Grammar:</strong> Present Perfect, Wish clauses, Conditionals</li>
            <li><strong>Reading:</strong> ƒê·ªçc hi·ªÉu ƒëo·∫°n vƒÉn, ƒëi·ªÅn t·ª´</li>
            <li><strong>Error Correction:</strong> T√¨m l·ªói sai trong c√¢u</li>
            <li><strong>Writing:</strong> Vi·∫øt l·∫°i c√¢u ƒë·ªìng nghƒ©a</li>
          </ul>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">1. Present Perfect (Hi·ªán t·∫°i ho√†n th√†nh)</h3>
          <div class="theory-panel__example">
            S + have/has + V3/V-ed (+ since/for/yet/already/ever/never)
          </div>
          <ul>
            <li><strong>Since + m·ªëc th·ªùi gian:</strong> since 2022, since I was a child</li>
            <li><strong>For + kho·∫£ng th·ªùi gian:</strong> for 3 years, for a long time</li>
            <li><strong>Yet:</strong> d√πng trong c√¢u h·ªèi v√† ph·ªß ƒë·ªãnh (cu·ªëi c√¢u)</li>
            <li><strong>Already:</strong> d√πng trong c√¢u kh·∫≥ng ƒë·ªãnh</li>
          </ul>
          <p>V√≠ d·ª•: <em>I <strong>have studied</strong> English <strong>since</strong> 2022.</em></p>
          <p>V√≠ d·ª•: <em><strong>Have</strong> you <strong>written</strong> to your pen pal <strong>yet</strong>?</em></p>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">2. C√¢u ∆∞·ªõc (Wish clauses)</h3>
          <div class="theory-panel__example">
            S + wish(es) + S + V2/Ved (qu√° kh·ª© ƒë∆°n) - ∆∞·ªõc mu·ªën ·ªü hi·ªán t·∫°i
          </div>
          <ul>
            <li><strong>Wish + could:</strong> ∆∞·ªõc c√≥ kh·∫£ nƒÉng l√†m g√¨</li>
            <li><strong>Wish + were:</strong> ∆∞·ªõc l√† ai/c√°i g√¨ (d√πng "were" cho t·∫•t c·∫£ ng√¥i)</li>
            <li><strong>Wish + V2:</strong> ∆∞·ªõc ƒëi·ªÅu g√¨ ƒë√≥ kh√°c ƒëi</li>
          </ul>
          <p>V√≠ d·ª•: <em>I <strong>wish</strong> I <strong>could</strong> visit Big Ben.</em></p>
          <p>V√≠ d·ª•: <em>She <strong>wishes</strong> she <strong>had</strong> an iPhone.</em></p>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">3. Unless = If...not</h3>
          <div class="theory-panel__example">
            Unless + S + V (kh·∫≥ng ƒë·ªãnh) = If + S + don't/doesn't + V
          </div>
          <p>V√≠ d·ª•: <em><strong>Unless</strong> you study harder, you will fail.</em></p>
          <p>= <em><strong>If</strong> you <strong>don't</strong> study harder, you will fail.</em></p>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">4. So s√°nh k√©p (Double comparatives)</h3>
          <div class="theory-panel__example">
            The + comparative, the + comparative
          </div>
          <p>V√≠ d·ª•: <em><strong>The more modern</strong> the library is, <strong>the more attractive</strong> it is.</em></p>
          <p>V√≠ d·ª•: <em><strong>The older</strong> he gets, <strong>the more experienced</strong> he becomes.</em></p>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">5. C√°c c·∫•u tr√∫c V + V-ing / to V</h3>
          <ul>
            <li><strong>V + V-ing:</strong> avoid, mind, enjoy, finish, suggest, practice</li>
            <li><strong>V + to V:</strong> decide, want, promise, hope, expect, plan</li>
            <li><strong>let + O + V:</strong> let me go (kh√¥ng c√≥ "to")</li>
            <li><strong>used to + V:</strong> th√≥i quen trong qu√° kh·ª©</li>
          </ul>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">6. T√≠nh t·ª´ -ed vs -ing</h3>
          <ul>
            <li><strong>-ed:</strong> m√¥ t·∫£ c·∫£m x√∫c c·ªßa NG∆Ø·ªúI (bored, tired, excited, embarrassed)</li>
            <li><strong>-ing:</strong> m√¥ t·∫£ ƒë·∫∑c ƒëi·ªÉm c·ªßa V·∫¨T/VI·ªÜC (boring, tiring, exciting)</li>
          </ul>
          <p>V√≠ d·ª•: <em>The movie is <strong>boring</strong>. I feel <strong>bored</strong>.</em></p>
        </div>

        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">7. T·ª´ v·ª±ng quan tr·ªçng</h3>
          <ul>
            <li><strong>went blank:</strong> ƒë·∫ßu √≥c tr·ªëng r·ªóng</li>
            <li><strong>stressed out:</strong> cƒÉng th·∫≥ng</li>
            <li><strong>by rote:</strong> h·ªçc v·∫πt (>< by understanding)</li>
            <li><strong>deep-rooted:</strong> b·ªÅn v·ªØng, ƒÉn s√¢u</li>
            <li><strong>cut down on:</strong> gi·∫£m b·ªõt</li>
            <li><strong>figure out:</strong> t√¨m ra, hi·ªÉu ra</li>
            <li><strong>World Heritage Site:</strong> Di s·∫£n Th·∫ø gi·ªõi</li>
            <li><strong>eco-tour:</strong> du l·ªãch sinh th√°i</li>
            <li><strong>artisan:</strong> ngh·ªá nh√¢n</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Exercise Container -->
    <div id="exercise-container">
      <!-- Exercises will be rendered here dynamically -->
      <div class="card text-center">
        <h2>ƒêang t·∫£i...</h2>
        <p>Vui l√≤ng ch·ªù trong gi√¢y l√°t.</p>
      </div>
    </div>
  </main>

  <!-- Core JavaScript (loaded first) -->
  <script src="../js/core/utils.js"></script>
  <script src="../js/core/storage.js"></script>
  <script src="../js/core/telegram-sender.js"></script>
  <script src="../js/core/game-engine.js"></script>

  <!-- Exercise Type Handlers -->
  <script src="../js/exercises/multiple-choice.js"></script>
  <script src="../js/exercises/fill-blank.js"></script>
  <script src="../js/exercises/sentence-rewrite.js"></script>
  <script src="../js/exercises/sequence-order.js"></script>

  <!-- Initialize Game -->
  <script>
    const UNIT_ID = 'exam-hk1-global-success-9';
    const DATA_PATH = '../data/exam-hk1-global-success-9.json';

    // Theory panel toggle
    const theoryToggle = document.getElementById('theory-toggle');
    const theoryContent = document.getElementById('theory-content');
    const theoryIcon = document.getElementById('theory-icon');

    theoryToggle.addEventListener('click', () => {
      const isExpanded = theoryContent.classList.contains('theory-panel__content--expanded');

      if (isExpanded) {
        theoryContent.classList.remove('theory-panel__content--expanded');
        theoryIcon.classList.remove('theory-panel__icon--rotated');
      } else {
        theoryContent.classList.add('theory-panel__content--expanded');
        theoryIcon.classList.add('theory-panel__icon--rotated');
      }
    });

    // Combo display logic
    function updateComboDisplay() {
      const comboDisplay = document.getElementById('combo-display');
      const comboCount = document.getElementById('combo-count');
      const state = GameEngine.getState();

      if (state.comboCount >= 3) {
        comboDisplay.style.display = 'flex';
        comboCount.textContent = state.comboCount + 'x';
      } else {
        comboDisplay.style.display = 'none';
      }
    }

    // Override GameEngine.updateUI to include combo display
    const originalUpdateUI = GameEngine.updateUI.bind(GameEngine);
    GameEngine.updateUI = function() {
      originalUpdateUI();
      updateComboDisplay();
    };

    // Load unit data and start game
    async function loadAndStartGame() {
      try {
        const response = await fetch(DATA_PATH);

        if (!response.ok) {
          throw new Error(`Failed to load data: ${response.status}`);
        }

        const unitData = await response.json();

        console.log('Unit data loaded:', unitData);
        console.log('Registered exercise handlers:', Object.keys(GameEngine.exerciseHandlers));

        GameEngine.init(unitData, UNIT_ID);

        // Render question navigator grouped by ƒê·ªÅ
        const mainContainer = document.querySelector('main.container');
        if (mainContainer) {
          GameEngine.renderQuestionNavigator(mainContainer);
          GameEngine.updateQuestionNavigator();
        }

      } catch (error) {
        console.error('Error loading game data:', error);

        const container = document.getElementById('exercise-container');
        container.innerHTML = `
          <div class="card">
            <h2 style="color: var(--danger);">L·ªói t·∫£i d·ªØ li·ªáu</h2>
            <p>Xin l·ªói, kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i t·∫≠p. Vui l√≤ng t·∫£i l·∫°i trang.</p>
            <p style="font-size: var(--font-size-sm); color: var(--text-light);">L·ªói: ${error.message}</p>
            <button class="btn btn--primary mt-2" onclick="location.reload()">T·∫£i l·∫°i trang</button>
          </div>
        `;
      }
    }

    // Start game when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAndStartGame);
    } else {
      loadAndStartGame();
    }
  </script>
</body>
</html>
