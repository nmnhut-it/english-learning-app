<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Voice Lecture</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--primary:#2563eb;--success:#10b981;--warning:#f59e0b;--bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--radius:10px;--safe-bottom:env(safe-area-inset-bottom,0)}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;font-size:16px}

    /* Header */
    header{background:var(--primary);color:#fff;padding:10px 16px;padding-top:calc(10px + env(safe-area-inset-top,0));position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;gap:12px}
    header h1{font-size:.9rem;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #progress{height:3px;background:rgba(255,255,255,.3);position:absolute;bottom:0;left:0;right:0}
    #progress-fill{height:100%;background:#fff;width:0%;transition:width .2s}
    .menu-btn{background:none;border:none;color:#fff;font-size:1.2rem;padding:8px;cursor:pointer;border-radius:6px}
    .menu-btn:hover{background:rgba(255,255,255,.15)}

    /* Content */
    #content{padding:60px 16px 100px;max-width:640px;margin:0 auto}

    /* Chunks */
    .chunk{padding:16px 0;border-bottom:1px dashed var(--border)}
    .chunk:last-child{border-bottom:none}
    .chunk-title{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}

    /* Typography */
    h1{font-size:1.2rem;margin:12px 0 8px}
    h2{font-size:1.05rem;margin:16px 0 8px;color:var(--primary)}
    h3{font-size:.95rem;margin:12px 0 6px;font-weight:600}
    p{margin:6px 0}
    strong{color:#1e40af}
    em{color:var(--muted)}

    /* Teacher Script - Inline */
    .ts{display:flex;align-items:flex-start;gap:8px;padding:10px;margin:8px 0;background:linear-gradient(135deg,#eef2ff,#e0e7ff);border-radius:8px;border-left:3px solid var(--primary);cursor:pointer}
    .ts:hover{background:#dbeafe}
    .ts.speaking{background:#dbeafe;border-left-color:#1d4ed8}
    .ts.speaking .ts-play{background:var(--primary);color:#fff}
    .ts-icon{font-size:1rem}
    .ts-text{flex:1;font-size:.9rem;color:#1e40af;line-height:1.5}
    .ts-play{font-size:.7rem;padding:2px 6px;background:rgba(255,255,255,.6);border-radius:4px;color:var(--muted)}

    /* Timer */
    .timer{background:#1e293b;color:#fff;padding:12px;border-radius:8px;margin:8px 0;text-align:center;display:none}
    .timer.active{display:block}
    .timer-time{font-size:2rem;font-weight:700}
    .timer-time.warning{color:#fbbf24}
    .timer-time.danger{color:#f87171;animation:pulse 1s infinite}
    @keyframes pulse{50%{opacity:.6}}
    .timer-skip{background:rgba(255,255,255,.15);border:none;color:#fff;padding:8px 16px;border-radius:20px;margin-top:8px;cursor:pointer}

    /* Cards */
    .card{background:var(--card);border-radius:var(--radius);padding:12px;margin:10px 0;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .task-box{background:#eff6ff;border-left:3px solid var(--primary)}
    .answer-box{background:#f0fdf4;border-left:3px solid var(--success)}
    .explanation-box{background:#fefce8;border-left:3px solid var(--warning)}
    .grammar-box{background:#faf5ff;border-left:3px solid #8b5cf6}
    .translation-box{background:#ecfeff;border-left:3px solid #06b6d4}
    .dialogue-box{background:#f0fdf4;border-left:3px solid var(--success)}

    /* Vocabulary */
    .vocab-item{padding:10px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;flex-wrap:wrap;gap:6px;align-items:baseline}
    .vocab-item:hover{background:#f1f5f9}
    .vocab-item:last-child{border-bottom:none}
    .vocab-word{font-weight:600;color:var(--primary)}
    .vocab-type{font-size:.7rem;background:#f1f5f9;padding:1px 5px;border-radius:3px;color:var(--muted)}
    .vocab-meaning{flex:1 1 100%;font-size:.9rem;margin-top:2px}
    .vocab-pron{font-size:.8rem;color:#92400e;background:#fef3c7;padding:2px 6px;border-radius:4px}
    @media(min-width:400px){.vocab-meaning{flex:1;margin-top:0}}

    /* Tables */
    .table-wrap{overflow-x:auto;margin:8px 0;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:collapse;font-size:.85rem}
    th,td{padding:8px;border:1px solid var(--border);text-align:left}
    th{background:#f8fafc;font-weight:600;font-size:.8rem}

    /* Lists */
    ul{margin:6px 0;padding-left:18px}
    li{margin:3px 0}

    /* Action buttons */
    .action-row{display:flex;gap:8px;margin:10px 0}
    .action-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;border:2px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;min-height:48px}
    .action-btn:hover{border-color:var(--primary);background:#eff6ff}
    .action-btn.recording{border-color:#ef4444;background:#fef2f2;animation:pulse 1s infinite}
    .action-btn svg{width:20px;height:20px}

    /* Outline panel */
    #outline{position:fixed;top:0;right:-280px;width:280px;height:100%;background:var(--card);box-shadow:-2px 0 10px rgba(0,0,0,.1);z-index:200;transition:right .3s;overflow-y:auto;padding:60px 16px 20px}
    #outline.open{right:0}
    #outline-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:199;display:none}
    #outline-backdrop.open{display:block}
    .outline-item{padding:10px 12px;border-radius:6px;cursor:pointer;font-size:.85rem;margin:2px 0;color:var(--muted)}
    .outline-item:hover{background:#f1f5f9}
    .outline-item.active{background:#dbeafe;color:var(--primary);font-weight:500}

    /* Audio */
    .audio-box{background:#1e293b;padding:12px;border-radius:8px;margin:8px 0}
    .audio-box audio{width:100%}
    .audio-placeholder{background:#374151;color:#9ca3af;padding:16px;border-radius:6px;text-align:center}

    /* Camera gate */
    #gate{position:fixed;inset:0;background:linear-gradient(135deg,#1e3a8a,#3b82f6);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;padding:20px}
    #gate.hidden{display:none}
    #gate h1{color:#fff;margin-bottom:8px}
    #gate p{color:rgba(255,255,255,.85);margin-bottom:16px;text-align:center}
    #gate video,#gate img{width:100%;max-width:240px;aspect-ratio:4/3;object-fit:cover;border-radius:10px;background:#000}
    .gate-input{width:100%;max-width:240px;padding:12px;border:2px solid rgba(255,255,255,.3);border-radius:8px;background:rgba(255,255,255,.1);color:#fff;font-size:1rem;margin:12px 0;text-align:center}
    .gate-input::placeholder{color:rgba(255,255,255,.6)}
    .gate-btn{background:#fff;color:var(--primary);border:none;padding:12px 24px;border-radius:50px;font-size:1rem;font-weight:600;cursor:pointer;margin:4px}
    .gate-btn.secondary{background:transparent;color:#fff;border:2px solid rgba(255,255,255,.4)}

    /* Sending */
    .sending{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.85);color:#fff;padding:16px 28px;border-radius:10px;z-index:1001;display:none}
    .sending.active{display:flex;align-items:center;gap:10px}
    .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="gate">
    <h1>ƒêi·ªÉm danh</h1>
    <p>Nh·∫≠p t√™n v√† ch·ª•p ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
    <input type="text" id="student-name" class="gate-input" placeholder="T√™n c·ªßa b·∫°n...">
    <video id="cam-video" autoplay playsinline muted></video>
    <div style="margin-top:12px">
      <button class="gate-btn" id="capture-btn" disabled>Ch·ª•p ·∫£nh</button>
      <button class="gate-btn secondary" id="skip-btn">B·ªè qua</button>
    </div>
  </div>

  <header>
    <h1 id="title">Voice Lecture</h1>
    <button class="menu-btn" onclick="toggleOutline()">‚ò∞</button>
    <div id="progress"><div id="progress-fill"></div></div>
  </header>

  <div id="outline-backdrop" onclick="toggleOutline()"></div>
  <div id="outline"></div>

  <div id="content"></div>

  <div class="sending" id="sending"><div class="spinner"></div> ƒêang g·ª≠i...</div>
  <canvas id="canvas" style="display:none"></canvas>

<script>
const CONFIG={contentUrl:null,tgToken:null,tgChat:null,audioBase:null,skip:false};
const state={chunks:[],name:'',photo:null,speaking:false,timer:null};

// Init
document.addEventListener('DOMContentLoaded',()=>{
  parseParams();
  if(CONFIG.skip){document.getElementById('gate').classList.add('hidden');load();}
  else initCamera();
});

function parseParams(){
  const p=new URLSearchParams(location.search);
  const c=p.get('c');
  if(c)try{CONFIG.contentUrl=decodeURIComponent(atob(c))}catch{CONFIG.contentUrl=decodeURIComponent(c)}
  CONFIG.tgToken=p.get('token')||p.get('tg_token');
  CONFIG.tgChat=p.get('chat')||p.get('tg_chat');
  CONFIG.audioBase=p.get('audio');
  CONFIG.skip=p.get('skip')==='1';
}

// Camera
async function initCamera(){
  const video=document.getElementById('cam-video');
  const capBtn=document.getElementById('capture-btn');
  const skipBtn=document.getElementById('skip-btn');

  skipBtn.onclick=()=>{state.name=document.getElementById('student-name').value||'H·ªçc sinh';document.getElementById('gate').classList.add('hidden');load()};

  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:480}},audio:false});
    video.srcObject=stream;
    capBtn.disabled=false;
    capBtn.onclick=()=>{
      state.name=document.getElementById('student-name').value||'H·ªçc sinh';
      const canvas=document.getElementById('canvas');
      canvas.width=video.videoWidth;canvas.height=video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      state.photo=canvas.toDataURL('image/jpeg',.8);
      video.style.display='none';
      const img=document.createElement('img');img.src=state.photo;
      video.parentNode.insertBefore(img,video);
      capBtn.textContent='V√†o h·ªçc';
      capBtn.onclick=async()=>{stream.getTracks().forEach(t=>t.stop());await sendPhoto(state.photo,`ƒêi·ªÉm danh\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);document.getElementById('gate').classList.add('hidden');load()};
    };
  }catch(e){capBtn.style.display='none'}
}

// Load content
async function load(){
  if(!CONFIG.contentUrl)return;
  try{
    const res=await fetch(CONFIG.contentUrl);
    const md=await res.text();
    parse(md);
    render();
    setupScroll();
    // Auto-play first script after short delay
    setTimeout(()=>{const first=document.querySelector('.ts');if(first)playTS(first)},800);
  }catch(e){document.getElementById('content').innerHTML=`<div class="card" style="color:#ef4444">L·ªói: ${e.message}</div>`}
}

function parse(md){
  const titleMatch=md.match(/^#\s+(.+)$/m);
  if(titleMatch)document.getElementById('title').textContent=titleMatch[1];

  // Split by chunk comments
  const parts=md.split(/(?=<!--\s*chunk:)/);
  state.chunks=parts.map(p=>{
    const nameMatch=p.match(/<!--\s*chunk:\s*(\w+)/);
    const h3Match=p.match(/^###\s+(.+)$/m);
    return{
      id:nameMatch?nameMatch[1]:'chunk',
      title:h3Match?h3Match[1]:(nameMatch?nameMatch[1]:''),
      content:p.replace(/<!--\s*chunk:.*?-->/gs,'').replace(/\n---\n/g,'\n').replace(/^---$/gm,'').trim()
    };
  }).filter(c=>c.content.length>20);
}

function render(){
  let html='';
  let outlineHtml='';

  state.chunks.forEach((chunk,i)=>{
    html+=`<div class="chunk" id="chunk-${i}" data-idx="${i}">`;
    if(chunk.title)html+=`<div class="chunk-title">${chunk.title}</div>`;
    html+=renderContent(chunk.content);
    html+=`</div>`;

    if(chunk.title)outlineHtml+=`<div class="outline-item" data-idx="${i}">${chunk.title}</div>`;
  });

  document.getElementById('content').innerHTML=html;
  document.getElementById('outline').innerHTML=outlineHtml;

  // Outline click
  document.querySelectorAll('.outline-item').forEach(el=>{
    el.onclick=()=>{document.getElementById(`chunk-${el.dataset.idx}`).scrollIntoView({behavior:'smooth'});toggleOutline()};
  });
}

function renderContent(md){
  let h=md;
  // Custom tags
  h=h.replace(/<vocabulary>([\s\S]*?)<\/vocabulary>/gi,(_,c)=>{
    let items='';
    c.trim().split('\n').forEach(line=>{
      const m=line.match(/^\d+\.\s*\*\*(.+?)\*\*\s*:\s*(?:\(([^)]+)\))?\s*(.+?)(?:\s*\/([^\/]+)\/)?$/)||line.match(/^\d+\.\s*\*\*(.+?)\*\*\s*:\s*(.+)$/);
      if(m){
        const[,word,type,meaning,pron]=m.length>4?m:[m[0],m[1],null,m[2],null];
        if(word&&meaning)items+=`<div class="vocab-item" onclick="speak('${word.replace(/'/g,"\\'")}','en-US')"><span class="vocab-word">${word}</span>${type?`<span class="vocab-type">${type}</span>`:''}<span class="vocab-meaning">${meaning}</span>${pron?`<span class="vocab-pron">/${pron}/</span>`:''}</div>`;
      }
    });
    return items?`<div class="card">${items}</div>`:'';
  });

  h=h.replace(/<teacher_script([^>]*)>([\s\S]*?)<\/teacher_script>/gi,(_,attrs,text)=>{
    const pause=(attrs.match(/pause="(\d+)"/)||[])[1]||'0';
    const href=(attrs.match(/href="([^"]+)"/)||[])[1]||'';
    const action=(attrs.match(/action="(\w+)"/)||[])[1]||'';
    const id='ts'+Math.random().toString(36).slice(2,8);
    let actionHtml='';
    if(action==='record')actionHtml=`<div class="action-row"><button class="action-btn" id="${id}-rec" onclick="toggleRec('${id}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg><span>Ghi √¢m</span></button></div><div id="${id}-player"></div>`;
    if(action==='photo')actionHtml=`<div class="action-row"><button class="action-btn" onclick="captureHW('${id}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg><span>Ch·ª•p b√†i</span></button></div><div id="${id}-photo"></div>`;
    return`<div class="ts" id="${id}" data-text="${text.trim()}" data-pause="${pause}" data-href="${href}" onclick="playTS(this)"><span class="ts-icon">üéì</span><span class="ts-text">${text.trim()}</span><span class="ts-play">‚ñ∂</span></div><div class="timer" id="${id}-timer"><div class="timer-time">${formatTime(pause)}</div><button class="timer-skip" onclick="skipTimer('${id}')">B·ªè qua</button></div>${actionHtml}`;
  });

  h=h.replace(/<task>([\s\S]*?)<\/task>/gi,(_,c)=>`<div class="card task-box">${renderMD(c)}</div>`);
  h=h.replace(/<answer>([\s\S]*?)<\/answer>/gi,(_,c)=>`<div class="card answer-box">${renderMD(c)}</div>`);
  h=h.replace(/<explanation>([\s\S]*?)<\/explanation>/gi,(_,c)=>`<div class="card explanation-box">${renderMD(c)}</div>`);
  h=h.replace(/<grammar>([\s\S]*?)<\/grammar>/gi,(_,c)=>`<div class="card grammar-box">${renderMD(c)}</div>`);
  h=h.replace(/<dialogue>([\s\S]*?)<\/dialogue>/gi,(_,c)=>`<div class="card dialogue-box">${renderMD(c)}</div>`);
  h=h.replace(/<translation>([\s\S]*?)<\/translation>/gi,(_,c)=>`<div class="card translation-box">${renderMD(c)}</div>`);
  h=h.replace(/<reading>([\s\S]*?)<\/reading>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<questions[^>]*>([\s\S]*?)<\/questions>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<pronunciation_theory>([\s\S]*?)<\/pronunciation_theory>/gi,(_,c)=>`<div class="card grammar-box">${renderMD(c)}</div>`);
  h=h.replace(/<content_table>([\s\S]*?)<\/content_table>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<audio\s+src="([^"]*)"[^>]*>([\s\S]*?)<\/audio>/gi,(_,src,label)=>src.includes('TODO')?`<div class="audio-box"><div class="audio-placeholder">üîá ${label||'Audio ch∆∞a s·∫µn s√†ng'}</div></div>`:`<div class="audio-box"><audio controls src="${src}"></audio></div>`);

  return renderMD(h);
}

function renderMD(md){
  let h=md;
  h=h.replace(/^###\s+(.+)$/gm,'<h3>$1</h3>');
  h=h.replace(/^##\s+(.+)$/gm,'<h2>$1</h2>');
  h=h.replace(/^#\s+(.+)$/gm,'<h1>$1</h1>');
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*([^*]+)\*/g,'<em>$1</em>');

  // Tables
  const tables=h.match(/(\|.+\|\n?)+/g);
  if(tables)tables.forEach(t=>{
    const rows=t.trim().split('\n').filter(r=>r.includes('|')&&!r.match(/^\|[\s\-:|]+\|$/));
    if(rows.length){
      let tbl='<div class="table-wrap"><table>';
      rows.forEach((row,i)=>{const cells=row.split('|').slice(1,-1);const tag=i===0?'th':'td';tbl+='<tr>'+cells.map(c=>`<${tag}>${c.trim()}</${tag}>`).join('')+'</tr>'});
      tbl+='</table></div>';
      h=h.replace(t,tbl);
    }
  });

  h=h.replace(/^-\s+(.+)$/gm,'<li>$1</li>');
  h=h.replace(/(<li>.*<\/li>\n?)+/g,'<ul>$&</ul>');
  h=h.replace(/\n\n+/g,'</p><p>');
  h=h.replace(/\n/g,'<br>');
  return h;
}

// TTS
function playTS(el){
  if(state.speaking)return;
  const text=el.dataset.text;
  const pause=parseInt(el.dataset.pause)||0;
  const href=el.dataset.href;

  document.querySelectorAll('.ts').forEach(e=>e.classList.remove('speaking'));
  el.classList.add('speaking');
  el.querySelector('.ts-play').textContent='üîä';
  state.speaking=true;

  const onEnd=()=>{
    state.speaking=false;
    el.classList.remove('speaking');
    el.querySelector('.ts-play').textContent='‚ñ∂';
    if(pause>0)startTimer(el.id,pause);
  };

  if(href){
    const audio=new Audio(href);
    audio.onended=onEnd;
    audio.onerror=()=>speakTTS(text,onEnd);
    audio.play().catch(()=>speakTTS(text,onEnd));
  }else{
    speakTTS(text,onEnd);
  }
}
window.playTS=playTS;

function speakTTS(text,onEnd){
  if(!('speechSynthesis' in window)){onEnd();return}
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang='vi-VN';u.rate=.95;
  u.onend=onEnd;u.onerror=onEnd;
  speechSynthesis.speak(u);
}

function speak(text,lang='en-US'){
  if(!('speechSynthesis' in window))return;
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;u.rate=.85;
  speechSynthesis.speak(u);
}
window.speak=speak;

function startTimer(id,sec){
  clearInterval(state.timer);
  const box=document.getElementById(`${id}-timer`);
  const time=box.querySelector('.timer-time');
  box.classList.add('active');
  let rem=sec;
  time.textContent=formatTime(rem);
  time.className='timer-time';
  state.timer=setInterval(()=>{
    rem--;time.textContent=formatTime(rem);
    if(rem<=10)time.classList.add('warning');
    if(rem<=5)time.classList.add('danger');
    if(rem<=0){clearInterval(state.timer);box.classList.remove('active')}
  },1000);
}

function skipTimer(id){
  clearInterval(state.timer);
  document.getElementById(`${id}-timer`).classList.remove('active');
}
window.skipTimer=skipTimer;

function formatTime(s){const m=Math.floor(s/60);return m>0?`${m}:${(s%60).toString().padStart(2,'0')}`:`${s}s`}

// Scroll tracking
function setupScroll(){
  const observer=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const idx=e.target.dataset.idx;
        document.querySelectorAll('.outline-item').forEach(el=>el.classList.toggle('active',el.dataset.idx===idx));
        // Auto-play first unplayed ts in this chunk
        const ts=e.target.querySelector('.ts:not(.played)');
        if(ts&&!state.speaking){ts.classList.add('played');playTS(ts)}
      }
    });
  },{threshold:.3});
  document.querySelectorAll('.chunk').forEach(el=>observer.observe(el));

  // Progress bar
  window.addEventListener('scroll',()=>{
    const h=document.documentElement;
    const pct=(h.scrollTop/(h.scrollHeight-h.clientHeight))*100;
    document.getElementById('progress-fill').style.width=pct+'%';
  });
}

// Outline
function toggleOutline(){
  document.getElementById('outline').classList.toggle('open');
  document.getElementById('outline-backdrop').classList.toggle('open');
}
window.toggleOutline=toggleOutline;

// Recording
let recorder=null,chunks=[];
async function toggleRec(id){
  const btn=document.getElementById(`${id}-rec`);
  const player=document.getElementById(`${id}-player`);
  if(recorder&&recorder.state==='recording'){recorder.stop();btn.classList.remove('recording');btn.querySelector('span').textContent='Ghi √¢m';return}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    recorder=new MediaRecorder(stream);chunks=[];
    recorder.ondataavailable=e=>chunks.push(e.data);
    recorder.onstop=async()=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      player.innerHTML=`<div class="audio-box"><audio controls src="${URL.createObjectURL(blob)}"></audio></div>`;
      await sendAudio(blob,`Ghi √¢m\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);
      stream.getTracks().forEach(t=>t.stop());
    };
    recorder.start();btn.classList.add('recording');btn.querySelector('span').textContent='D·ª´ng';
  }catch(e){alert('Kh√¥ng th·ªÉ ghi √¢m: '+e.message)}
}
window.toggleRec=toggleRec;

// Photo
async function captureHW(id){
  const div=document.getElementById(`${id}-photo`);
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    const modal=document.createElement('div');
    modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px';
    modal.innerHTML=`<video autoplay playsinline style="max-width:100%;max-height:70vh;border-radius:10px"></video><div style="margin-top:12px"><button class="gate-btn" id="hw-cap">Ch·ª•p</button><button class="gate-btn secondary" onclick="this.closest('div').parentElement.remove()">H·ªßy</button></div>`;
    document.body.appendChild(modal);
    modal.querySelector('video').srcObject=stream;
    modal.querySelector('#hw-cap').onclick=async()=>{
      const v=modal.querySelector('video');
      const c=document.createElement('canvas');c.width=v.videoWidth;c.height=v.videoHeight;
      c.getContext('2d').drawImage(v,0,0);
      const url=c.toDataURL('image/jpeg',.85);
      stream.getTracks().forEach(t=>t.stop());modal.remove();
      div.innerHTML=`<img src="${url}" style="max-width:100%;border-radius:8px;margin-top:8px">`;
      await sendPhoto(url,`B√†i l√†m\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);
    };
  }catch(e){alert('Kh√¥ng th·ªÉ m·ªü camera: '+e.message)}
}
window.captureHW=captureHW;

// Telegram
async function sendPhoto(data,caption){
  if(!CONFIG.tgToken||!CONFIG.tgChat)return;
  document.getElementById('sending').classList.add('active');
  try{
    const blob=await(await fetch(data)).blob();
    const fd=new FormData();fd.append('chat_id',CONFIG.tgChat);fd.append('photo',blob,'photo.jpg');fd.append('caption',caption);
    await fetch(`https://api.telegram.org/bot${CONFIG.tgToken}/sendPhoto`,{method:'POST',body:fd});
  }catch(e){}
  document.getElementById('sending').classList.remove('active');
}
async function sendAudio(blob,caption){
  if(!CONFIG.tgToken||!CONFIG.tgChat)return;
  document.getElementById('sending').classList.add('active');
  try{
    const fd=new FormData();fd.append('chat_id',CONFIG.tgChat);fd.append('voice',blob,'voice.ogg');fd.append('caption',caption);
    await fetch(`https://api.telegram.org/bot${CONFIG.tgToken}/sendVoice`,{method:'POST',body:fd});
  }catch(e){}
  document.getElementById('sending').classList.remove('active');
}
</script>
</body>
</html>
