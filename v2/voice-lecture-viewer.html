<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Voice Lecture</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--primary:#0ea5e9;--primary-dark:#0284c7;--accent:#06b6d4;--success:#10b981;--warning:#f59e0b;--bg:#f0f9ff;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e0f2fe;--radius:12px;--safe-bottom:env(safe-area-inset-bottom,0)}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(180deg,#f0f9ff 0%,#e0f2fe 100%);color:var(--text);line-height:1.6;font-size:16px;min-height:100vh}

    /* Header - Ocean Blue */
    header{background:linear-gradient(135deg,#0284c7,#0ea5e9);color:#fff;padding:12px 16px;padding-top:calc(12px + env(safe-area-inset-top,0));position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;gap:12px;box-shadow:0 2px 12px rgba(14,165,233,.3)}
    header h1{font-size:.95rem;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #progress{height:4px;background:rgba(255,255,255,.3);position:absolute;bottom:0;left:0;right:0;border-radius:2px}
    #progress-fill{height:100%;background:#fff;width:0%;transition:width .3s;border-radius:2px}

    /* Content */
    #content{padding:68px 16px 100px;max-width:640px;margin:0 auto}

    /* Chunks - Clear sections */
    .chunk{padding:20px 0;border-bottom:2px dashed #bae6fd}
    .chunk:last-child{border-bottom:none}
    .chunk-title{font-size:.7rem;color:#0369a1;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;font-weight:600;background:#e0f2fe;display:inline-block;padding:4px 10px;border-radius:20px}

    /* Typography */
    h1{font-size:1.25rem;margin:12px 0 8px;color:#0c4a6e}
    h2{font-size:1.1rem;margin:16px 0 8px;color:#0369a1;font-weight:700}
    h3{font-size:1rem;margin:12px 0 6px;font-weight:600;color:#075985}
    p{margin:6px 0}
    strong{color:#0284c7}
    em{color:var(--muted);font-style:normal}

    /* Teacher Script - Ocean style */
    .ts{display:flex;align-items:center;gap:10px;padding:12px 14px;margin:10px 0;background:linear-gradient(135deg,#e0f2fe,#bae6fd);border-radius:50px;border:2px solid #7dd3fc;cursor:pointer;transition:all .2s}
    .ts:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(14,165,233,.25)}
    .ts.speaking{background:linear-gradient(135deg,#bae6fd,#7dd3fc);border-color:#0ea5e9;animation:glow 1.5s ease-in-out infinite}
    .ts.played{opacity:.6;border-style:dashed}
    .ts-icon{font-size:1.3rem;animation:none}
    .ts.speaking .ts-icon{animation:bounce .5s ease infinite}
    .ts-label{flex:1;font-size:.9rem;color:#0369a1;font-weight:500}
    .ts-status{font-size:.75rem;padding:4px 10px;background:#fff;border-radius:20px;color:#0369a1;font-weight:500}
    .ts.speaking .ts-status{background:#0ea5e9;color:#fff}
    @keyframes glow{0%,100%{box-shadow:0 0 8px rgba(14,165,233,.3)}50%{box-shadow:0 0 20px rgba(14,165,233,.5)}}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

    /* Timer - Deep ocean */
    .timer{background:linear-gradient(135deg,#0c4a6e,#075985);color:#fff;padding:16px;border-radius:16px;margin:10px 0;text-align:center;display:none;box-shadow:0 4px 12px rgba(12,74,110,.3)}
    .timer.active{display:block}
    .timer-label{font-size:.8rem;opacity:.8;margin-bottom:4px}
    .timer-time{font-size:2.5rem;font-weight:700}
    .timer-time.warning{color:#fcd34d}
    .timer-time.danger{color:#fca5a5;animation:pulse 1s infinite}
    @keyframes pulse{50%{opacity:.6}}
    .timer-skip{background:rgba(255,255,255,.2);border:none;color:#fff;padding:10px 20px;border-radius:25px;margin-top:10px;cursor:pointer;font-weight:500;transition:background .2s}
    .timer-skip:hover{background:rgba(255,255,255,.3)}

    /* Cards - Clean shadows */
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.06);border:1px solid var(--border)}
    .task-box{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-left:4px solid var(--primary);border:none}
    .answer-box{background:linear-gradient(135deg,#ecfdf5,#d1fae5);border-left:4px solid var(--success);border:none}
    .explanation-box{background:linear-gradient(135deg,#fffbeb,#fef3c7);border-left:4px solid var(--warning);border:none}
    .grammar-box{background:linear-gradient(135deg,#f5f3ff,#ede9fe);border-left:4px solid #8b5cf6;border:none}
    .translation-box{background:linear-gradient(135deg,#ecfeff,#cffafe);border-left:4px solid var(--accent);border:none}
    .dialogue-box{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-left:4px solid var(--success);border:none}

    /* Vocabulary - Ocean cards */
    .vocab-list{display:flex;flex-direction:column;gap:8px}
    .vocab-item{padding:12px;background:linear-gradient(135deg,#fff,#f0f9ff);border-radius:10px;cursor:pointer;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border:1px solid #bae6fd;transition:all .2s}
    .vocab-item:hover{transform:translateX(4px);box-shadow:0 2px 8px rgba(14,165,233,.15);border-color:#0ea5e9}
    .vocab-item:active{transform:scale(.98)}
    .vocab-word{font-weight:700;color:#0284c7;font-size:1rem}
    .vocab-type{font-size:.65rem;background:#e0f2fe;padding:2px 8px;border-radius:10px;color:#0369a1;font-weight:600;text-transform:uppercase}
    .vocab-meaning{flex:1 1 100%;font-size:.9rem;margin-top:4px;color:#475569}
    .vocab-pron{font-size:.8rem;color:#0369a1;background:#e0f2fe;padding:3px 8px;border-radius:8px;font-family:monospace}
    @media(min-width:400px){.vocab-meaning{flex:1;margin-top:0}}

    /* Tables */
    .table-wrap{overflow-x:auto;margin:10px 0;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    table{width:100%;border-collapse:collapse;font-size:.85rem;background:#fff}
    th,td{padding:10px 12px;border:1px solid var(--border);text-align:left}
    th{background:linear-gradient(135deg,#e0f2fe,#bae6fd);font-weight:600;font-size:.8rem;color:#0369a1}

    /* Lists */
    ul{margin:8px 0;padding-left:20px}
    li{margin:4px 0}

    /* Action buttons */
    .action-row{display:flex;gap:10px;margin:12px 0}
    .action-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;border:2px solid #7dd3fc;border-radius:12px;background:linear-gradient(135deg,#fff,#f0f9ff);cursor:pointer;min-height:52px;font-weight:500;color:#0369a1;transition:all .2s}
    .action-btn:hover{border-color:#0ea5e9;background:linear-gradient(135deg,#e0f2fe,#bae6fd);transform:scale(1.02)}
    .action-btn.recording{border-color:#ef4444;background:linear-gradient(135deg,#fef2f2,#fee2e2);animation:pulse 1s infinite;color:#dc2626}
    .action-btn svg{width:22px;height:22px}

    /* Audio */
    .audio-box{background:linear-gradient(135deg,#0c4a6e,#075985);padding:14px;border-radius:12px;margin:10px 0;box-shadow:0 4px 12px rgba(12,74,110,.2)}
    .audio-box audio{width:100%;border-radius:8px}
    .audio-placeholder{background:rgba(255,255,255,.1);color:#bae6fd;padding:18px;border-radius:8px;text-align:center;font-size:.9rem}

    /* Camera gate - Ocean theme */
    #gate{position:fixed;inset:0;background:linear-gradient(135deg,#0c4a6e,#0369a1,#0ea5e9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;padding:20px}
    #gate.hidden{display:none}
    #gate h1{color:#fff;margin-bottom:8px;font-size:1.5rem}
    #gate p{color:rgba(255,255,255,.9);margin-bottom:16px;text-align:center}
    #gate video,#gate img{width:100%;max-width:240px;aspect-ratio:4/3;object-fit:cover;border-radius:14px;background:#000;border:3px solid rgba(255,255,255,.3)}
    .gate-input{width:100%;max-width:240px;padding:14px;border:2px solid rgba(255,255,255,.4);border-radius:12px;background:rgba(255,255,255,.15);color:#fff;font-size:1rem;margin:12px 0;text-align:center}
    .gate-input::placeholder{color:rgba(255,255,255,.7)}
    .gate-btn{background:#fff;color:#0369a1;border:none;padding:14px 28px;border-radius:50px;font-size:1rem;font-weight:600;cursor:pointer;margin:4px;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s}
    .gate-btn:hover{transform:scale(1.05)}
    .gate-btn.secondary{background:transparent;color:#fff;border:2px solid rgba(255,255,255,.5);box-shadow:none}

    /* Sending */
    .sending{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#0c4a6e,#075985);color:#fff;padding:18px 32px;border-radius:16px;z-index:1001;display:none;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    .sending.active{display:flex;align-items:center;gap:12px}
    .spinner{width:22px;height:22px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Current chunk highlight */
    .chunk{opacity:.4;pointer-events:none;transition:all .3s}
    .chunk.current{opacity:1;pointer-events:auto;background:rgba(224,242,254,.6);border-radius:16px;margin:0 -12px;padding:20px 12px;box-shadow:0 4px 20px rgba(14,165,233,.15)}
    .chunk.completed{opacity:.7;pointer-events:auto}

    /* Chunk Navigation */
    .chunk-nav{margin-top:16px;text-align:center}
    .nav-btn{background:linear-gradient(135deg,#cbd5e1,#94a3b8);color:#fff;border:none;padding:14px 32px;border-radius:50px;font-size:1rem;font-weight:600;cursor:not-allowed;opacity:.5;transition:all .3s}
    .nav-btn.ready{background:linear-gradient(135deg,#0ea5e9,#0284c7);opacity:1;cursor:pointer;animation:readyPulse 2s ease infinite;box-shadow:0 4px 16px rgba(14,165,233,.4)}
    .nav-btn.ready:hover{transform:scale(1.05)}
    @keyframes readyPulse{0%,100%{box-shadow:0 4px 16px rgba(14,165,233,.4)}50%{box-shadow:0 4px 24px rgba(14,165,233,.6)}}

    /* Inline Continue Button - After each section */
    .ts-continue{display:none;margin:12px 0;text-align:center}
    .ts-continue.show{display:block}
    .continue-btn{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:12px 28px;border-radius:50px;font-size:.95rem;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,.3);transition:all .2s;animation:continuePulse 1.5s ease infinite}
    .continue-btn:hover{transform:scale(1.05);box-shadow:0 4px 16px rgba(16,185,129,.4)}
    @keyframes continuePulse{0%,100%{box-shadow:0 4px 12px rgba(16,185,129,.3)}50%{box-shadow:0 4px 20px rgba(16,185,129,.5)}}

    /* Complete Box */
    .complete-box{background:linear-gradient(135deg,#e0f2fe,#bae6fd);border-radius:20px;padding:32px;text-align:center;margin:20px 0;box-shadow:0 8px 32px rgba(14,165,233,.2)}
    .complete-icon{font-size:4rem;margin-bottom:12px}
    .complete-box h2{color:#0369a1;margin-bottom:8px}
    .complete-box p{color:#075985}

    /* ========== VOCABULARY INTERACTIVE SYSTEM ========== */

    /* Vocab Container */
    .vocab-interactive{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:16px;padding:16px;margin:12px 0;border:2px solid #bae6fd}
    .vocab-phase{display:none}
    .vocab-phase.active{display:block}
    .vocab-progress{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
    .vocab-progress-dot{width:10px;height:10px;border-radius:50%;background:#cbd5e1;transition:all .3s}
    .vocab-progress-dot.done{background:#10b981}
    .vocab-progress-dot.current{background:#0ea5e9;transform:scale(1.3);box-shadow:0 0 8px rgba(14,165,233,.5)}

    /* Phase Header */
    .phase-header{background:linear-gradient(135deg,#0284c7,#0ea5e9);color:#fff;padding:12px 16px;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:10px}
    .phase-icon{font-size:1.5rem}
    .phase-title{flex:1;font-weight:600}
    .phase-count{font-size:.85rem;opacity:.9}

    /* Flash Card */
    .flashcard{background:#fff;border-radius:20px;padding:32px 24px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.1);min-height:280px;display:flex;flex-direction:column;justify-content:center;position:relative;overflow:hidden}
    .flashcard.flip .flashcard-front{opacity:0;transform:rotateY(90deg)}
    .flashcard.flip .flashcard-back{opacity:1;transform:rotateY(0)}
    .flashcard-front,.flashcard-back{transition:all .4s}
    .flashcard-back{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;padding:32px 24px;opacity:0;transform:rotateY(-90deg)}
    .flashcard-word{font-size:2rem;font-weight:700;color:#0284c7;margin-bottom:8px}
    .flashcard-pron{font-size:1.1rem;color:#64748b;font-family:monospace;margin-bottom:12px}
    .flashcard-type{display:inline-block;background:#e0f2fe;color:#0369a1;padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;margin-bottom:16px}
    .flashcard-meaning{font-size:1.4rem;color:#0f172a;margin-top:12px}
    .flashcard-repeat{font-size:.9rem;color:#64748b;margin-top:16px}
    .flashcard-repeat span{display:inline-block;width:24px;height:24px;line-height:24px;border-radius:50%;background:#e2e8f0;margin:0 4px;font-weight:600}
    .flashcard-repeat span.done{background:#10b981;color:#fff}
    .flashcard-speaking{animation:cardPulse 1s ease infinite}
    @keyframes cardPulse{0%,100%{box-shadow:0 8px 32px rgba(0,0,0,.1)}50%{box-shadow:0 8px 40px rgba(14,165,233,.3)}}

    /* Quiz */
    .quiz-question{background:#fff;border-radius:16px;padding:20px;margin-bottom:16px;text-align:center}
    .quiz-prompt{font-size:1rem;color:#64748b;margin-bottom:8px}
    .quiz-word{font-size:1.8rem;font-weight:700;color:#0284c7}
    .quiz-options{display:flex;flex-direction:column;gap:10px}
    .quiz-option{background:#fff;border:2px solid #e2e8f0;border-radius:12px;padding:14px 16px;cursor:pointer;transition:all .2s;text-align:left;font-size:1rem}
    .quiz-option:hover{border-color:#0ea5e9;background:#f0f9ff}
    .quiz-option.selected{border-color:#0ea5e9;background:#e0f2fe}
    .quiz-option.correct{border-color:#10b981;background:#d1fae5;animation:correctPop .3s}
    .quiz-option.wrong{border-color:#ef4444;background:#fee2e2;animation:shake .3s}
    @keyframes correctPop{50%{transform:scale(1.02)}}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

    /* Game - Matching */
    .game-container{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .game-col{display:flex;flex-direction:column;gap:8px}
    .game-col-title{font-size:.8rem;color:#64748b;text-align:center;margin-bottom:4px;font-weight:600}
    .game-item{background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:12px;cursor:pointer;transition:all .2s;font-size:.95rem;min-height:48px;display:flex;align-items:center;justify-content:center;text-align:center}
    .game-item:hover{border-color:#0ea5e9;transform:scale(1.02)}
    .game-item.selected{border-color:#0ea5e9;background:#e0f2fe;box-shadow:0 0 12px rgba(14,165,233,.3)}
    .game-item.matched{border-color:#10b981;background:#d1fae5;opacity:.6;pointer-events:none}
    .game-item.wrong{animation:shake .3s;border-color:#ef4444}
    .game-score{text-align:center;margin-top:16px;font-size:1.1rem;font-weight:600;color:#0369a1}

    /* Writing Phase */
    .writing-list{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px}
    .writing-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px dashed #e2e8f0;align-items:center}
    .writing-item:last-child{border-bottom:none}
    .writing-num{width:24px;height:24px;background:#0ea5e9;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:600;flex-shrink:0}
    .writing-word{font-weight:600;color:#0284c7;min-width:100px}
    .writing-meaning{flex:1;color:#475569}
    .writing-timer{background:linear-gradient(135deg,#0c4a6e,#075985);color:#fff;padding:20px;border-radius:16px;text-align:center}
    .writing-timer-label{font-size:.9rem;opacity:.8;margin-bottom:8px}
    .writing-timer-time{font-size:3rem;font-weight:700}

    /* Phase Nav Buttons */
    .vocab-nav{display:flex;gap:10px;margin-top:16px;justify-content:center}
    .vocab-btn{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;border:none;padding:14px 28px;border-radius:50px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .2s;box-shadow:0 4px 12px rgba(14,165,233,.3)}
    .vocab-btn:hover{transform:scale(1.05)}
    .vocab-btn:disabled{background:#94a3b8;cursor:not-allowed;transform:none}
    .vocab-btn.secondary{background:transparent;color:#0369a1;border:2px solid #0ea5e9;box-shadow:none}

    /* Scrollbar hide for locked mode */
    body::-webkit-scrollbar{display:none}
    body{-ms-overflow-style:none;scrollbar-width:none}
  </style>
</head>
<body>
  <div id="gate">
    <h1>ƒêi·ªÉm danh</h1>
    <p>Nh·∫≠p t√™n v√† ch·ª•p ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
    <input type="text" id="student-name" class="gate-input" placeholder="T√™n c·ªßa b·∫°n...">
    <video id="cam-video" autoplay playsinline muted></video>
    <div style="margin-top:12px">
      <button class="gate-btn" id="capture-btn" disabled>Ch·ª•p ·∫£nh</button>
      <button class="gate-btn secondary" id="skip-btn">B·ªè qua</button>
    </div>
  </div>

  <header>
    <h1 id="title">Voice Lecture</h1>
    <div id="progress"><div id="progress-fill"></div></div>
  </header>


  <div id="content"></div>

  <div class="sending" id="sending"><div class="spinner"></div> ƒêang g·ª≠i...</div>
  <canvas id="canvas" style="display:none"></canvas>

<script>
const CONFIG={contentUrl:null,tgToken:null,tgChat:null,audioBase:null,skip:false};
const state={chunks:[],name:'',photo:null,speaking:false,timer:null,currentChunk:0,tsQueue:[],locked:true};

// Vocabulary Interactive State
const vocabState={
  instances:{}, // Multiple vocab sections possible
  currentInstance:null
};

// Init
document.addEventListener('DOMContentLoaded',()=>{
  parseParams();
  if(CONFIG.skip){document.getElementById('gate').classList.add('hidden');load();}
  else initCamera();
});

function parseParams(){
  const p=new URLSearchParams(location.search);
  const c=p.get('c');
  if(c)try{CONFIG.contentUrl=decodeURIComponent(atob(c))}catch{CONFIG.contentUrl=decodeURIComponent(c)}
  CONFIG.tgToken=p.get('token')||p.get('tg_token');
  CONFIG.tgChat=p.get('chat')||p.get('tg_chat');
  CONFIG.audioBase=p.get('audio');
  CONFIG.skip=p.get('skip')==='1';
}

// Camera
async function initCamera(){
  const video=document.getElementById('cam-video');
  const capBtn=document.getElementById('capture-btn');
  const skipBtn=document.getElementById('skip-btn');

  skipBtn.onclick=()=>{state.name=document.getElementById('student-name').value||'H·ªçc sinh';document.getElementById('gate').classList.add('hidden');load()};

  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:480}},audio:false});
    video.srcObject=stream;
    capBtn.disabled=false;
    capBtn.onclick=()=>{
      state.name=document.getElementById('student-name').value||'H·ªçc sinh';
      const canvas=document.getElementById('canvas');
      canvas.width=video.videoWidth;canvas.height=video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      state.photo=canvas.toDataURL('image/jpeg',.8);
      video.style.display='none';
      const img=document.createElement('img');img.src=state.photo;
      video.parentNode.insertBefore(img,video);
      capBtn.textContent='V√†o h·ªçc';
      capBtn.onclick=async()=>{stream.getTracks().forEach(t=>t.stop());await sendPhoto(state.photo,`ƒêi·ªÉm danh\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);document.getElementById('gate').classList.add('hidden');load()};
    };
  }catch(e){capBtn.style.display='none'}
}

// Load content
async function load(){
  if(!CONFIG.contentUrl)return;
  try{
    const res=await fetch(CONFIG.contentUrl);
    const md=await res.text();
    parse(md);
    render();
    setupNavigation();
    // Start from first chunk
    setTimeout(()=>activateChunk(0),500);
  }catch(e){document.getElementById('content').innerHTML=`<div class="card" style="color:#ef4444">L·ªói: ${e.message}</div>`}
}

function parse(md){
  const titleMatch=md.match(/^#\s+(.+)$/m);
  if(titleMatch)document.getElementById('title').textContent=titleMatch[1];

  // Split by chunk comments
  const parts=md.split(/(?=<!--\s*chunk:)/);
  state.chunks=parts.map(p=>{
    const nameMatch=p.match(/<!--\s*chunk:\s*(\w+)/);
    const h3Match=p.match(/^###\s+(.+)$/m);
    return{
      id:nameMatch?nameMatch[1]:'chunk',
      title:h3Match?h3Match[1]:(nameMatch?nameMatch[1]:''),
      content:p.replace(/<!--\s*chunk:.*?-->/gs,'').replace(/\n---\n/g,'\n').replace(/^---$/gm,'').trim()
    };
  }).filter(c=>c.content.length>20);
}

function render(){
  let html='';
  state.chunks.forEach((chunk,i)=>{
    html+=`<div class="chunk" id="chunk-${i}" data-idx="${i}">`;
    if(chunk.title)html+=`<div class="chunk-title">${chunk.title}</div>`;
    html+=renderContent(chunk.content);
    html+=`</div>`;
  });
  document.getElementById('content').innerHTML=html;
}

function renderContent(md){
  let h=md;
  // Custom tags - VOCABULARY with Interactive Learning System
  h=h.replace(/<vocabulary>([\s\S]*?)<\/vocabulary>/gi,(_,c)=>{
    const vocabId='vocab'+Math.random().toString(36).slice(2,8);
    const words=[];
    c.trim().split(/\r?\n/).forEach(line=>{
      const baseMatch=line.match(/^\d+\.\s*\*\*(.+?)\*\*\s*:\s*(.+)$/);
      if(baseMatch){
        const word=baseMatch[1];
        let rest=baseMatch[2].trim();
        let type=null;
        const typeMatch=rest.match(/^\(([^)]+)\)\s*/);
        if(typeMatch){type=typeMatch[1];rest=rest.slice(typeMatch[0].length);}
        let pron=null;
        const pronMatch=rest.match(/\s*\/([^\/]+)\/$/);
        if(pronMatch){pron=pronMatch[1];rest=rest.slice(0,-pronMatch[0].length);}
        const meaning=rest.trim();
        if(word&&meaning)words.push({word,type,pron,meaning});
      }
    });
    if(words.length===0)return'';
    // Store for later use
    vocabState.instances[vocabId]={words,currentWord:0,phase:'flashcard',quizAnswers:[],gameMatched:0};
    // Build interactive HTML
    return buildVocabInteractive(vocabId,words);
  });

  // TEACHER SCRIPT - Hide text, show friendly label
  h=h.replace(/<teacher_script([^>]*)>([\s\S]*?)<\/teacher_script>/gi,(_,attrs,text)=>{
    const pause=(attrs.match(/pause="(\d+)"/)||[])[1]||'0';
    const href=(attrs.match(/href="([^"]+)"/)||[])[1]||'';
    const action=(attrs.match(/action="(\w+)"/)||[])[1]||'';
    const id='ts'+Math.random().toString(36).slice(2,8);
    let actionHtml='';
    if(action==='record')actionHtml=`<div class="action-row"><button class="action-btn" id="${id}-rec" onclick="toggleRec('${id}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg><span>Ghi √¢m</span></button></div><div id="${id}-player"></div>`;
    if(action==='photo')actionHtml=`<div class="action-row"><button class="action-btn" onclick="captureHW('${id}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg><span>Ch·ª•p b√†i</span></button></div><div id="${id}-photo"></div>`;
    // Friendly label instead of showing script text
    const label=action==='record'?'Ghi √¢m g·ª≠i th·∫ßy n√®...':action==='photo'?'Ch·ª•p b√†i g·ª≠i th·∫ßy n√®...':'Nghe th·∫ßy n√≥i n√®...';
    // Add inline continue button after each TS - student confirms they've read/listened
    const continueBtn=`<div class="ts-continue" id="${id}-continue"><button class="continue-btn" onclick="clickContinue('${id}')">Nghe r·ªìi ‚úì</button></div>`;
    return`<div class="ts" id="${id}" data-text="${text.trim().replace(/"/g,'&quot;')}" data-pause="${pause}" data-href="${href}" onclick="playTS(this)"><span class="ts-icon">üéì</span><span class="ts-label">${label}</span><span class="ts-status">B·∫•m nghe</span></div><div class="timer" id="${id}-timer"><div class="timer-label">Th·ªùi gian l√†m b√†i</div><div class="timer-time">${formatTime(pause)}</div><button class="timer-skip" onclick="skipTimer('${id}')">Xong r·ªìi ‚Üí</button></div>${actionHtml}${continueBtn}`;
  });

  h=h.replace(/<task>([\s\S]*?)<\/task>/gi,(_,c)=>`<div class="card task-box">${renderMD(c)}</div>`);
  h=h.replace(/<answer>([\s\S]*?)<\/answer>/gi,(_,c)=>`<div class="card answer-box">${renderMD(c)}</div>`);
  h=h.replace(/<explanation>([\s\S]*?)<\/explanation>/gi,(_,c)=>`<div class="card explanation-box">${renderMD(c)}</div>`);
  h=h.replace(/<grammar>([\s\S]*?)<\/grammar>/gi,(_,c)=>`<div class="card grammar-box">${renderMD(c)}</div>`);
  h=h.replace(/<dialogue>([\s\S]*?)<\/dialogue>/gi,(_,c)=>`<div class="card dialogue-box">${renderMD(c)}</div>`);
  h=h.replace(/<translation>([\s\S]*?)<\/translation>/gi,(_,c)=>`<div class="card translation-box">${renderMD(c)}</div>`);
  h=h.replace(/<reading>([\s\S]*?)<\/reading>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<questions[^>]*>([\s\S]*?)<\/questions>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<pronunciation_theory>([\s\S]*?)<\/pronunciation_theory>/gi,(_,c)=>`<div class="card grammar-box">${renderMD(c)}</div>`);
  h=h.replace(/<content_table>([\s\S]*?)<\/content_table>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<audio\s+src="([^"]*)"[^>]*>([\s\S]*?)<\/audio>/gi,(_,src,label)=>src.includes('TODO')?`<div class="audio-box"><div class="audio-placeholder">üîá ${label||'Audio ch∆∞a s·∫µn s√†ng'}</div></div>`:`<div class="audio-box"><audio controls src="${src}"></audio></div>`);

  return renderMD(h);
}

function renderMD(md){
  let h=md;
  h=h.replace(/^###\s+(.+)$/gm,'<h3>$1</h3>');
  h=h.replace(/^##\s+(.+)$/gm,'<h2>$1</h2>');
  h=h.replace(/^#\s+(.+)$/gm,'<h1>$1</h1>');
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*([^*]+)\*/g,'<em>$1</em>');

  // Tables - collect all matches first, then replace from end to preserve indices
  const tableRegex=/^(\|[^\n]+\|[ \t]*\n?)+/gm;
  const matches=[];
  let match;
  while((match=tableRegex.exec(h))!==null){
    matches.push({str:match[0],idx:match.index});
  }
  // Replace from end to start so indices stay valid
  for(let i=matches.length-1;i>=0;i--){
    const{str:tableStr,idx}=matches[i];
    const lines=tableStr.trim().split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
    const dataRows=lines.filter(line=>!/^\|[\s\-:|]+\|$/.test(line));
    if(dataRows.length>0){
      let tbl='<div class="table-wrap"><table>';
      dataRows.forEach((row,ri)=>{
        const parts=row.split('|');
        const cells=parts.slice(1,parts.length-1);
        const tag=ri===0?'th':'td';
        tbl+='<tr>'+cells.map(c=>`<${tag}>${c.trim()}</${tag}>`).join('')+'</tr>';
      });
      tbl+='</table></div>';
      h=h.substring(0,idx)+tbl+h.substring(idx+tableStr.length);
    }
  }

  h=h.replace(/^-\s+(.+)$/gm,'<li>$1</li>');
  h=h.replace(/(<li>.*<\/li>\n?)+/g,'<ul>$&</ul>');
  h=h.replace(/\n\n+/g,'</p><p>');
  h=h.replace(/\n/g,'<br>');
  return h;
}

// TTS - Sequential playback with manual continue
function playTS(el,auto=false){
  if(state.speaking&&!auto)return;
  if(state.speaking&&auto){state.tsQueue.push(el);return;}

  const text=el.dataset.text;
  const pause=parseInt(el.dataset.pause)||0;
  const href=el.dataset.href;

  // Hide all continue buttons first
  document.querySelectorAll('.ts-continue').forEach(c=>c.classList.remove('show'));

  document.querySelectorAll('.ts').forEach(e=>{e.classList.remove('speaking');const s=e.querySelector('.ts-status');if(s)s.textContent='Xong ‚úì'});
  el.classList.add('speaking');
  el.classList.add('played');
  const status=el.querySelector('.ts-status');
  if(status)status.textContent='ƒêang n√≥i...';
  state.speaking=true;
  state.currentTSId=el.id; // Track current TS

  // Scroll element into view
  el.scrollIntoView({behavior:'smooth',block:'center'});

  const onEnd=()=>{
    state.speaking=false;
    el.classList.remove('speaking');
    if(status)status.textContent='Xong ‚úì';

    if(pause>0){
      // Start timer, then show continue button
      startTimer(el.id,pause,()=>showContinueButton(el.id));
    }else{
      // No timer - show continue button immediately
      setTimeout(()=>showContinueButton(el.id),400);
    }
  };

  if(href){
    const audio=new Audio(href);
    audio.onended=onEnd;
    audio.onerror=()=>speakTTS(text,onEnd);
    audio.play().catch(()=>speakTTS(text,onEnd));
  }else{
    speakTTS(text,onEnd);
  }
}
window.playTS=playTS;

// Show continue button after TS completes
function showContinueButton(tsId){
  const chunk=document.getElementById(`chunk-${state.currentChunk}`);
  if(!chunk)return;

  const tsEl=document.getElementById(tsId);
  if(!tsEl)return;

  // Find content between this TS and the next TS
  let next=tsEl.nextElementSibling;
  let contentToShow=null;

  // Skip timer, action buttons, continue button
  while(next&&(next.classList.contains('timer')||next.classList.contains('action-row')||next.id?.includes('-player')||next.id?.includes('-photo')||next.classList.contains('ts-continue'))){
    next=next.nextElementSibling;
  }

  // Check if there's content (not another TS) that student should see
  if(next&&!next.classList.contains('ts')&&!next.classList.contains('chunk-nav')){
    contentToShow=next;

    // If it's an unstarted vocab section, scroll to it and let student start it
    if(next.classList.contains('vocab-interactive')&&!next.classList.contains('vocab-completed')){
      next.scrollIntoView({behavior:'smooth',block:'start'});
      return; // Vocab has its own flow
    }
  }

  // Check if this is the last TS in the chunk
  const allTS=Array.from(chunk.querySelectorAll('.ts'));
  const nextTS=allTS.find(ts=>!ts.classList.contains('played'));

  // Show the continue button
  const continueEl=document.getElementById(`${tsId}-continue`);
  if(continueEl){
    continueEl.classList.add('show');
  }

  // Scroll to content first (so student can read), then they'll see the button above
  if(contentToShow){
    contentToShow.scrollIntoView({behavior:'smooth',block:'start'});
  }else if(continueEl){
    continueEl.scrollIntoView({behavior:'smooth',block:'center'});
  }

  if(!nextTS){
    // No more TS - unlock chunk navigation
    unlockNextChunk();
  }
}

// Click continue to play next TS
function clickContinue(tsId){
  const continueEl=document.getElementById(`${tsId}-continue`);
  if(continueEl)continueEl.classList.remove('show');

  const chunk=document.getElementById(`chunk-${state.currentChunk}`);
  if(!chunk)return;

  const allTS=Array.from(chunk.querySelectorAll('.ts'));
  const nextTS=allTS.find(ts=>!ts.classList.contains('played'));
  if(nextTS){
    playTS(nextTS,true);
  }else{
    unlockNextChunk();
  }
}
window.clickContinue=clickContinue;

// Called after vocab finishes to resume the continue-button flow
function playNextTS(){
  const chunk=document.getElementById(`chunk-${state.currentChunk}`);
  if(!chunk)return;

  const allTS=Array.from(chunk.querySelectorAll('.ts'));
  const nextTS=allTS.find(ts=>!ts.classList.contains('played'));
  if(nextTS){
    // Find the previous TS that was played and show its continue button
    const playedTS=Array.from(chunk.querySelectorAll('.ts.played'));
    if(playedTS.length>0){
      const lastPlayed=playedTS[playedTS.length-1];
      showContinueButton(lastPlayed.id);
    }else{
      // No TS played yet, play the first one
      setTimeout(()=>playTS(nextTS,true),200);
    }
  }else{
    unlockNextChunk();
  }
}

function speakTTS(text,onEnd){
  if(!('speechSynthesis' in window)){onEnd();return}
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang='vi-VN';u.rate=.95;
  u.onend=onEnd;u.onerror=onEnd;
  speechSynthesis.speak(u);
}

function speak(text,lang='en-US'){
  if(!('speechSynthesis' in window))return;
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;u.rate=.85;
  speechSynthesis.speak(u);
}
window.speak=speak;

function startTimer(id,sec,onComplete){
  clearInterval(state.timer);
  state.timerCallback=onComplete;
  const box=document.getElementById(`${id}-timer`);
  const time=box.querySelector('.timer-time');
  box.classList.add('active');
  box.scrollIntoView({behavior:'smooth',block:'center'});
  let rem=sec;
  time.textContent=formatTime(rem);
  time.className='timer-time';
  state.timer=setInterval(()=>{
    rem--;time.textContent=formatTime(rem);
    if(rem<=10)time.classList.add('warning');
    if(rem<=5)time.classList.add('danger');
    if(rem<=0){
      clearInterval(state.timer);
      box.classList.remove('active');
      if(state.timerCallback)state.timerCallback();
    }
  },1000);
}

function skipTimer(id){
  clearInterval(state.timer);
  document.getElementById(`${id}-timer`).classList.remove('active');
  if(state.timerCallback)state.timerCallback();
}
window.skipTimer=skipTimer;

function formatTime(s){const m=Math.floor(s/60);return m>0?`${m}:${(s%60).toString().padStart(2,'0')}`:`${s}s`}

// Chunk Navigation
function setupNavigation(){
  // Lock scrolling initially
  document.body.style.overflow='hidden';

  // Add navigation buttons to each chunk
  document.querySelectorAll('.chunk').forEach((chunk,i)=>{
    const nav=document.createElement('div');
    nav.className='chunk-nav';
    nav.innerHTML=`<button class="nav-btn" id="nav-${i}" onclick="goNextChunk()" disabled>Ti·∫øp t·ª•c ‚Üí</button>`;
    chunk.appendChild(nav);
  });

  // Progress bar based on chunks
  updateProgress();
}

function activateChunk(idx){
  if(idx>=state.chunks.length)return;
  state.currentChunk=idx;

  document.querySelectorAll('.chunk').forEach((c,i)=>{
    c.classList.remove('current','completed');
    if(i<idx)c.classList.add('completed');
    if(i===idx)c.classList.add('current');
  });

  const chunk=document.getElementById(`chunk-${idx}`);
  if(chunk){
    chunk.scrollIntoView({behavior:'smooth',block:'start'});
    setTimeout(()=>{
      const firstTS=chunk.querySelector('.ts:not(.played)');
      if(firstTS){
        playTS(firstTS,true);
      }else{
        unlockNextChunk();
      }
    },600);
  }
  updateProgress();
}

function unlockNextChunk(){
  const btn=document.getElementById(`nav-${state.currentChunk}`);
  if(btn){btn.disabled=false;btn.classList.add('ready');}
}

function goNextChunk(){
  const nextIdx=state.currentChunk+1;
  if(nextIdx<state.chunks.length){
    activateChunk(nextIdx);
  }else{
    // Lesson complete
    showComplete();
  }
}
window.goNextChunk=goNextChunk;

function showComplete(){
  const content=document.getElementById('content');
  content.innerHTML+=`<div class="complete-box"><div class="complete-icon">üéâ</div><h2>Ho√†n th√†nh b√†i h·ªçc!</h2><p>Gi·ªèi l·∫Øm! V·ªÅ nh√† √¥n l·∫°i t·ª´ v·ª±ng nha.</p></div>`;
  document.querySelector('.complete-box').scrollIntoView({behavior:'smooth'});
}

function updateProgress(){
  const pct=((state.currentChunk+1)/state.chunks.length)*100;
  document.getElementById('progress-fill').style.width=pct+'%';
}

// Recording
let recorder=null,chunks=[];
async function toggleRec(id){
  const btn=document.getElementById(`${id}-rec`);
  const player=document.getElementById(`${id}-player`);
  if(recorder&&recorder.state==='recording'){recorder.stop();btn.classList.remove('recording');btn.querySelector('span').textContent='Ghi √¢m';return}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    recorder=new MediaRecorder(stream);chunks=[];
    recorder.ondataavailable=e=>chunks.push(e.data);
    recorder.onstop=async()=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      player.innerHTML=`<div class="audio-box"><audio controls src="${URL.createObjectURL(blob)}"></audio></div>`;
      await sendAudio(blob,`Ghi √¢m\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);
      stream.getTracks().forEach(t=>t.stop());
    };
    recorder.start();btn.classList.add('recording');btn.querySelector('span').textContent='D·ª´ng';
  }catch(e){alert('Kh√¥ng th·ªÉ ghi √¢m: '+e.message)}
}
window.toggleRec=toggleRec;

// Photo
async function captureHW(id){
  const div=document.getElementById(`${id}-photo`);
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    const modal=document.createElement('div');
    modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px';
    modal.innerHTML=`<video autoplay playsinline style="max-width:100%;max-height:70vh;border-radius:10px"></video><div style="margin-top:12px"><button class="gate-btn" id="hw-cap">Ch·ª•p</button><button class="gate-btn secondary" onclick="this.closest('div').parentElement.remove()">H·ªßy</button></div>`;
    document.body.appendChild(modal);
    modal.querySelector('video').srcObject=stream;
    modal.querySelector('#hw-cap').onclick=async()=>{
      const v=modal.querySelector('video');
      const c=document.createElement('canvas');c.width=v.videoWidth;c.height=v.videoHeight;
      c.getContext('2d').drawImage(v,0,0);
      const url=c.toDataURL('image/jpeg',.85);
      stream.getTracks().forEach(t=>t.stop());modal.remove();
      div.innerHTML=`<img src="${url}" style="max-width:100%;border-radius:8px;margin-top:8px">`;
      await sendPhoto(url,`B√†i l√†m\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);
    };
  }catch(e){alert('Kh√¥ng th·ªÉ m·ªü camera: '+e.message)}
}
window.captureHW=captureHW;

// Telegram
async function sendPhoto(data,caption){
  if(!CONFIG.tgToken||!CONFIG.tgChat)return;
  document.getElementById('sending').classList.add('active');
  try{
    const blob=await(await fetch(data)).blob();
    const fd=new FormData();fd.append('chat_id',CONFIG.tgChat);fd.append('photo',blob,'photo.jpg');fd.append('caption',caption);
    await fetch(`https://api.telegram.org/bot${CONFIG.tgToken}/sendPhoto`,{method:'POST',body:fd});
  }catch(e){}
  document.getElementById('sending').classList.remove('active');
}
async function sendAudio(blob,caption){
  if(!CONFIG.tgToken||!CONFIG.tgChat)return;
  document.getElementById('sending').classList.add('active');
  try{
    const fd=new FormData();fd.append('chat_id',CONFIG.tgChat);fd.append('voice',blob,'voice.ogg');fd.append('caption',caption);
    await fetch(`https://api.telegram.org/bot${CONFIG.tgToken}/sendVoice`,{method:'POST',body:fd});
  }catch(e){}
  document.getElementById('sending').classList.remove('active');
}

// ========== VOCABULARY INTERACTIVE SYSTEM ==========

function buildVocabInteractive(id,words){
  const progressDots=words.map((_,i)=>`<div class="vocab-progress-dot" id="${id}-dot-${i}"></div>`).join('');
  return`
<div class="vocab-interactive" id="${id}">
  <div class="vocab-progress">${progressDots}</div>

  <!-- Phase 1: Flash Cards -->
  <div class="vocab-phase active" id="${id}-phase-flashcard">
    <div class="phase-header">
      <span class="phase-icon">üé¥</span>
      <span class="phase-title">H·ªçc t·ª´ v·ª±ng</span>
      <span class="phase-count">T·ª´ <span id="${id}-fc-num">1</span>/${words.length}</span>
    </div>
    <div class="flashcard" id="${id}-flashcard">
      <div class="flashcard-front">
        <div class="flashcard-word" id="${id}-fc-word">${words[0].word}</div>
        <div class="flashcard-pron" id="${id}-fc-pron">${words[0].pron?'/'+words[0].pron+'/':''}</div>
        ${words[0].type?`<div class="flashcard-type" id="${id}-fc-type">${words[0].type}</div>`:'<div class="flashcard-type" id="${id}-fc-type" style="display:none"></div>'}
        <div class="flashcard-repeat">L·∫ßn ƒë·ªçc: <span id="${id}-rep-1">1</span><span id="${id}-rep-2">2</span><span id="${id}-rep-3">3</span></div>
      </div>
      <div class="flashcard-back">
        <div class="flashcard-word">${words[0].word}</div>
        <div class="flashcard-meaning" id="${id}-fc-meaning">${words[0].meaning}</div>
        <div class="flashcard-repeat">L·∫ßn ƒë·ªçc: <span id="${id}-rep-vi-1">1</span><span id="${id}-rep-vi-2">2</span><span id="${id}-rep-vi-3">3</span></div>
      </div>
    </div>
    <div class="vocab-nav">
      <button class="vocab-btn" id="${id}-fc-start" onclick="startFlashcard('${id}')">B·∫Øt ƒë·∫ßu h·ªçc</button>
    </div>
  </div>

  <!-- Phase 2: Quiz -->
  <div class="vocab-phase" id="${id}-phase-quiz">
    <div class="phase-header">
      <span class="phase-icon">‚ùì</span>
      <span class="phase-title">Ki·ªÉm tra nhanh</span>
      <span class="phase-count">C√¢u <span id="${id}-quiz-num">1</span>/${words.length}</span>
    </div>
    <div class="quiz-question">
      <div class="quiz-prompt" id="${id}-quiz-prompt">Ch·ªçn nghƒ©a ƒë√∫ng:</div>
      <div class="quiz-word" id="${id}-quiz-word">${words[0].word}</div>
    </div>
    <div class="quiz-options" id="${id}-quiz-options"></div>
  </div>

  <!-- Phase 3: Writing -->
  <div class="vocab-phase" id="${id}-phase-writing">
    <div class="phase-header">
      <span class="phase-icon">‚úçÔ∏è</span>
      <span class="phase-title">Ghi v√†o t·∫≠p</span>
      <span class="phase-count">${words.length} t·ª´</span>
    </div>
    <div class="writing-list" id="${id}-writing-list">
      ${words.map((w,i)=>`<div class="writing-item"><span class="writing-num">${i+1}</span><span class="writing-word">${w.word}</span><span class="writing-meaning">${w.meaning}</span></div>`).join('')}
    </div>
    <div class="writing-timer" id="${id}-writing-timer">
      <div class="writing-timer-label">Th·ªùi gian ghi b√†i</div>
      <div class="writing-timer-time" id="${id}-writing-time">2:00</div>
    </div>
    <div class="vocab-nav">
      <button class="vocab-btn secondary" onclick="skipWritingTimer('${id}')">Xong r·ªìi ‚Üí</button>
    </div>
  </div>

  <!-- Phase 4: Matching Game -->
  <div class="vocab-phase" id="${id}-phase-game">
    <div class="phase-header">
      <span class="phase-icon">üéÆ</span>
      <span class="phase-title">Game n·ªëi t·ª´</span>
      <span class="phase-count" id="${id}-game-score">0/${words.length}</span>
    </div>
    <div class="game-container" id="${id}-game-container">
      <div class="game-col">
        <div class="game-col-title">Ti·∫øng Anh</div>
        <div id="${id}-game-words"></div>
      </div>
      <div class="game-col">
        <div class="game-col-title">Ti·∫øng Vi·ªát</div>
        <div id="${id}-game-meanings"></div>
      </div>
    </div>
    <div class="game-score" id="${id}-game-result" style="display:none"></div>
  </div>

  <!-- Phase 5: Complete -->
  <div class="vocab-phase" id="${id}-phase-complete">
    <div class="complete-box" style="margin:0">
      <div class="complete-icon">üéâ</div>
      <h2>Ho√†n th√†nh t·ª´ v·ª±ng!</h2>
      <p>Gi·ªèi l·∫Øm! Nh·ªõ √¥n l·∫°i nha.</p>
    </div>
    <div class="vocab-nav">
      <button class="vocab-btn" onclick="finishVocab('${id}')">Ti·∫øp t·ª•c b√†i h·ªçc ‚Üí</button>
    </div>
  </div>
</div>`;
}

// Flash Card Phase
function startFlashcard(id){
  const inst=vocabState.instances[id];
  if(!inst)return;
  inst.currentWord=0;

  // Mark vocab as in-progress to block chunk advancement
  const vocabEl=document.getElementById(id);
  if(vocabEl)vocabEl.classList.add('vocab-in-progress');

  const startBtn=document.getElementById(`${id}-fc-start`);
  if(startBtn)startBtn.style.display='none';

  playFlashcardWord(id);
}
window.startFlashcard=startFlashcard;

async function playFlashcardWord(id){
  const inst=vocabState.instances[id];
  if(!inst||inst.currentWord>=inst.words.length)return;

  const w=inst.words[inst.currentWord];
  const card=document.getElementById(`${id}-flashcard`);
  if(!card)return;

  // Update card content with null checks
  const wordEl=document.getElementById(`${id}-fc-word`);
  const pronEl=document.getElementById(`${id}-fc-pron`);
  const typeEl=document.getElementById(`${id}-fc-type`);
  const meaningEl=document.getElementById(`${id}-fc-meaning`);
  const numEl=document.getElementById(`${id}-fc-num`);

  if(wordEl)wordEl.textContent=w.word;
  if(pronEl)pronEl.textContent=w.pron?'/'+w.pron+'/':'';
  if(typeEl){
    if(w.type){typeEl.textContent=w.type;typeEl.style.display='inline-block';}
    else{typeEl.style.display='none';}
  }
  if(meaningEl)meaningEl.textContent=w.meaning;
  if(numEl)numEl.textContent=inst.currentWord+1;

  // Reset state
  card.classList.remove('flip');
  ['1','2','3'].forEach(n=>{
    const repEl=document.getElementById(`${id}-rep-${n}`);
    const repViEl=document.getElementById(`${id}-rep-vi-${n}`);
    if(repEl)repEl.classList.remove('done');
    if(repViEl)repViEl.classList.remove('done');
  });

  // Update progress dots
  document.querySelectorAll(`#${id} .vocab-progress-dot`).forEach((dot,i)=>{
    dot.classList.remove('current','done');
    if(i<inst.currentWord)dot.classList.add('done');
    if(i===inst.currentWord)dot.classList.add('current');
  });

  card.classList.add('flashcard-speaking');

  // First word: announce "ƒë·ªçc theo nha"
  if(inst.currentWord===0){
    await speakAsync('ƒê·ªçc theo nha!','vi-VN');
    await delay(300);
  }

  // Read English 3 times with beep signal before each
  for(let i=1;i<=3;i++){
    await playRepeatSignal(); // Beep beep to signal "repeat after me"
    await delay(200);
    await speakAsync(w.word,'en-US');
    const repEl=document.getElementById(`${id}-rep-${i}`);
    if(repEl)repEl.classList.add('done');
    await delay(800); // Time for student to repeat
  }

  // Flip to show meaning
  await delay(400);
  card.classList.add('flip');
  await delay(500);

  // Short pause before Vietnamese
  await delay(300);

  // Read Vietnamese 3 times with beep signal
  for(let i=1;i<=3;i++){
    await playRepeatSignal();
    await delay(200);
    await speakAsync(w.meaning,'vi-VN');
    const repViEl=document.getElementById(`${id}-rep-vi-${i}`);
    if(repViEl)repViEl.classList.add('done');
    await delay(800); // Time for student to repeat
  }

  card.classList.remove('flashcard-speaking');

  // Move to next word or quiz phase
  await delay(600);
  inst.currentWord++;
  if(inst.currentWord<inst.words.length){
    await speakAsync('T·ª´ ti·∫øp theo','vi-VN');
    await delay(300);
    playFlashcardWord(id);
  }else{
    // Done with flashcards, go to quiz
    document.querySelectorAll(`#${id} .vocab-progress-dot`).forEach(dot=>dot.classList.add('done'));
    await speakAsync('Xong ph·∫ßn h·ªçc t·ª´. Gi·ªù ki·ªÉm tra nhanh nha!','vi-VN');
    await delay(500);
    startQuizPhase(id);
  }
}

// Quiz Phase
function startQuizPhase(id){
  const inst=vocabState.instances[id];
  inst.phase='quiz';
  inst.currentWord=0;
  inst.quizAnswers=[];

  document.getElementById(`${id}-phase-flashcard`).classList.remove('active');
  document.getElementById(`${id}-phase-quiz`).classList.add('active');

  showQuizQuestion(id);
}

async function showQuizQuestion(id){
  const inst=vocabState.instances[id];
  const w=inst.words[inst.currentWord];
  const qTypes=['meaning','spelling','type'];
  // Pick random question type (but only type if word has type)
  let availTypes=w.type?qTypes:qTypes.slice(0,2);
  const qType=availTypes[Math.floor(Math.random()*availTypes.length)];

  document.getElementById(`${id}-quiz-num`).textContent=inst.currentWord+1;

  let prompt,questionWord,correctAnswer,options=[],voicePrompt='';

  if(qType==='meaning'){
    prompt='Ch·ªçn nghƒ©a ƒë√∫ng c·ªßa t·ª´:';
    questionWord=w.word;
    correctAnswer=w.meaning;
    voicePrompt=`C√¢u ${inst.currentWord+1}. T·ª´ "${w.word}" nghƒ©a l√† g√¨?`;
    const others=inst.words.filter((_,i)=>i!==inst.currentWord).map(x=>x.meaning);
    shuffle(others);
    options=[correctAnswer,...others.slice(0,3)];
  }else if(qType==='spelling'){
    prompt='T·ª´ n√†o vi·∫øt ƒë√∫ng cho nghƒ©a:';
    questionWord=w.meaning;
    correctAnswer=w.word;
    voicePrompt=`C√¢u ${inst.currentWord+1}. "${w.meaning}" ti·∫øng Anh vi·∫øt nh∆∞ th·∫ø n√†o?`;
    const others=inst.words.filter((_,i)=>i!==inst.currentWord).map(x=>x.word);
    shuffle(others);
    options=[correctAnswer,...others.slice(0,3)];
  }else{
    prompt='T·ª´ "'+w.word+'" thu·ªôc lo·∫°i t·ª´ n√†o?';
    questionWord='';
    correctAnswer=w.type;
    voicePrompt=`C√¢u ${inst.currentWord+1}. T·ª´ "${w.word}" thu·ªôc lo·∫°i t·ª´ n√†o?`;
    options=[correctAnswer,'n','v','adj','adv','phrase'].filter((v,i,a)=>a.indexOf(v)===i).slice(0,4);
  }

  shuffle(options);

  document.getElementById(`${id}-quiz-prompt`).textContent=prompt;
  document.getElementById(`${id}-quiz-word`).textContent=questionWord;

  const optContainer=document.getElementById(`${id}-quiz-options`);
  optContainer.innerHTML=options.map(opt=>`<div class="quiz-option" data-answer="${opt.replace(/"/g,'&quot;')}" onclick="selectQuizOption('${id}',this,'${correctAnswer.replace(/'/g,"\\'")}')">${opt}</div>`).join('');

  // Voice prompt for the question
  await playBeep(660,100);
  await speakAsync(voicePrompt,'vi-VN');
}

async function selectQuizOption(id,el,correct){
  const inst=vocabState.instances[id];
  const selected=el.dataset.answer;

  // Disable all options
  document.querySelectorAll(`#${id}-quiz-options .quiz-option`).forEach(opt=>{
    opt.style.pointerEvents='none';
    if(opt.dataset.answer===correct)opt.classList.add('correct');
  });

  if(selected===correct){
    el.classList.add('correct');
    inst.quizAnswers.push(true);
    await playBeep(880,150);
    await playBeep(1100,200);
    speakAsync('ƒê√∫ng r·ªìi!','vi-VN');
  }else{
    el.classList.add('wrong');
    inst.quizAnswers.push(false);
    await playBeep(300,300);
    speakAsync(`Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√†: ${correct}`,'vi-VN');
  }

  // Next question after delay
  setTimeout(()=>{
    inst.currentWord++;
    if(inst.currentWord<inst.words.length){
      showQuizQuestion(id);
    }else{
      startWritingPhase(id);
    }
  },2000);
}
window.selectQuizOption=selectQuizOption;

// Writing Phase
function startWritingPhase(id){
  const inst=vocabState.instances[id];
  inst.phase='writing';

  document.getElementById(`${id}-phase-quiz`).classList.remove('active');
  document.getElementById(`${id}-phase-writing`).classList.add('active');

  // Start timer (2 minutes = 120 seconds)
  let timeLeft=120;
  const timeEl=document.getElementById(`${id}-writing-time`);

  inst.writingTimer=setInterval(()=>{
    timeLeft--;
    const m=Math.floor(timeLeft/60);
    const s=timeLeft%60;
    timeEl.textContent=`${m}:${s.toString().padStart(2,'0')}`;

    if(timeLeft<=0){
      clearInterval(inst.writingTimer);
      startGamePhase(id);
    }
  },1000);

  // Speak instruction
  speakAsync('Gi·ªù ghi t·ª´ v·ª±ng v√†o t·∫≠p nha. 2 ph√∫t.','vi-VN');
}

function skipWritingTimer(id){
  const inst=vocabState.instances[id];
  if(inst.writingTimer)clearInterval(inst.writingTimer);
  startGamePhase(id);
}
window.skipWritingTimer=skipWritingTimer;

// Game Phase
function startGamePhase(id){
  const inst=vocabState.instances[id];
  inst.phase='game';
  inst.gameMatched=0;
  inst.gameSelected=null;

  document.getElementById(`${id}-phase-writing`).classList.remove('active');
  document.getElementById(`${id}-phase-game`).classList.add('active');

  // Build game items
  const words=[...inst.words];
  const meanings=[...inst.words];
  shuffle(words);
  shuffle(meanings);

  const wordsHtml=words.map((w,i)=>`<div class="game-item" data-word="${w.word.replace(/"/g,'&quot;')}" data-type="word" onclick="selectGameItem('${id}',this)">${w.word}</div>`).join('');
  const meaningsHtml=meanings.map((w,i)=>`<div class="game-item" data-word="${w.word.replace(/"/g,'&quot;')}" data-type="meaning" onclick="selectGameItem('${id}',this)">${w.meaning}</div>`).join('');

  document.getElementById(`${id}-game-words`).innerHTML=wordsHtml;
  document.getElementById(`${id}-game-meanings`).innerHTML=meaningsHtml;
  document.getElementById(`${id}-game-score`).textContent=`0/${inst.words.length}`;

  speakAsync('Ch∆°i game n·ªëi t·ª´ nha. Ch·ªçn t·ª´ ti·∫øng Anh r·ªìi ch·ªçn nghƒ©a ti·∫øng Vi·ªát.','vi-VN');
}

async function selectGameItem(id,el){
  const inst=vocabState.instances[id];
  if(el.classList.contains('matched'))return;

  const type=el.dataset.type;
  const word=el.dataset.word;

  // Play click sound
  playBeep(500,50);

  if(!inst.gameSelected){
    // First selection
    inst.gameSelected={el,type,word};
    el.classList.add('selected');
  }else{
    // Second selection
    if(inst.gameSelected.type===type){
      // Same column - switch selection
      inst.gameSelected.el.classList.remove('selected');
      inst.gameSelected={el,type,word};
      el.classList.add('selected');
    }else{
      // Different columns - check match
      if(inst.gameSelected.word===word){
        // Match!
        inst.gameSelected.el.classList.remove('selected');
        inst.gameSelected.el.classList.add('matched');
        el.classList.add('matched');
        inst.gameMatched++;
        document.getElementById(`${id}-game-score`).textContent=`${inst.gameMatched}/${inst.words.length}`;

        // Success sound
        await playBeep(660,100);
        await playBeep(880,100);
        await playBeep(1100,150);

        if(inst.gameMatched===inst.words.length){
          // Game complete
          setTimeout(async()=>{
            document.getElementById(`${id}-game-result`).style.display='block';
            document.getElementById(`${id}-game-result`).textContent='üéâ Xu·∫•t s·∫Øc! N·ªëi ƒë√∫ng h·∫øt!';
            await speakAsync('Xu·∫•t s·∫Øc! N·ªëi ƒë√∫ng h·∫øt r·ªìi!','vi-VN');
            setTimeout(()=>completeVocab(id),1000);
          },500);
        }
      }else{
        // Wrong match - error sound
        await playBeep(300,200);
        inst.gameSelected.el.classList.add('wrong');
        el.classList.add('wrong');
        setTimeout(()=>{
          inst.gameSelected.el.classList.remove('selected','wrong');
          el.classList.remove('wrong');
          inst.gameSelected=null;
        },500);
        return;
      }
      inst.gameSelected=null;
    }
  }
}
window.selectGameItem=selectGameItem;

// Complete Vocab
function completeVocab(id){
  document.getElementById(`${id}-phase-game`).classList.remove('active');
  document.getElementById(`${id}-phase-complete`).classList.add('active');
  speakAsync('Ho√†n th√†nh t·ª´ v·ª±ng r·ªìi! Gi·ªèi l·∫Øm!','vi-VN');
}

function finishVocab(id){
  const vocabEl=document.getElementById(id);
  if(vocabEl){
    vocabEl.classList.remove('vocab-in-progress');
    vocabEl.classList.add('vocab-completed');
  }

  // Resume teacher script playback - continue with remaining TS in chunk
  setTimeout(()=>{
    playNextTS();
  },500);
}
window.finishVocab=finishVocab;

// Helper functions
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function delay(ms){return new Promise(r=>setTimeout(r,ms));}

function speakAsync(text,lang='en-US'){
  return new Promise(resolve=>{
    if(!('speechSynthesis' in window)){resolve();return;}
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    u.lang=lang;
    u.rate=lang==='vi-VN'?1:0.85;
    u.onend=resolve;
    u.onerror=resolve;
    speechSynthesis.speak(u);
  });
}

// Audio beep for signaling
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function playBeep(freq=880,duration=150,type='sine'){
  return new Promise(resolve=>{
    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value=freq;
    osc.type=type;
    gain.gain.setValueAtTime(0.3,audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+duration/1000);
    osc.start();
    osc.stop(audioCtx.currentTime+duration/1000);
    setTimeout(resolve,duration);
  });
}

// Double beep signal for "repeat after me"
async function playRepeatSignal(){
  await playBeep(880,100);
  await delay(80);
  await playBeep(1100,100);
}
</script>
</body>
</html>
