<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Voice Lecture</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--primary:#0ea5e9;--primary-dark:#0284c7;--accent:#06b6d4;--success:#10b981;--warning:#f59e0b;--bg:#f0f9ff;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e0f2fe;--radius:12px;--safe-bottom:env(safe-area-inset-bottom,0)}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(180deg,#f0f9ff 0%,#e0f2fe 100%);color:var(--text);line-height:1.6;font-size:16px;min-height:100vh}

    /* Header - Ocean Blue */
    header{background:linear-gradient(135deg,#0284c7,#0ea5e9);color:#fff;padding:12px 16px;padding-top:calc(12px + env(safe-area-inset-top,0));position:fixed;top:0;left:0;right:0;z-index:100;display:flex;align-items:center;gap:12px;box-shadow:0 2px 12px rgba(14,165,233,.3)}
    header h1{font-size:.95rem;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #progress{height:4px;background:rgba(255,255,255,.3);position:absolute;bottom:0;left:0;right:0;border-radius:2px}
    #progress-fill{height:100%;background:#fff;width:0%;transition:width .3s;border-radius:2px}

    /* Content */
    #content{padding:68px 16px 100px;max-width:640px;margin:0 auto}

    /* Chunks - Clear sections */
    .chunk{padding:20px 0;border-bottom:2px dashed #bae6fd}
    .chunk:last-child{border-bottom:none}
    .chunk-title{font-size:.7rem;color:#0369a1;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;font-weight:600;background:#e0f2fe;display:inline-block;padding:4px 10px;border-radius:20px}

    /* Typography */
    h1{font-size:1.25rem;margin:12px 0 8px;color:#0c4a6e}
    h2{font-size:1.1rem;margin:16px 0 8px;color:#0369a1;font-weight:700}
    h3{font-size:1rem;margin:12px 0 6px;font-weight:600;color:#075985}
    p{margin:6px 0}
    strong{color:#0284c7}
    em{color:var(--muted);font-style:normal}

    /* Teacher Script - Ocean style */
    .ts{display:flex;align-items:center;gap:10px;padding:12px 14px;margin:10px 0;background:linear-gradient(135deg,#e0f2fe,#bae6fd);border-radius:50px;border:2px solid #7dd3fc;cursor:pointer;transition:all .2s}
    .ts:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(14,165,233,.25)}
    .ts.speaking{background:linear-gradient(135deg,#bae6fd,#7dd3fc);border-color:#0ea5e9;animation:glow 1.5s ease-in-out infinite}
    .ts.played{opacity:.6;border-style:dashed}
    .ts-icon{font-size:1.3rem;animation:none}
    .ts.speaking .ts-icon{animation:bounce .5s ease infinite}
    .ts-label{flex:1;font-size:.9rem;color:#0369a1;font-weight:500}
    .ts-status{font-size:.75rem;padding:4px 10px;background:#fff;border-radius:20px;color:#0369a1;font-weight:500}
    .ts.speaking .ts-status{background:#0ea5e9;color:#fff}
    @keyframes glow{0%,100%{box-shadow:0 0 8px rgba(14,165,233,.3)}50%{box-shadow:0 0 20px rgba(14,165,233,.5)}}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

    /* Timer - Deep ocean */
    .timer{background:linear-gradient(135deg,#0c4a6e,#075985);color:#fff;padding:16px;border-radius:16px;margin:10px 0;text-align:center;display:none;box-shadow:0 4px 12px rgba(12,74,110,.3)}
    .timer.active{display:block}
    .timer-label{font-size:.8rem;opacity:.8;margin-bottom:4px}
    .timer-time{font-size:2.5rem;font-weight:700}
    .timer-time.warning{color:#fcd34d}
    .timer-time.danger{color:#fca5a5;animation:pulse 1s infinite}
    @keyframes pulse{50%{opacity:.6}}
    .timer-skip{background:rgba(255,255,255,.2);border:none;color:#fff;padding:10px 20px;border-radius:25px;margin-top:10px;cursor:pointer;font-weight:500;transition:background .2s}
    .timer-skip:hover{background:rgba(255,255,255,.3)}

    /* Cards - Clean shadows */
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.06);border:1px solid var(--border)}
    .task-box{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-left:4px solid var(--primary);border:none}
    .answer-box{background:linear-gradient(135deg,#ecfdf5,#d1fae5);border-left:4px solid var(--success);border:none}
    .explanation-box{background:linear-gradient(135deg,#fffbeb,#fef3c7);border-left:4px solid var(--warning);border:none}
    .grammar-box{background:linear-gradient(135deg,#f5f3ff,#ede9fe);border-left:4px solid #8b5cf6;border:none}
    .translation-box{background:linear-gradient(135deg,#ecfeff,#cffafe);border-left:4px solid var(--accent);border:none}
    .dialogue-box{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-left:4px solid var(--success);border:none}

    /* Vocabulary - Ocean cards */
    .vocab-list{display:flex;flex-direction:column;gap:8px}
    .vocab-item{padding:12px;background:linear-gradient(135deg,#fff,#f0f9ff);border-radius:10px;cursor:pointer;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border:1px solid #bae6fd;transition:all .2s}
    .vocab-item:hover{transform:translateX(4px);box-shadow:0 2px 8px rgba(14,165,233,.15);border-color:#0ea5e9}
    .vocab-item:active{transform:scale(.98)}
    .vocab-word{font-weight:700;color:#0284c7;font-size:1rem}
    .vocab-type{font-size:.65rem;background:#e0f2fe;padding:2px 8px;border-radius:10px;color:#0369a1;font-weight:600;text-transform:uppercase}
    .vocab-meaning{flex:1 1 100%;font-size:.9rem;margin-top:4px;color:#475569}
    .vocab-pron{font-size:.8rem;color:#0369a1;background:#e0f2fe;padding:3px 8px;border-radius:8px;font-family:monospace}
    @media(min-width:400px){.vocab-meaning{flex:1;margin-top:0}}

    /* Tables */
    .table-wrap{overflow-x:auto;margin:10px 0;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    table{width:100%;border-collapse:collapse;font-size:.85rem;background:#fff}
    th,td{padding:10px 12px;border:1px solid var(--border);text-align:left}
    th{background:linear-gradient(135deg,#e0f2fe,#bae6fd);font-weight:600;font-size:.8rem;color:#0369a1}

    /* Lists */
    ul{margin:8px 0;padding-left:20px}
    li{margin:4px 0}

    /* Action buttons */
    .action-row{display:flex;gap:10px;margin:12px 0}
    .action-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;border:2px solid #7dd3fc;border-radius:12px;background:linear-gradient(135deg,#fff,#f0f9ff);cursor:pointer;min-height:52px;font-weight:500;color:#0369a1;transition:all .2s}
    .action-btn:hover{border-color:#0ea5e9;background:linear-gradient(135deg,#e0f2fe,#bae6fd);transform:scale(1.02)}
    .action-btn.recording{border-color:#ef4444;background:linear-gradient(135deg,#fef2f2,#fee2e2);animation:pulse 1s infinite;color:#dc2626}
    .action-btn svg{width:22px;height:22px}

    /* Audio */
    .audio-box{background:linear-gradient(135deg,#0c4a6e,#075985);padding:14px;border-radius:12px;margin:10px 0;box-shadow:0 4px 12px rgba(12,74,110,.2)}
    .audio-box audio{width:100%;border-radius:8px}
    .audio-placeholder{background:rgba(255,255,255,.1);color:#bae6fd;padding:18px;border-radius:8px;text-align:center;font-size:.9rem}

    /* Camera gate - Ocean theme */
    #gate{position:fixed;inset:0;background:linear-gradient(135deg,#0c4a6e,#0369a1,#0ea5e9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;padding:20px}
    #gate.hidden{display:none}
    #gate h1{color:#fff;margin-bottom:8px;font-size:1.5rem}
    #gate p{color:rgba(255,255,255,.9);margin-bottom:16px;text-align:center}
    #gate video,#gate img{width:100%;max-width:240px;aspect-ratio:4/3;object-fit:cover;border-radius:14px;background:#000;border:3px solid rgba(255,255,255,.3)}
    .gate-input{width:100%;max-width:240px;padding:14px;border:2px solid rgba(255,255,255,.4);border-radius:12px;background:rgba(255,255,255,.15);color:#fff;font-size:1rem;margin:12px 0;text-align:center}
    .gate-input::placeholder{color:rgba(255,255,255,.7)}
    .gate-btn{background:#fff;color:#0369a1;border:none;padding:14px 28px;border-radius:50px;font-size:1rem;font-weight:600;cursor:pointer;margin:4px;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s}
    .gate-btn:hover{transform:scale(1.05)}
    .gate-btn.secondary{background:transparent;color:#fff;border:2px solid rgba(255,255,255,.5);box-shadow:none}

    /* Sending */
    .sending{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#0c4a6e,#075985);color:#fff;padding:18px 32px;border-radius:16px;z-index:1001;display:none;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    .sending.active{display:flex;align-items:center;gap:12px}
    .spinner{width:22px;height:22px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Current chunk highlight */
    .chunk{opacity:.4;pointer-events:none;transition:all .3s}
    .chunk.current{opacity:1;pointer-events:auto;background:rgba(224,242,254,.6);border-radius:16px;margin:0 -12px;padding:20px 12px;box-shadow:0 4px 20px rgba(14,165,233,.15)}
    .chunk.completed{opacity:.7;pointer-events:auto}

    /* Chunk Navigation */
    .chunk-nav{margin-top:16px;text-align:center}
    .nav-btn{background:linear-gradient(135deg,#cbd5e1,#94a3b8);color:#fff;border:none;padding:14px 32px;border-radius:50px;font-size:1rem;font-weight:600;cursor:not-allowed;opacity:.5;transition:all .3s}
    .nav-btn.ready{background:linear-gradient(135deg,#0ea5e9,#0284c7);opacity:1;cursor:pointer;animation:readyPulse 2s ease infinite;box-shadow:0 4px 16px rgba(14,165,233,.4)}
    .nav-btn.ready:hover{transform:scale(1.05)}
    @keyframes readyPulse{0%,100%{box-shadow:0 4px 16px rgba(14,165,233,.4)}50%{box-shadow:0 4px 24px rgba(14,165,233,.6)}}

    /* Complete Box */
    .complete-box{background:linear-gradient(135deg,#e0f2fe,#bae6fd);border-radius:20px;padding:32px;text-align:center;margin:20px 0;box-shadow:0 8px 32px rgba(14,165,233,.2)}
    .complete-icon{font-size:4rem;margin-bottom:12px}
    .complete-box h2{color:#0369a1;margin-bottom:8px}
    .complete-box p{color:#075985}

    /* Scrollbar hide for locked mode */
    body::-webkit-scrollbar{display:none}
    body{-ms-overflow-style:none;scrollbar-width:none}
  </style>
</head>
<body>
  <div id="gate">
    <h1>ƒêi·ªÉm danh</h1>
    <p>Nh·∫≠p t√™n v√† ch·ª•p ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
    <input type="text" id="student-name" class="gate-input" placeholder="T√™n c·ªßa b·∫°n...">
    <video id="cam-video" autoplay playsinline muted></video>
    <div style="margin-top:12px">
      <button class="gate-btn" id="capture-btn" disabled>Ch·ª•p ·∫£nh</button>
      <button class="gate-btn secondary" id="skip-btn">B·ªè qua</button>
    </div>
  </div>

  <header>
    <h1 id="title">Voice Lecture</h1>
    <div id="progress"><div id="progress-fill"></div></div>
  </header>


  <div id="content"></div>

  <div class="sending" id="sending"><div class="spinner"></div> ƒêang g·ª≠i...</div>
  <canvas id="canvas" style="display:none"></canvas>

<script>
const CONFIG={contentUrl:null,tgToken:null,tgChat:null,audioBase:null,skip:false};
const state={chunks:[],name:'',photo:null,speaking:false,timer:null,currentChunk:0,tsQueue:[],locked:true};

// Init
document.addEventListener('DOMContentLoaded',()=>{
  parseParams();
  if(CONFIG.skip){document.getElementById('gate').classList.add('hidden');load();}
  else initCamera();
});

function parseParams(){
  const p=new URLSearchParams(location.search);
  const c=p.get('c');
  if(c)try{CONFIG.contentUrl=decodeURIComponent(atob(c))}catch{CONFIG.contentUrl=decodeURIComponent(c)}
  CONFIG.tgToken=p.get('token')||p.get('tg_token');
  CONFIG.tgChat=p.get('chat')||p.get('tg_chat');
  CONFIG.audioBase=p.get('audio');
  CONFIG.skip=p.get('skip')==='1';
}

// Camera
async function initCamera(){
  const video=document.getElementById('cam-video');
  const capBtn=document.getElementById('capture-btn');
  const skipBtn=document.getElementById('skip-btn');

  skipBtn.onclick=()=>{state.name=document.getElementById('student-name').value||'H·ªçc sinh';document.getElementById('gate').classList.add('hidden');load()};

  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:480}},audio:false});
    video.srcObject=stream;
    capBtn.disabled=false;
    capBtn.onclick=()=>{
      state.name=document.getElementById('student-name').value||'H·ªçc sinh';
      const canvas=document.getElementById('canvas');
      canvas.width=video.videoWidth;canvas.height=video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      state.photo=canvas.toDataURL('image/jpeg',.8);
      video.style.display='none';
      const img=document.createElement('img');img.src=state.photo;
      video.parentNode.insertBefore(img,video);
      capBtn.textContent='V√†o h·ªçc';
      capBtn.onclick=async()=>{stream.getTracks().forEach(t=>t.stop());await sendPhoto(state.photo,`ƒêi·ªÉm danh\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);document.getElementById('gate').classList.add('hidden');load()};
    };
  }catch(e){capBtn.style.display='none'}
}

// Load content
async function load(){
  if(!CONFIG.contentUrl)return;
  try{
    const res=await fetch(CONFIG.contentUrl);
    const md=await res.text();
    parse(md);
    render();
    setupNavigation();
    // Start from first chunk
    setTimeout(()=>activateChunk(0),500);
  }catch(e){document.getElementById('content').innerHTML=`<div class="card" style="color:#ef4444">L·ªói: ${e.message}</div>`}
}

function parse(md){
  const titleMatch=md.match(/^#\s+(.+)$/m);
  if(titleMatch)document.getElementById('title').textContent=titleMatch[1];

  // Split by chunk comments
  const parts=md.split(/(?=<!--\s*chunk:)/);
  state.chunks=parts.map(p=>{
    const nameMatch=p.match(/<!--\s*chunk:\s*(\w+)/);
    const h3Match=p.match(/^###\s+(.+)$/m);
    return{
      id:nameMatch?nameMatch[1]:'chunk',
      title:h3Match?h3Match[1]:(nameMatch?nameMatch[1]:''),
      content:p.replace(/<!--\s*chunk:.*?-->/gs,'').replace(/\n---\n/g,'\n').replace(/^---$/gm,'').trim()
    };
  }).filter(c=>c.content.length>20);
}

function render(){
  console.log('RENDER: processing',state.chunks.length,'chunks');
  let html='';
  state.chunks.forEach((chunk,i)=>{
    console.log(`CHUNK ${i}: id="${chunk.id}", content length=${chunk.content.length}`);
    html+=`<div class="chunk" id="chunk-${i}" data-idx="${i}">`;
    if(chunk.title)html+=`<div class="chunk-title">${chunk.title}</div>`;
    const rendered=renderContent(chunk.content);
    html+=rendered;
    html+=`</div>`;
  });
  document.getElementById('content').innerHTML=html;
  // After render, count vocab items
  const vocabItems=document.querySelectorAll('.vocab-item');
  console.log('FINAL: Found',vocabItems.length,'vocab-item elements in DOM');
}

function renderContent(md){
  let h=md;
  // Custom tags - VOCABULARY with flexible parsing
  h=h.replace(/<vocabulary>([\s\S]*?)<\/vocabulary>/gi,(_,c)=>{
    let items='';
    let count=0;
    c.trim().split('\n').forEach(line=>{
      // Match: number. **word** : rest
      const baseMatch=line.match(/^\d+\.\s*\*\*(.+?)\*\*\s*:\s*(.+)$/);
      if(baseMatch){
        count++;
        const word=baseMatch[1];
        let rest=baseMatch[2].trim();
        // Extract optional (type) at start
        let type=null;
        const typeMatch=rest.match(/^\(([^)]+)\)\s*/);
        if(typeMatch){type=typeMatch[1];rest=rest.slice(typeMatch[0].length);}
        // Extract optional /pron/ at end
        let pron=null;
        const pronMatch=rest.match(/\s*\/([^\/]+)\/$/);
        if(pronMatch){pron=pronMatch[1];rest=rest.slice(0,-pronMatch[0].length);}
        const meaning=rest.trim();
        if(word&&meaning)items+=`<div class="vocab-item" onclick="speak('${word.replace(/'/g,"\\'")}','en-US')"><span class="vocab-word">${word}</span>${type?`<span class="vocab-type">${type}</span>`:''}<span class="vocab-meaning">${meaning}</span>${pron?`<span class="vocab-pron">/${pron}/</span>`:''}</div>`;
      }
    });
    console.log('VOCAB: parsed',count,'items, HTML length:',items.length);
    const result=items?`<div class="card vocab-list">${items}</div>`:'';
    console.log('VOCAB HTML preview:',result.substring(0,500));
    return result;
  });

  // TEACHER SCRIPT - Hide text, show friendly label
  h=h.replace(/<teacher_script([^>]*)>([\s\S]*?)<\/teacher_script>/gi,(_,attrs,text)=>{
    const pause=(attrs.match(/pause="(\d+)"/)||[])[1]||'0';
    const href=(attrs.match(/href="([^"]+)"/)||[])[1]||'';
    const action=(attrs.match(/action="(\w+)"/)||[])[1]||'';
    const id='ts'+Math.random().toString(36).slice(2,8);
    let actionHtml='';
    if(action==='record')actionHtml=`<div class="action-row"><button class="action-btn" id="${id}-rec" onclick="toggleRec('${id}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg><span>Ghi √¢m</span></button></div><div id="${id}-player"></div>`;
    if(action==='photo')actionHtml=`<div class="action-row"><button class="action-btn" onclick="captureHW('${id}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg><span>Ch·ª•p b√†i</span></button></div><div id="${id}-photo"></div>`;
    // Friendly label instead of showing script text
    const label=action==='record'?'Ghi √¢m g·ª≠i th·∫ßy n√®...':action==='photo'?'Ch·ª•p b√†i g·ª≠i th·∫ßy n√®...':'Nghe th·∫ßy n√≥i n√®...';
    return`<div class="ts" id="${id}" data-text="${text.trim().replace(/"/g,'&quot;')}" data-pause="${pause}" data-href="${href}" onclick="playTS(this)"><span class="ts-icon">üéì</span><span class="ts-label">${label}</span><span class="ts-status">B·∫•m nghe</span></div><div class="timer" id="${id}-timer"><div class="timer-label">Th·ªùi gian l√†m b√†i</div><div class="timer-time">${formatTime(pause)}</div><button class="timer-skip" onclick="skipTimer('${id}')">Xong r·ªìi ‚Üí</button></div>${actionHtml}`;
  });

  h=h.replace(/<task>([\s\S]*?)<\/task>/gi,(_,c)=>`<div class="card task-box">${renderMD(c)}</div>`);
  h=h.replace(/<answer>([\s\S]*?)<\/answer>/gi,(_,c)=>`<div class="card answer-box">${renderMD(c)}</div>`);
  h=h.replace(/<explanation>([\s\S]*?)<\/explanation>/gi,(_,c)=>`<div class="card explanation-box">${renderMD(c)}</div>`);
  h=h.replace(/<grammar>([\s\S]*?)<\/grammar>/gi,(_,c)=>`<div class="card grammar-box">${renderMD(c)}</div>`);
  h=h.replace(/<dialogue>([\s\S]*?)<\/dialogue>/gi,(_,c)=>`<div class="card dialogue-box">${renderMD(c)}</div>`);
  h=h.replace(/<translation>([\s\S]*?)<\/translation>/gi,(_,c)=>`<div class="card translation-box">${renderMD(c)}</div>`);
  h=h.replace(/<reading>([\s\S]*?)<\/reading>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<questions[^>]*>([\s\S]*?)<\/questions>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<pronunciation_theory>([\s\S]*?)<\/pronunciation_theory>/gi,(_,c)=>`<div class="card grammar-box">${renderMD(c)}</div>`);
  h=h.replace(/<content_table>([\s\S]*?)<\/content_table>/gi,(_,c)=>`<div class="card">${renderMD(c)}</div>`);
  h=h.replace(/<audio\s+src="([^"]*)"[^>]*>([\s\S]*?)<\/audio>/gi,(_,src,label)=>src.includes('TODO')?`<div class="audio-box"><div class="audio-placeholder">üîá ${label||'Audio ch∆∞a s·∫µn s√†ng'}</div></div>`:`<div class="audio-box"><audio controls src="${src}"></audio></div>`);

  return renderMD(h);
}

function renderMD(md){
  let h=md;
  h=h.replace(/^###\s+(.+)$/gm,'<h3>$1</h3>');
  h=h.replace(/^##\s+(.+)$/gm,'<h2>$1</h2>');
  h=h.replace(/^#\s+(.+)$/gm,'<h1>$1</h1>');
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*([^*]+)\*/g,'<em>$1</em>');

  // Tables - collect all matches first, then replace from end to preserve indices
  const tableRegex=/^(\|[^\n]+\|[ \t]*\n?)+/gm;
  const matches=[];
  let match;
  while((match=tableRegex.exec(h))!==null){
    matches.push({str:match[0],idx:match.index});
  }
  // Replace from end to start so indices stay valid
  for(let i=matches.length-1;i>=0;i--){
    const{str:tableStr,idx}=matches[i];
    const lines=tableStr.trim().split('\n').map(l=>l.trim()).filter(l=>l);
    const dataRows=lines.filter(line=>!/^\|[\s\-:|]+\|$/.test(line));
    if(dataRows.length>0){
      let tbl='<div class="table-wrap"><table>';
      dataRows.forEach((row,ri)=>{
        const parts=row.split('|');
        const cells=parts.slice(1,parts.length-1);
        const tag=ri===0?'th':'td';
        tbl+='<tr>'+cells.map(c=>`<${tag}>${c.trim()}</${tag}>`).join('')+'</tr>';
      });
      tbl+='</table></div>';
      h=h.substring(0,idx)+tbl+h.substring(idx+tableStr.length);
    }
  }

  h=h.replace(/^-\s+(.+)$/gm,'<li>$1</li>');
  h=h.replace(/(<li>.*<\/li>\n?)+/g,'<ul>$&</ul>');
  h=h.replace(/\n\n+/g,'</p><p>');
  h=h.replace(/\n/g,'<br>');
  return h;
}

// TTS - Sequential playback
function playTS(el,auto=false){
  if(state.speaking&&!auto)return;
  if(state.speaking&&auto){state.tsQueue.push(el);return;}

  const text=el.dataset.text;
  const pause=parseInt(el.dataset.pause)||0;
  const href=el.dataset.href;

  document.querySelectorAll('.ts').forEach(e=>{e.classList.remove('speaking');const s=e.querySelector('.ts-status');if(s)s.textContent='Xong ‚úì'});
  el.classList.add('speaking');
  el.classList.add('played');
  const status=el.querySelector('.ts-status');
  if(status)status.textContent='ƒêang n√≥i...';
  state.speaking=true;

  // Scroll element into view
  el.scrollIntoView({behavior:'smooth',block:'center'});

  const onEnd=()=>{
    console.log('Script finished:',el.id,'pause:',pause);
    state.speaking=false;
    el.classList.remove('speaking');
    if(status)status.textContent='Xong ‚úì';

    if(pause>0){
      startTimer(el.id,pause,()=>{
        console.log('Timer ended, calling playNextTS');
        playNextTS();
      });
    }else{
      // Small delay then play next
      console.log('No pause, calling playNextTS in 400ms');
      setTimeout(()=>playNextTS(),400);
    }
  };

  if(href){
    const audio=new Audio(href);
    audio.onended=onEnd;
    audio.onerror=()=>speakTTS(text,onEnd);
    audio.play().catch(()=>speakTTS(text,onEnd));
  }else{
    speakTTS(text,onEnd);
  }
}
window.playTS=playTS;

function playNextTS(){
  // Find next unplayed TS in current chunk
  const chunk=document.getElementById(`chunk-${state.currentChunk}`);
  if(!chunk){console.log('No chunk found');return;}

  // Get all scripts in order
  const allTS=Array.from(chunk.querySelectorAll('.ts'));
  const nextTS=allTS.find(ts=>!ts.classList.contains('played'));

  console.log('playNextTS: found',allTS.length,'scripts,','next:',nextTS?.id);

  if(nextTS){
    setTimeout(()=>playTS(nextTS,true),200);
  }else{
    // Chunk complete - enable next button
    console.log('Chunk',state.currentChunk,'complete!');
    unlockNextChunk();
  }
}

function speakTTS(text,onEnd){
  if(!('speechSynthesis' in window)){onEnd();return}
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang='vi-VN';u.rate=.95;
  u.onend=onEnd;u.onerror=onEnd;
  speechSynthesis.speak(u);
}

function speak(text,lang='en-US'){
  if(!('speechSynthesis' in window))return;
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang=lang;u.rate=.85;
  speechSynthesis.speak(u);
}
window.speak=speak;

function startTimer(id,sec,onComplete){
  clearInterval(state.timer);
  state.timerCallback=onComplete;
  const box=document.getElementById(`${id}-timer`);
  const time=box.querySelector('.timer-time');
  box.classList.add('active');
  box.scrollIntoView({behavior:'smooth',block:'center'});
  let rem=sec;
  time.textContent=formatTime(rem);
  time.className='timer-time';
  state.timer=setInterval(()=>{
    rem--;time.textContent=formatTime(rem);
    if(rem<=10)time.classList.add('warning');
    if(rem<=5)time.classList.add('danger');
    if(rem<=0){
      clearInterval(state.timer);
      box.classList.remove('active');
      if(state.timerCallback)state.timerCallback();
    }
  },1000);
}

function skipTimer(id){
  clearInterval(state.timer);
  document.getElementById(`${id}-timer`).classList.remove('active');
  if(state.timerCallback)state.timerCallback();
}
window.skipTimer=skipTimer;

function formatTime(s){const m=Math.floor(s/60);return m>0?`${m}:${(s%60).toString().padStart(2,'0')}`:`${s}s`}

// Chunk Navigation
function setupNavigation(){
  // Lock scrolling initially
  document.body.style.overflow='hidden';

  // Add navigation buttons to each chunk
  document.querySelectorAll('.chunk').forEach((chunk,i)=>{
    const nav=document.createElement('div');
    nav.className='chunk-nav';
    nav.innerHTML=`<button class="nav-btn" id="nav-${i}" onclick="goNextChunk()" disabled>Ti·∫øp t·ª•c ‚Üí</button>`;
    chunk.appendChild(nav);
  });

  // Progress bar based on chunks
  updateProgress();
}

function activateChunk(idx){
  if(idx>=state.chunks.length)return;
  state.currentChunk=idx;
  console.log('Activating chunk',idx);

  // Update chunk highlights
  document.querySelectorAll('.chunk').forEach((c,i)=>{
    c.classList.remove('current','completed');
    if(i<idx)c.classList.add('completed');
    if(i===idx)c.classList.add('current');
  });

  // Scroll to chunk
  const chunk=document.getElementById(`chunk-${idx}`);
  if(chunk){
    chunk.scrollIntoView({behavior:'smooth',block:'start'});

    // Get all scripts in this chunk
    const allTS=chunk.querySelectorAll('.ts');
    console.log('Chunk',idx,'has',allTS.length,'scripts');

    // Start playing first unplayed TS
    setTimeout(()=>{
      const firstTS=chunk.querySelector('.ts:not(.played)');
      if(firstTS){
        console.log('Starting first script:',firstTS.id);
        playTS(firstTS,true);
      }else{
        // No scripts in this chunk, auto-unlock
        console.log('No scripts in chunk, auto-unlocking');
        unlockNextChunk();
      }
    },600);
  }

  updateProgress();
}

function unlockNextChunk(){
  const btn=document.getElementById(`nav-${state.currentChunk}`);
  if(btn){btn.disabled=false;btn.classList.add('ready');}
}

function goNextChunk(){
  const nextIdx=state.currentChunk+1;
  if(nextIdx<state.chunks.length){
    activateChunk(nextIdx);
  }else{
    // Lesson complete
    showComplete();
  }
}
window.goNextChunk=goNextChunk;

function showComplete(){
  const content=document.getElementById('content');
  content.innerHTML+=`<div class="complete-box"><div class="complete-icon">üéâ</div><h2>Ho√†n th√†nh b√†i h·ªçc!</h2><p>Gi·ªèi l·∫Øm! V·ªÅ nh√† √¥n l·∫°i t·ª´ v·ª±ng nha.</p></div>`;
  document.querySelector('.complete-box').scrollIntoView({behavior:'smooth'});
}

function updateProgress(){
  const pct=((state.currentChunk+1)/state.chunks.length)*100;
  document.getElementById('progress-fill').style.width=pct+'%';
}

// Recording
let recorder=null,chunks=[];
async function toggleRec(id){
  const btn=document.getElementById(`${id}-rec`);
  const player=document.getElementById(`${id}-player`);
  if(recorder&&recorder.state==='recording'){recorder.stop();btn.classList.remove('recording');btn.querySelector('span').textContent='Ghi √¢m';return}
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    recorder=new MediaRecorder(stream);chunks=[];
    recorder.ondataavailable=e=>chunks.push(e.data);
    recorder.onstop=async()=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      player.innerHTML=`<div class="audio-box"><audio controls src="${URL.createObjectURL(blob)}"></audio></div>`;
      await sendAudio(blob,`Ghi √¢m\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);
      stream.getTracks().forEach(t=>t.stop());
    };
    recorder.start();btn.classList.add('recording');btn.querySelector('span').textContent='D·ª´ng';
  }catch(e){alert('Kh√¥ng th·ªÉ ghi √¢m: '+e.message)}
}
window.toggleRec=toggleRec;

// Photo
async function captureHW(id){
  const div=document.getElementById(`${id}-photo`);
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    const modal=document.createElement('div');
    modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px';
    modal.innerHTML=`<video autoplay playsinline style="max-width:100%;max-height:70vh;border-radius:10px"></video><div style="margin-top:12px"><button class="gate-btn" id="hw-cap">Ch·ª•p</button><button class="gate-btn secondary" onclick="this.closest('div').parentElement.remove()">H·ªßy</button></div>`;
    document.body.appendChild(modal);
    modal.querySelector('video').srcObject=stream;
    modal.querySelector('#hw-cap').onclick=async()=>{
      const v=modal.querySelector('video');
      const c=document.createElement('canvas');c.width=v.videoWidth;c.height=v.videoHeight;
      c.getContext('2d').drawImage(v,0,0);
      const url=c.toDataURL('image/jpeg',.85);
      stream.getTracks().forEach(t=>t.stop());modal.remove();
      div.innerHTML=`<img src="${url}" style="max-width:100%;border-radius:8px;margin-top:8px">`;
      await sendPhoto(url,`B√†i l√†m\n${state.name}\n${new Date().toLocaleString('vi-VN')}`);
    };
  }catch(e){alert('Kh√¥ng th·ªÉ m·ªü camera: '+e.message)}
}
window.captureHW=captureHW;

// Telegram
async function sendPhoto(data,caption){
  if(!CONFIG.tgToken||!CONFIG.tgChat)return;
  document.getElementById('sending').classList.add('active');
  try{
    const blob=await(await fetch(data)).blob();
    const fd=new FormData();fd.append('chat_id',CONFIG.tgChat);fd.append('photo',blob,'photo.jpg');fd.append('caption',caption);
    await fetch(`https://api.telegram.org/bot${CONFIG.tgToken}/sendPhoto`,{method:'POST',body:fd});
  }catch(e){}
  document.getElementById('sending').classList.remove('active');
}
async function sendAudio(blob,caption){
  if(!CONFIG.tgToken||!CONFIG.tgChat)return;
  document.getElementById('sending').classList.add('active');
  try{
    const fd=new FormData();fd.append('chat_id',CONFIG.tgChat);fd.append('voice',blob,'voice.ogg');fd.append('caption',caption);
    await fetch(`https://api.telegram.org/bot${CONFIG.tgToken}/sendVoice`,{method:'POST',body:fd});
  }catch(e){}
  document.getElementById('sending').classList.remove('active');
}
</script>
</body>
</html>
