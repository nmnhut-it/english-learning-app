<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Teacher</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #f5f5f5;
      color: #1a1a1a;
      min-height: 100vh;
      font-size: 18px;
    }

    /* Setup Screen */
    #setup {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    #setup h1 {
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 2rem;
    }

    #setup input {
      width: 100%;
      max-width: 400px;
      padding: 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    #setup button {
      padding: 1rem 3rem;
      font-size: 1.1rem;
      background: #fff;
      color: #667eea;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    #setup .hint {
      color: rgba(255,255,255,0.8);
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    /* Player */
    #player {
      display: none;
      height: 100vh;
      flex-direction: column;
    }

    /* Header */
    #header {
      background: #fff;
      padding: 1rem 2rem;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #lesson-title {
      font-size: 1.35rem;
      color: #4338ca;
      font-weight: 700;
    }

    #slide-num {
      color: #555;
      font-size: 1.25rem;
      font-weight: 600;
    }

    /* Main Content */
    #main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 2rem;
      overflow-y: auto;
    }

    /* Slide */
    .slide {
      width: 100%;
      max-width: 1200px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.1);
      padding: 2.5rem 3rem;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.98); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Slide Header */
    .slide-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid #e0e0e0;
    }

    .slide-icon {
      font-size: 2.5rem;
    }

    .slide-title {
      font-size: 2rem;
      color: #1a1a1a;
      font-weight: 700;
    }

    .slide-subtitle {
      font-size: 1.25rem;
      color: #555;
      margin-left: auto;
    }

    /* Teacher Script */
    .teacher-content {
      font-size: 1.75rem;
      line-height: 1.8;
      color: #1a1a1a;
    }

    .teacher-content strong {
      color: #4338ca;
      font-weight: 700;
    }

    .teacher-content .highlight {
      background: #fef08a;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }

    /* Formula Box */
    .formula-box {
      background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
      color: #fff;
      padding: 1.5rem 2rem;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 1.75rem;
      margin: 1.5rem 0;
      text-align: center;
      font-weight: 600;
    }

    /* Examples List - Linear */
    .examples-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .example-item {
      background: #fff;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      border-left: 5px solid #4338ca;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .example-en {
      font-size: 1.5rem;
      color: #1a1a1a;
      font-weight: 500;
    }

    .example-vi {
      font-size: 1.25rem;
      color: #555;
      margin-top: 0.5rem;
    }

    /* Wrong vs Right - Linear */
    .compare-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .compare-item {
      display: flex;
      gap: 1.5rem;
      align-items: stretch;
    }

    .compare-wrong {
      flex: 1;
      background: #fef2f2;
      border: 2px solid #fca5a5;
      padding: 1.25rem 1.5rem;
      border-radius: 10px;
      font-size: 1.5rem;
    }

    .compare-wrong::before {
      content: '‚úó ';
      color: #dc2626;
      font-weight: 700;
    }

    .compare-right {
      flex: 1;
      background: #f0fdf4;
      border: 2px solid #86efac;
      padding: 1.25rem 1.5rem;
      border-radius: 10px;
      font-size: 1.5rem;
    }

    .compare-right::before {
      content: '‚úì ';
      color: #16a34a;
      font-weight: 700;
    }

    /* Vocabulary List - Linear */
    .vocab-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .vocab-item {
      display: flex;
      align-items: baseline;
      gap: 1.5rem;
      padding: 1.25rem 1.5rem;
      background: #fff;
      border-radius: 10px;
      border-left: 5px solid #4338ca;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .vocab-word {
      font-size: 1.75rem;
      color: #4338ca;
      font-weight: 700;
      min-width: 180px;
    }

    .vocab-pos {
      background: #4338ca;
      color: #fff;
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 1rem;
      flex-shrink: 0;
      font-weight: 600;
    }

    .vocab-pron {
      color: #555;
      font-size: 1.25rem;
      min-width: 160px;
    }

    .vocab-meaning {
      font-size: 1.5rem;
      color: #1a1a1a;
      flex: 1;
    }

    /* Dialogue */
    .dialogue-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .dialogue-line {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      padding: 1rem 1.5rem;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .dialogue-speaker {
      min-width: 80px;
      font-weight: 700;
      font-size: 1.25rem;
      color: #4338ca;
    }

    .dialogue-line:nth-child(even) .dialogue-speaker {
      color: #dc2626;
    }

    .dialogue-text {
      flex: 1;
    }

    .dialogue-en {
      font-size: 1.5rem;
      color: #1a1a1a;
    }

    .dialogue-vi {
      font-size: 1.25rem;
      color: #555;
      margin-top: 0.25rem;
    }

    /* Exercise - Linear */
    .exercise-block {
      margin-bottom: 2rem;
    }

    .exercise-question {
      font-size: 1.5rem;
      color: #1a1a1a;
      margin-bottom: 1rem;
      padding: 1.25rem 1.5rem;
      background: #fff;
      border-radius: 10px;
      border-left: 5px solid #4338ca;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .exercise-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-left: 1.5rem;
    }

    .option-btn {
      padding: 1rem 1.5rem;
      font-size: 1.35rem;
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }

    .option-btn:hover {
      border-color: #4338ca;
      background: #f5f3ff;
    }

    .option-btn.correct {
      border-color: #16a34a;
      background: #f0fdf4;
      border-width: 3px;
    }

    .option-btn.incorrect {
      border-color: #dc2626;
      background: #fef2f2;
      border-width: 3px;
    }

    /* Key Points */
    .key-points {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .key-point {
      background: #fff;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      border-left: 5px solid #4338ca;
      font-size: 1.35rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Reading - Linear */
    .reading-text {
      font-size: 1.5rem;
      line-height: 1.9;
      color: #1a1a1a;
    }

    /* Tip Box */
    .tip-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      padding: 2rem;
      border-radius: 12px;
      font-size: 1.75rem;
      text-align: center;
      color: #92400e;
      font-weight: 600;
      border: 2px solid #f59e0b;
    }

    /* Footer */
    #footer {
      background: #fff;
      padding: 0.75rem 2rem;
      border-top: 2px solid #e0e0e0;
      display: flex;
      justify-content: center;
      gap: 3rem;
      color: #555;
      font-size: 1.1rem;
    }

    #footer kbd {
      background: #e5e7eb;
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-family: inherit;
      font-weight: 600;
    }

    /* AI Popup */
    #ai-popup {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 700px;
      width: 90%;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: none;
    }

    #ai-popup.visible {
      display: block;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    #ai-popup-text {
      font-size: 1.05rem;
      line-height: 1.6;
      color: #333;
    }

    .loading-dots::after {
      content: '...';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
  </style>
</head>
<body>
  <!-- Setup -->
  <div id="setup">
    <h1>AI Teacher</h1>
    <input type="password" id="api-key" placeholder="Gemini API Key">
    <button onclick="start()">B·∫Øt ƒë·∫ßu</button>
    <p class="hint">Enter = ti·∫øp | Space = AI gi·∫£ng th√™m</p>
  </div>

  <!-- Player -->
  <div id="player">
    <header id="header">
      <div id="lesson-title">-</div>
      <div id="slide-num">-</div>
    </header>

    <main id="main">
      <div class="slide" id="slide-content"></div>
    </main>

    <div id="ai-popup">
      <div id="ai-popup-text"></div>
    </div>

    <footer id="footer">
      <span><kbd>Enter</kbd> Ti·∫øp</span>
      <span><kbd>‚Üê</kbd><kbd>‚Üí</kbd> Di chuy·ªÉn</span>
      <span><kbd>Space</kbd> AI gi·∫£ng</span>
    </footer>
  </div>

  <script>
    // Config
    const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';
    const LINES_PER_SLIDE = 7;

    // State
    let lesson = null;
    let slides = [];
    let currentIdx = 0;
    let apiKey = '';

    // Init
    function init() {
      apiKey = localStorage.getItem('gemini_key') || '';
      if (apiKey) document.getElementById('api-key').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';

      const params = new URLSearchParams(location.search);
      if (params.get('lesson') && apiKey) start();
    }

    async function start() {
      const input = document.getElementById('api-key').value;
      if (input && !input.startsWith('‚Ä¢‚Ä¢')) {
        apiKey = input;
        localStorage.setItem('gemini_key', apiKey);
      }

      if (!apiKey) return alert('Nh·∫≠p API Key');

      document.getElementById('setup').style.display = 'none';
      document.getElementById('player').style.display = 'flex';

      const path = new URLSearchParams(location.search).get('lesson');
      if (path) {
        try {
          const res = await fetch(path);
          lesson = await res.json();
        } catch (e) {
          lesson = getDemoLesson();
        }
      } else {
        lesson = getDemoLesson();
      }

      buildSlides();
      render();
      setupKeys();
    }

    // Build slides with content estimation
    function buildSlides() {
      slides = [];
      const blocks = lesson.blocks || [];

      let i = 0;
      while (i < blocks.length) {
        const block = blocks[i];

        // Teacher scripts - usually 1 per slide
        if (['lesson_intro', 'concept_explain', 'error_warn', 'pre_exercise', 'post_exercise', 'tip', 'summary', 'transition'].includes(block.type)) {
          slides.push({ type: block.type, blocks: [block] });
          i++;
          continue;
        }

        // Vocabulary - group ~4 items per slide
        if (block.type === 'vocabulary' && block.items) {
          const items = block.items;
          for (let j = 0; j < items.length; j += 4) {
            slides.push({
              type: 'vocabulary',
              blocks: [{ ...block, items: items.slice(j, j + 4) }]
            });
          }
          i++;
          continue;
        }

        // Dialogue - group ~4 lines per slide
        if (block.type === 'dialogue' && block.lines) {
          const lines = block.lines;
          for (let j = 0; j < lines.length; j += 4) {
            slides.push({
              type: 'dialogue',
              blocks: [{
                ...block,
                lines: lines.slice(j, j + 4),
                isPartial: j > 0 || j + 4 < lines.length
              }]
            });
          }
          i++;
          continue;
        }

        // Grammar - 1 per slide
        if (block.type === 'grammar') {
          slides.push({ type: 'grammar', blocks: [block] });
          i++;
          continue;
        }

        // Reading - split if too long
        if (block.type === 'reading') {
          slides.push({ type: 'reading', blocks: [block] });
          i++;
          continue;
        }

        // Exercise - group 2-3 questions per slide
        if (block.type === 'exercise' && block.questions) {
          const qs = block.questions;
          const perSlide = block.exerciseType === 'multiple_choice' ? 2 : 3;
          for (let j = 0; j < qs.length; j += perSlide) {
            slides.push({
              type: 'exercise',
              blocks: [{
                ...block,
                questions: qs.slice(j, j + perSlide)
              }]
            });
          }
          i++;
          continue;
        }

        // Listening
        if (block.type === 'listening') {
          slides.push({ type: 'listening', blocks: [block] });
          i++;
          continue;
        }

        // Default
        slides.push({ type: block.type || 'generic', blocks: [block] });
        i++;
      }

      document.getElementById('lesson-title').textContent =
        `${lesson.unitTitle || ''} - ${lesson.sectionTitle || ''}`;
    }

    // Render current slide
    function render() {
      if (currentIdx >= slides.length) return;

      const slide = slides[currentIdx];
      const el = document.getElementById('slide-content');
      document.getElementById('slide-num').textContent = `${currentIdx + 1}/${slides.length}`;

      let html = '';

      switch (slide.type) {
        case 'lesson_intro':
          html = renderLessonIntro(slide.blocks[0]);
          break;
        case 'concept_explain':
          html = renderConceptExplain(slide.blocks[0]);
          break;
        case 'error_warn':
          html = renderErrorWarn(slide.blocks[0]);
          break;
        case 'tip':
          html = renderTip(slide.blocks[0]);
          break;
        case 'summary':
          html = renderSummary(slide.blocks[0]);
          break;
        case 'pre_exercise':
          html = renderPreExercise(slide.blocks[0]);
          break;
        case 'vocabulary':
          html = renderVocabulary(slide.blocks[0]);
          break;
        case 'dialogue':
          html = renderDialogue(slide.blocks[0]);
          break;
        case 'grammar':
          html = renderGrammar(slide.blocks[0]);
          break;
        case 'reading':
          html = renderReading(slide.blocks[0]);
          break;
        case 'exercise':
          html = renderExercise(slide.blocks[0]);
          break;
        case 'listening':
          html = renderListening(slide.blocks[0]);
          break;
        default:
          html = renderGeneric(slide.blocks[0]);
      }

      el.innerHTML = html;
    }

    // Renderers
    function renderLessonIntro(b) {
      let html = `
        <div class="slide-header">
          <span class="slide-icon">üìö</span>
          <span class="slide-title">Gi·ªõi thi·ªáu b√†i h·ªçc</span>
        </div>
        <div class="teacher-content">${formatScript(b.script)}</div>
      `;
      if (b.objectives?.length) {
        html += '<div class="key-points">';
        b.objectives.forEach(o => html += `<div class="key-point">‚úì ${o}</div>`);
        html += '</div>';
      }
      return html;
    }

    function renderConceptExplain(b) {
      let html = `
        <div class="slide-header">
          <span class="slide-icon">üí°</span>
          <span class="slide-title">${b.concept || 'Gi·∫£i th√≠ch'}</span>
          ${b.conceptVi ? `<span class="slide-subtitle">${b.conceptVi}</span>` : ''}
        </div>
        <div class="teacher-content">${formatScript(b.script)}</div>
      `;
      if (b.formula) {
        html += `<div class="formula-box">${b.formula}</div>`;
      }
      if (b.examples?.length) {
        html += '<div class="examples-list">';
        b.examples.forEach(ex => {
          html += `
            <div class="example-item">
              <div class="example-en">${ex.english}</div>
              <div class="example-vi">${ex.vietnamese}</div>
            </div>
          `;
        });
        html += '</div>';
      }
      return html;
    }

    function renderErrorWarn(b) {
      let html = `
        <div class="slide-header">
          <span class="slide-icon">‚ö†Ô∏è</span>
          <span class="slide-title">L·ªói ph·ªï bi·∫øn</span>
        </div>
        <div class="teacher-content">${formatScript(b.script)}</div>
      `;
      if (b.wrongVsRight?.length) {
        html += '<div class="compare-list">';
        b.wrongVsRight.forEach(item => {
          html += `
            <div class="compare-item">
              <div class="compare-wrong">${item.wrong}</div>
              <div class="compare-right">${item.right}</div>
            </div>
          `;
        });
        html += '</div>';
      }
      return html;
    }

    function renderTip(b) {
      return `
        <div class="slide-header">
          <span class="slide-icon">üí°</span>
          <span class="slide-title">M·∫πo ghi nh·ªõ</span>
        </div>
        <div class="tip-box">${formatScript(b.script)}</div>
      `;
    }

    function renderSummary(b) {
      let html = `
        <div class="slide-header">
          <span class="slide-icon">üìù</span>
          <span class="slide-title">T·ªïng k·∫øt</span>
        </div>
        <div class="teacher-content">${formatScript(b.script)}</div>
      `;
      if (b.keyPoints?.length) {
        html += '<div class="key-points">';
        b.keyPoints.forEach(p => html += `<div class="key-point">${p}</div>`);
        html += '</div>';
      }
      return html;
    }

    function renderPreExercise(b) {
      let html = `
        <div class="slide-header">
          <span class="slide-icon">üìù</span>
          <span class="slide-title">H∆∞·ªõng d·∫´n l√†m b√†i</span>
        </div>
        <div class="teacher-content">${formatScript(b.script)}</div>
      `;
      if (b.steps?.length) {
        html += '<div class="key-points">';
        b.steps.forEach((s, i) => html += `<div class="key-point">${i+1}. ${s}</div>`);
        html += '</div>';
      }
      return html;
    }

    function renderVocabulary(b) {
      const items = b.items || [];
      let html = `
        <div class="slide-header">
          <span class="slide-icon">üìñ</span>
          <span class="slide-title">T·ª´ v·ª±ng</span>
          <span class="slide-subtitle">${b.context || ''}</span>
        </div>
        <div class="vocab-list">
      `;
      items.forEach(v => {
        html += `
          <div class="vocab-item">
            <span class="vocab-word">${v.word}</span>
            ${v.partOfSpeech ? `<span class="vocab-pos">${v.partOfSpeech}</span>` : ''}
            <span class="vocab-pron">${v.pronunciation || ''}</span>
            <span class="vocab-meaning">${v.meaning}</span>
          </div>
        `;
      });
      html += '</div>';
      return html;
    }

    function renderDialogue(b) {
      const lines = b.lines || [];
      let html = `
        <div class="slide-header">
          <span class="slide-icon">üí¨</span>
          <span class="slide-title">${b.title || 'H·ªôi tho·∫°i'}</span>
          ${b.context ? `<span class="slide-subtitle">${b.context}</span>` : ''}
        </div>
        <div class="dialogue-container">
      `;
      lines.forEach(l => {
        html += `
          <div class="dialogue-line">
            <div class="dialogue-speaker">${l.speaker || '?'}:</div>
            <div class="dialogue-text">
              <div class="dialogue-en">${l.text}</div>
              ${l.translation ? `<div class="dialogue-vi">${l.translation}</div>` : ''}
            </div>
          </div>
        `;
      });
      html += '</div>';
      return html;
    }

    function renderGrammar(b) {
      let html = `
        <div class="slide-header">
          <span class="slide-icon">üìê</span>
          <span class="slide-title">${b.topic || 'Ng·ªØ ph√°p'}</span>
          ${b.topicVi ? `<span class="slide-subtitle">${b.topicVi}</span>` : ''}
        </div>
      `;
      if (b.formula) {
        if (typeof b.formula === 'object') {
          html += '<div class="formula-box">';
          if (b.formula.affirmative) html += `<div>+ ${b.formula.affirmative}</div>`;
          if (b.formula.negative) html += `<div>‚àí ${b.formula.negative}</div>`;
          if (b.formula.question) html += `<div>? ${b.formula.question}</div>`;
          html += '</div>';
        } else {
          html += `<div class="formula-box">${b.formula}</div>`;
        }
      }
      if (b.usage?.length) {
        html += '<div class="examples-list">';
        b.usage.forEach(u => {
          html += `
            <div class="example-item">
              <div class="example-en">${u.example}</div>
              <div class="example-vi">${u.exampleTranslation || u.descriptionVi}</div>
            </div>
          `;
        });
        html += '</div>';
      }
      return html;
    }

    function renderReading(b) {
      return `
        <div class="slide-header">
          <span class="slide-icon">üìñ</span>
          <span class="slide-title">${b.title || 'B√†i ƒë·ªçc'}</span>
        </div>
        <div class="reading-text">${b.content}</div>
      `;
    }

    function renderExercise(b) {
      const qs = b.questions || [];
      let html = `
        <div class="slide-header">
          <span class="slide-icon">‚úèÔ∏è</span>
          <span class="slide-title">${b.exerciseType?.replace(/_/g, ' ') || 'B√†i t·∫≠p'}</span>
          <span class="slide-subtitle">${b.instruction || ''}</span>
        </div>
      `;
      qs.forEach((q, i) => {
        html += '<div class="exercise-block">';
        html += `<div class="exercise-question">${q.id || i+1}. ${q.questionText || q.question || q.sentence || ''}</div>`;
        if (q.options) {
          html += '<div class="exercise-options">';
          q.options.forEach((opt, j) => {
            const letter = String.fromCharCode(65 + j);
            const text = typeof opt === 'object' ? opt.text : opt;
            html += `<button class="option-btn" onclick="selectOption(this, '${q.correctAnswer}')">${letter}. ${text}</button>`;
          });
          html += '</div>';
        }
        html += '</div>';
      });
      return html;
    }

    function renderListening(b) {
      return `
        <div class="slide-header">
          <span class="slide-icon">üéß</span>
          <span class="slide-title">${b.title || 'B√†i nghe'}</span>
        </div>
        <div class="teacher-content">${b.transcript || b.transcriptVi || ''}</div>
      `;
    }

    function renderGeneric(b) {
      return `
        <div class="slide-header">
          <span class="slide-icon">üìÑ</span>
          <span class="slide-title">${b.type || 'N·ªôi dung'}</span>
        </div>
        <div class="teacher-content">${b.script || b.content || JSON.stringify(b)}</div>
      `;
    }

    // Helpers
    function formatScript(text) {
      if (!text) return '';
      // Bold text between ** **
      text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      // Highlight CAPS words
      text = text.replace(/\b([A-Z]{2,})\b/g, '<span class="highlight">$1</span>');
      return text;
    }

    function selectOption(btn, correct) {
      const parent = btn.parentElement;
      parent.querySelectorAll('.option-btn').forEach(b => {
        b.classList.remove('selected', 'correct', 'incorrect');
      });
      btn.classList.add('selected');

      const letter = btn.textContent[0];
      if (letter === correct || btn.textContent.includes(correct)) {
        btn.classList.add('correct');
      } else {
        btn.classList.add('incorrect');
        // Show correct
        parent.querySelectorAll('.option-btn').forEach(b => {
          if (b.textContent[0] === correct || b.textContent.includes(correct)) {
            b.classList.add('correct');
          }
        });
      }
    }

    // AI
    async function askAI() {
      const popup = document.getElementById('ai-popup');
      const text = document.getElementById('ai-popup-text');

      popup.classList.add('visible');
      text.innerHTML = '<span class="loading-dots">ƒêang x·ª≠ l√Ω</span>';

      try {
        const slide = slides[currentIdx];
        const prompt = buildPrompt(slide);

        const res = await fetch(`${GEMINI_URL}?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 250 }
          })
        });

        const data = await res.json();
        text.innerHTML = data.candidates[0].content.parts[0].text;

        setTimeout(() => popup.classList.remove('visible'), 8000);
      } catch (e) {
        text.innerHTML = `L·ªói: ${e.message}`;
      }
    }

    function buildPrompt(slide) {
      const base = 'B·∫°n l√† gi√°o vi√™n ti·∫øng Anh. Gi·∫£i th√≠ch ng·∫Øn g·ªçn (2-3 c√¢u), d·ªÖ hi·ªÉu, th·ª±c t·∫ø. Kh√¥ng ch√†o h·ªèi.';
      const content = JSON.stringify(slide.blocks[0]).substring(0, 500);
      return `${base}\n\nN·ªôi dung: ${content}\n\nGi·∫£i th√≠ch th√™m ho·∫∑c cho m·∫πo ghi nh·ªõ:`;
    }

    // Keys
    function setupKeys() {
      document.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === 'ArrowRight') {
          if (currentIdx < slides.length - 1) { currentIdx++; render(); }
        } else if (e.key === 'ArrowLeft') {
          if (currentIdx > 0) { currentIdx--; render(); }
        } else if (e.key === ' ') {
          e.preventDefault();
          askAI();
        } else if (e.key === 'Escape') {
          document.getElementById('ai-popup').classList.remove('visible');
        }
      });
    }

    // Demo
    function getDemoLesson() {
      return {
        unitTitle: "Unit 7",
        sectionTitle: "Environmental Protection",
        blocks: [
          {
            type: "lesson_intro",
            script: "B√†i h√¥m nay t·∫≠p trung v√†o **m·ªánh ƒë·ªÅ tr·∫°ng ng·ªØ ch·ªâ th·ªùi gian**. ƒê√¢y l√† ƒëi·ªÉm ng·ªØ ph√°p quan tr·ªçng, th∆∞·ªùng xu·∫•t hi·ªán trong b√†i thi.",
            objectives: ["Hi·ªÉu c√°ch d√πng before, after, when, while, until", "Tr√°nh l·ªói d√πng 'will' sai ch·ªó"]
          },
          {
            type: "vocabulary",
            context: "Environmental terms",
            items: [
              { word: "ecosystem", partOfSpeech: "n", pronunciation: "/ÀàiÀêk…ô äs…™st…ôm/", meaning: "h·ªá sinh th√°i" },
              { word: "endangered", partOfSpeech: "adj", pronunciation: "/…™nÀàde…™nd í…ôd/", meaning: "c√≥ nguy c∆° tuy·ªát ch·ªßng" },
              { word: "wildlife", partOfSpeech: "n", pronunciation: "/Ààwa…™ldla…™f/", meaning: "ƒë·ªông v·∫≠t hoang d√£" },
              { word: "pollution", partOfSpeech: "n", pronunciation: "/p…ôÀàluÀê Én/", meaning: "√¥ nhi·ªÖm" }
            ]
          },
          {
            type: "concept_explain",
            concept: "Time Clauses",
            conceptVi: "M·ªánh ƒë·ªÅ th·ªùi gian",
            script: "Khi n·ªëi 2 c√¢u b·∫±ng **before, after, when, while, until** - m·ªánh ƒë·ªÅ th·ªùi gian d√πng th√¨ HI·ªÜN T·∫†I ƒë·ªÉ ch·ªâ t∆∞∆°ng lai, KH√îNG d√πng 'will'.",
            formula: "Main clause (will + V) + before/after/when + clause (V present)",
            examples: [
              { english: "I will call you before I leave.", vietnamese: "T√¥i s·∫Ω g·ªçi tr∆∞·ªõc khi ƒëi." },
              { english: "As soon as I arrive, I will text you.", vietnamese: "Ngay khi ƒë·∫øn, t√¥i s·∫Ω nh·∫Øn tin." }
            ]
          },
          {
            type: "error_warn",
            script: "L·ªñI PH·ªî BI·∫æN: D√πng 'will' sau before, after, when. ƒê√¢y l√† l·ªói r·∫•t hay m·∫Øc trong b√†i thi!",
            wrongVsRight: [
              { wrong: "I will go before you will finish.", right: "I will go before you finish." }
            ]
          },
          {
            type: "tip",
            script: "M·∫πo nh·ªõ: **BAWWU kh√¥ng th√≠ch Will!** Before, After, When, While, Until - 5 t·ª´ n√†y c·∫•m 'will' ph√≠a sau."
          },
          {
            type: "summary",
            script: "Nh·ªõ 1 ƒëi·ªÅu: sau before, after, when, while, until ‚Üí d√πng th√¨ HI·ªÜN T·∫†I, kh√¥ng 'will'.",
            keyPoints: ["BAWWU + present tense", "Main clause c√≥ th·ªÉ d√πng will"]
          }
        ]
      };
    }

    init();
  </script>
</body>
</html>
