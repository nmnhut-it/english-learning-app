<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Vocabulary Quiz Hub - Gemini Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        /* Setup Screen */
        .setup-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 30px;
            text-align: center;
        }

        .setup-screen h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            color: #34495e;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .setup-screen p {
            font-size: 1.3rem;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .setup-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
            backdrop-filter: blur(10px);
        }

        .api-key-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .api-key-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
        }

        #apiKey {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8f4fd;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 5px;
            background: #fafbfc;
            transition: border-color 0.3s;
        }

        #apiKey:focus {
            outline: none;
            border-color: #3498db;
        }

        .api-key-status {
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .api-key-status.saved {
            color: #27ae60;
        }

        .api-key-status.missing {
            color: #e74c3c;
        }

        #textInput {
            width: 100%;
            height: 160px;
            padding: 20px;
            border: 2px solid #e8f4fd;
            border-radius: 12px;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
            resize: none;
            background: #fafbfc;
            transition: border-color 0.3s;
        }

        #textInput:focus {
            outline: none;
            border-color: #3498db;
        }

        .setup-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setup-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }

        /* Processing Screen */
        .processing-screen {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 30px;
            text-align: center;
        }

        .processing-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 600px;
        }

        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 1.3rem;
            color: #34495e;
        }

        /* Hub Screen (formerly Preview) */
        .hub-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #f8fafe;
        }

        .hub-screen.active { display: flex !important; }

        /* Header for hub */
        .hub-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .hub-title {
            font-size: 2rem;
            font-weight: 800;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .hub-controls {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .word-count {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Hub content */
        .hub-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8fafe;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .mode-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
            border: 3px solid transparent;
            text-align: center;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #5a67d8;
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .mode-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .mode-description {
            color: #7f8c8d;
            line-height: 1.5;
        }

        /* Save status */
        .save-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Vocabulary Table View */
        .table-view {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #f8fafe;
        }

        .table-view.active { display: flex !important; }

        .table-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .vocab-table {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .vocab-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .vocab-table th {
            background: #5a67d8;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .vocab-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 1.05rem;
        }

        .vocab-table tr:hover {
            background: #f7fafc;
        }

        .vocab-table .word-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .vocab-table .ipa-cell {
            color: #5a67d8;
            font-family: 'Courier New', monospace;
            font-style: italic;
        }

        .vocab-table .meaning-cell {
            color: #27ae60;
        }

        /* Flashcard View */
        .flashcard-view {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #f8fafe;
        }

        .flashcard-view.active { display: flex !important; }

        .flashcard-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .flashcard {
            background: white;
            width: 90%;
            max-width: 600px;
            height: 400px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            border-radius: 20px;
        }

        .flashcard-front {
            background: white;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .flashcard-text {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.3;
        }

        .flashcard-ipa {
            font-size: 1.5rem;
            color: #7f8c8d;
            margin-top: 20px;
            font-style: italic;
        }

        .flashcard-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .flashcard-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .flashcard-progress {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.1);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
        }

        /* VocabHoot Game */
        .hoot-view {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #f8fafe;
        }

        .hoot-view.active { display: flex !important; }

        .hoot-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .hoot-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 800px;
            width: 100%;
        }

        .hoot-question {
            font-size: 2rem;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .hoot-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .hoot-option {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .hoot-option:hover {
            background: #f0f4f8;
            border-color: #5a67d8;
            transform: scale(1.02);
        }

        .hoot-option.correct {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .hoot-option.wrong {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .hoot-timer {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .hoot-timer-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.1s linear;
        }

        .hoot-score {
            font-size: 1.3rem;
            font-weight: 700;
            color: #5a67d8;
        }

        /* Quiz Screen */
        .quiz-screen {
            display: none;
            height: 100vh;
            flex-direction: column;
            background: #f8fafe;
        }

        .quiz-screen.active { display: flex !important; }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .title {
            font-size: 2rem;
            font-weight: 800;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .count-display {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Main Content Area */
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Questions Grid - 2 cards per row */
        .questions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .vocab-card {
            background: white;
            border-radius: 15px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-left: 5px solid #e3f2fd;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            justify-content: space-between;
        }

        .vocab-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            border-left-color: #3498db;
        }

        .card-number {
            position: absolute;
            top: -8px;
            left: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .vocab-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
            flex: 1;
        }

        .vocab-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 32px;
        }

        .vocab-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #7f8c8d;
            min-width: 60px;
            flex-shrink: 0;
        }

        .vocab-value {
            flex: 1;
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .word-text {
            color: #2c3e50;
        }

        .meaning-text {
            color: #27ae60;
        }

        .ipa-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: auto;
        }

        .ipa-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #95a5a6;
            min-width: 35px;
        }

        .ipa-text {
            font-size: 1.1rem;
            color: #7f8c8d;
            font-style: italic;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .blank-space {
            display: flex;
            align-items: center;
            min-height: 32px;
            border-bottom: 3px dashed #bdc3c7;
            min-width: 150px;
            padding: 4px 8px;
            position: relative;
            transition: all 0.3s;
            background: #f8f9fa;
            border-radius: 4px;
            flex: 1;
        }

        .blank-space.revealed {
            border-bottom-color: transparent;
            background: transparent;
        }

        .blank-placeholder {
            color: #bdc3c7;
            font-style: italic;
            font-size: 1rem;
        }

        .answer-text {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            padding: 4px 8px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: 700;
            font-size: 1.3rem;
            background: rgba(255,255,255,0.95);
            border-radius: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .answer-text.show {
            opacity: 1;
        }

        .answer-text.word-answer {
            color: #2c3e50;
        }

        .answer-text.meaning-answer {
            color: #27ae60;
        }

        /* Bottom Controls */
        .bottom-controls {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            border-top: 1px solid #e9ecef;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-btn:hover { 
            transform: scale(1.05);
        }

        .reveal-btn { 
            background: linear-gradient(135deg, #f39c12, #e67e22); 
            color: white; 
        }

        .hide-btn { 
            background: linear-gradient(135deg, #95a5a6, #7f8c8d); 
            color: white; 
        }

        .reset-btn { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
        }

        /* Keyboard hints */
        .shortcuts {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            opacity: 0.8;
            backdrop-filter: blur(5px);
        }

        /* Error message */
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        /* Responsive adjustments */
        @media (max-width: 1000px) {
            .questions-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .vocab-value {
                font-size: 1.1rem;
            }
            
            .vocab-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .vocab-label {
                font-size: 0.8rem;
            }
            
            .blank-space {
                min-width: 100%;
            }

            .mode-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 1400px) {
            .vocab-value {
                font-size: 1.4rem;
            }
            
            .questions-grid {
                gap: 20px;
            }
            
            .vocab-card {
                min-height: 140px;
            }
        }

        @media (min-width: 1800px) {
            .vocab-value {
                font-size: 1.5rem;
            }
            
            .vocab-card {
                min-height: 160px;
                padding: 22px;
            }
        }
    </style>
</head>
<body>
    <!-- Setup Screen -->
    <div id="setupScreen" class="setup-screen">
        <h1>üìö Vocabulary Quiz Hub</h1>
        <p>Clean ‚Ä¢ Intuitive ‚Ä¢ TV Optimized ‚Ä¢ Multiple Modes</p>
        
        <div class="setup-box">
            <div class="api-key-group">
                <div class="api-key-label">üîë Gemini API Key:</div>
                <input type="text" id="apiKey" placeholder="Enter your Gemini API key">
                <div class="api-key-status" id="apiKeyStatus"></div>
                <small style="color: #7f8c8d;">Get your key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
            </div>

            <div class="api-key-group">
                <div class="api-key-label">üìù File name to save <span style="color: #e74c3c;">*</span>:</div>
                <input type="text" id="fileName" placeholder="Enter filename (e.g., unit-01-vocabulary)" required>
                <div class="api-key-status" id="fileNameStatus"></div>
                <small style="color: #7f8c8d;">File will be saved as .md in vocabquiz folder</small>
            </div>

            <textarea id="textInput" placeholder="Paste your vocabulary here (any format)..."></textarea>
            
            <div style="margin: 20px 0; text-align: center;">
                <div style="color: #7f8c8d; margin-bottom: 10px;">‚Äî OR ‚Äî</div>
                <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadVocabularyFile(event)">
                <button class="setup-btn btn-secondary" onclick="document.getElementById('fileInput').click()">üìÅ Load Saved Vocabulary</button>
            </div>
            
            <div>
                <button class="setup-btn btn-primary" onclick="processVocabulary()">üöÄ Process with Gemini</button>
            </div>
        </div>
    </div>

    <!-- Processing Screen -->
    <div id="processingScreen" class="processing-screen">
        <div class="processing-box">
            <div class="loading"></div>
            <div class="processing-text">Processing with Gemini AI...</div>
        </div>
    </div>

    <!-- Hub Screen -->
    <div id="hubScreen" class="hub-screen">
        <div class="hub-header">
            <div class="hub-title">üìö Vocabulary Hub</div>
            <div class="hub-controls">
                <div class="word-count" id="wordCount">0 words</div>
                <button class="header-btn" onclick="backToSetup()">‚Üê Back to Edit</button>
            </div>
        </div>

        <div class="hub-content">
            <div class="mode-grid">
                <div class="mode-card" onclick="showTableView()">
                    <div class="mode-icon">üìä</div>
                    <div class="mode-title">Table View</div>
                    <div class="mode-description">View all vocabulary in a clean table format</div>
                </div>
                
                <div class="mode-card" onclick="showFlashcards()">
                    <div class="mode-icon">üé¥</div>
                    <div class="mode-title">Flashcards</div>
                    <div class="mode-description">Study with interactive flashcards</div>
                </div>
                
                <div class="mode-card" onclick="startVocabHoot()">
                    <div class="mode-icon">üéÆ</div>
                    <div class="mode-title">VocabHoot</div>
                    <div class="mode-description">Fast-paced game with timer</div>
                </div>
                
                <div class="mode-card" onclick="startQuiz('type1')">
                    <div class="mode-icon">üìù</div>
                    <div class="mode-title">Quiz: Meaning ‚Üí Word</div>
                    <div class="mode-description">Test your vocabulary knowledge</div>
                </div>
                
                <div class="mode-card" onclick="startQuiz('type2')">
                    <div class="mode-icon">üî§</div>
                    <div class="mode-title">Quiz: Word ‚Üí Meaning</div>
                    <div class="mode-description">Match words to their meanings</div>
                </div>
                
                <div class="mode-card" onclick="startQuiz('mixed')">
                    <div class="mode-icon">üé≤</div>
                    <div class="mode-title">Mixed Quiz</div>
                    <div class="mode-description">Random mix of both quiz types</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table View -->
    <div id="tableView" class="table-view">
        <div class="hub-header">
            <div class="hub-title">üìä Vocabulary Table</div>
            <div class="hub-controls">
                <div class="word-count" id="tableWordCount">0 words</div>
                <button class="header-btn" onclick="backToHub()">‚Üê Back to Hub</button>
            </div>
        </div>

        <div class="table-container">
            <div class="vocab-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Word</th>
                            <th>IPA</th>
                            <th>Meaning</th>
                        </tr>
                    </thead>
                    <tbody id="vocabTableBody">
                        <!-- Table rows will be generated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Flashcard View -->
    <div id="flashcardView" class="flashcard-view">
        <div class="hub-header">
            <div class="hub-title">üé¥ Flashcards</div>
            <div class="hub-controls">
                <div class="flashcard-progress" id="flashcardProgress">1 / 10</div>
                <button class="header-btn" onclick="backToHub()">‚Üê Back to Hub</button>
            </div>
        </div>

        <div class="flashcard-container">
            <div class="flashcard" id="flashcard" onclick="flipCard()">
                <div class="flashcard-face flashcard-front">
                    <div class="flashcard-text" id="flashcardFront">Word</div>
                    <div class="flashcard-ipa" id="flashcardIPA">/pronunciation/</div>
                </div>
                <div class="flashcard-face flashcard-back">
                    <div class="flashcard-text" id="flashcardBack">Meaning</div>
                </div>
            </div>
            
            <div class="flashcard-controls">
                <button class="flashcard-btn btn-secondary" onclick="previousCard()">‚Üê Previous</button>
                <button class="flashcard-btn btn-primary" onclick="nextCard()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- VocabHoot View -->
    <div id="hootView" class="hoot-view">
        <div class="hub-header">
            <div class="hub-title">üéÆ VocabHoot</div>
            <div class="hub-controls">
                <div class="hoot-score" id="hootScore">Score: 0</div>
                <button class="header-btn" onclick="backToHub()">‚Üê Exit Game</button>
            </div>
        </div>

        <div class="hoot-container">
            <div class="hoot-card">
                <div class="hoot-timer">
                    <div class="hoot-timer-bar" id="hootTimerBar"></div>
                </div>
                <div class="hoot-question" id="hootQuestion">Get Ready!</div>
                <div class="hoot-options" id="hootOptions">
                    <!-- Options will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="quiz-screen">
        <div class="header">
            <div class="title" id="quizTitle">Vocabulary Quiz</div>
            <div class="controls">
                <div class="count-display"><span id="total">0</span> Cards</div>
                <button class="header-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                <button class="header-btn" onclick="backToHub()">‚Üê Back</button>
            </div>
        </div>

        <div class="content-area">
            <div class="questions-grid" id="questionsGrid">
                <!-- Questions will be generated here -->
            </div>
        </div>

        <div class="bottom-controls">
            <button class="control-btn reveal-btn" id="toggleBtn" onclick="toggleAnswers()">üëÅ Show Answers</button>
            <button class="control-btn reset-btn" onclick="backToHub()">üîÑ New Quiz</button>
        </div>

        <div class="shortcuts">
            <strong>Teacher Controls:</strong><br>
            SPACEBAR: Toggle answers<br>
            ESC: Back to hub<br>
            F: Toggle fullscreen
        </div>
    </div>

    <!-- Save Status -->
    <div id="saveStatus" class="save-status">
        ‚úÖ Vocabulary saved successfully!
    </div>

    <script>
        // Global variables
        let vocabulary = [];
        let currentQuestions = [];
        let quizType = '';
        let answersVisible = false;
        let flashcardIndex = 0;
        let hootQuestionIndex = 0;
        let hootScore = 0;
        let hootTimer = null;
        let hootTimeLeft = 7;

        // Check for saved API key on load
        window.onload = function() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                updateApiKeyStatus(true);
            } else {
                updateApiKeyStatus(false);
            }
        };

        // Load vocabulary from file
        async function loadVocabularyFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (data.vocabulary && Array.isArray(data.vocabulary)) {
                    vocabulary = data.vocabulary;
                    console.log('Loaded vocabulary from file:', vocabulary.length, 'words');
                    
                    if (vocabulary.length === 0) {
                        alert('The vocabulary file is empty');
                        return;
                    }
                    
                    // Skip processing and go directly to hub
                    document.getElementById('setupScreen').style.display = 'none';
                    showHub();
                    
                    // Show notification
                    showSaveStatus('‚úÖ Vocabulary loaded from file!');
                } else {
                    alert('Invalid vocabulary file format');
                }
            } catch (error) {
                console.error('Error loading file:', error);
                alert('Error loading vocabulary file: ' + error.message);
            }
            
            // Reset file input
            event.target.value = '';
        }

        // Update API key status indicator
        function updateApiKeyStatus(saved) {
            const status = document.getElementById('apiKeyStatus');
            if (saved) {
                status.className = 'api-key-status saved';
                status.innerHTML = '‚úì API key saved';
            } else {
                status.className = 'api-key-status missing';
                status.innerHTML = '‚ö† No API key saved';
            }
        }

        // Save API key when it changes
        document.getElementById('apiKey').addEventListener('input', function(e) {
            if (e.target.value) {
                localStorage.setItem('gemini_api_key', e.target.value);
                updateApiKeyStatus(true);
            } else {
                localStorage.removeItem('gemini_api_key');
                updateApiKeyStatus(false);
            }
        });

        // Validate filename when it changes
        document.getElementById('fileName').addEventListener('input', function(e) {
            updateFileNameStatus(e.target.value.trim());
        });

        function updateFileNameStatus(fileName) {
            const status = document.getElementById('fileNameStatus');
            if (fileName) {
                // Basic filename validation
                const sanitized = sanitizeFileName(fileName);
                if (sanitized !== fileName) {
                    status.className = 'api-key-status missing';
                    status.innerHTML = '‚ö† Invalid characters will be removed';
                } else {
                    status.className = 'api-key-status saved';
                    status.innerHTML = '‚úì Valid filename';
                }
            } else {
                status.className = 'api-key-status missing';
                status.innerHTML = '‚ö† Filename is required';
            }
        }

        function sanitizeFileName(fileName) {
            return fileName
                .replace(/[^a-zA-Z0-9\-_]/g, '-')
                .replace(/--+/g, '-')
                .replace(/^-|-$/g, '')
                .toLowerCase();
        }

        async function processVocabulary() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const text = document.getElementById('textInput').value.trim();
            const fileName = document.getElementById('fileName').value.trim();

            if (!apiKey) {
                alert('Please enter your Gemini API key');
                return;
            }

            if (!fileName) {
                alert('Please enter a filename to save the vocabulary');
                document.getElementById('fileName').focus();
                return;
            }

            if (!text) {
                alert('Please paste your vocabulary!');
                return;
            }
            
            // Show processing screen
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('processingScreen').style.display = 'flex';

            try {
                const processedText = await processWithGemini(text, apiKey);
                vocabulary = parseGeminiOutput(processedText);
                
                if (vocabulary.length === 0) {
                    throw new Error('No vocabulary found in Gemini output');
                }

                // Auto-save vocabulary
                await saveVocabulary(sanitizeFileName(fileName));
                
                showHub();
            } catch (error) {
                console.error('Processing error:', error);
                alert('Error processing with Gemini: ' + error.message);
                
                // Go back to setup
                document.getElementById('processingScreen').style.display = 'none';
                document.getElementById('setupScreen').style.display = 'flex';
            }
        }

        async function processWithGemini(text, apiKey) {
            const prompt = `Convert the following vocabulary list into a standardized 3-line format. Each vocabulary entry should be formatted as:
word/phrase
/IPA pronunciation/
Vietnamese meaning

Important rules:
- Each entry must be exactly 3 lines
- Line 1: The English word or phrase (remove any part of speech like (n), (v), (adj))
- Line 2: IPA pronunciation in forward slashes (if not provided, write //)
- Line 3: Vietnamese meaning
- Leave a blank line between entries
- Do not add any extra text, explanations, or formatting
- If IPA is not provided in the input, use // as placeholder

Input vocabulary:
${text}

Output only the formatted vocabulary, nothing else:`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 2048,
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Gemini API error');
            }

            const data = await response.json();
            const processedText = data.candidates[0].content.parts[0].text;
            console.log('Gemini processed text:', processedText);
            return processedText;
        }

        function parseGeminiOutput(text) {
            const entries = text.trim().split(/\n\s*\n/);
            const parsed = [];

            for (const entry of entries) {
                const lines = entry.trim().split('\n').filter(line => line.trim());
                
                if (lines.length >= 2) {
                    let word = lines[0].trim();
                    let ipa = '';
                    let meaning = '';

                    if (lines.length === 3) {
                        ipa = lines[1].trim();
                        meaning = lines[2].trim();
                    } else if (lines.length === 2) {
                        meaning = lines[1].trim();
                    }

                    // Clean up IPA
                    if (ipa && ipa !== '//') {
                        if (!ipa.startsWith('/')) ipa = '/' + ipa;
                        if (!ipa.endsWith('/')) ipa = ipa + '/';
                    } else {
                        ipa = '';
                    }

                    parsed.push({ word, ipa, meaning });
                }
            }

            return parsed;
        }

        async function saveVocabulary(fileName) {
            try {
                const response = await fetch('http://localhost:3001/api/vocabulary/save-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vocabulary: vocabulary,
                        source: 'Gemini Enhanced Quiz',
                        fileName: fileName
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save vocabulary');
                }

                const result = await response.json();
                console.log('Vocabulary saved:', result);
                
                // Show save status
                showSaveStatus();
            } catch (error) {
                console.error('Error saving vocabulary:', error);
                // Don't block the user from using the app even if save fails
            }
        }

        function showSaveStatus(message) {
            const status = document.getElementById('saveStatus');
            if (message) {
                status.textContent = message;
            } else {
                status.textContent = '‚úÖ Vocabulary saved successfully!';
            }
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        function showHub() {
            document.getElementById('processingScreen').style.display = 'none';
            hideAllViews();
            const hubScreen = document.getElementById('hubScreen');
            hubScreen.style.display = 'flex';
            hubScreen.classList.add('active');
            
            document.getElementById('wordCount').textContent = `${vocabulary.length} words`;
        }

        function backToSetup() {
            hideAllViews();
            document.getElementById('setupScreen').style.display = 'flex';
        }

        function backToHub() {
            hideAllViews();
            const hubScreen = document.getElementById('hubScreen');
            hubScreen.style.display = 'flex';
            hubScreen.classList.add('active');
        }

        function hideAllViews() {
            // Hide all view screens
            const views = ['hubScreen', 'tableView', 'flashcardView', 'hootView', 'quizScreen'];
            views.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('active');
                    element.style.display = 'none';
                }
            });
        }

        // Table View
        function showTableView() {
            hideAllViews();
            const tableView = document.getElementById('tableView');
            tableView.style.display = 'flex';
            tableView.classList.add('active');
            document.getElementById('tableWordCount').textContent = `${vocabulary.length} words`;
            
            const tbody = document.getElementById('vocabTableBody');
            tbody.innerHTML = vocabulary.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td class="word-cell">${item.word}</td>
                    <td class="ipa-cell">${item.ipa || '-'}</td>
                    <td class="meaning-cell">${item.meaning}</td>
                </tr>
            `).join('');
        }

        // Flashcards
        function showFlashcards() {
            hideAllViews();
            const flashcardView = document.getElementById('flashcardView');
            flashcardView.style.display = 'flex';
            flashcardView.classList.add('active');
            flashcardIndex = 0;
            showFlashcard();
        }

        function showFlashcard() {
            if (!vocabulary || vocabulary.length === 0) return;
            
            const card = vocabulary[flashcardIndex];
            document.getElementById('flashcardFront').textContent = card.word;
            document.getElementById('flashcardIPA').textContent = card.ipa || '';
            document.getElementById('flashcardBack').textContent = card.meaning;
            document.getElementById('flashcardProgress').textContent = `${flashcardIndex + 1} / ${vocabulary.length}`;
            
            // Reset flip
            document.getElementById('flashcard').classList.remove('flipped');
        }

        function flipCard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function nextCard() {
            if (flashcardIndex < vocabulary.length - 1) {
                flashcardIndex++;
                showFlashcard();
            } else {
                flashcardIndex = 0;
                showFlashcard();
            }
        }

        function previousCard() {
            if (flashcardIndex > 0) {
                flashcardIndex--;
                showFlashcard();
            } else {
                flashcardIndex = vocabulary.length - 1;
                showFlashcard();
            }
        }

        // VocabHoot Game
        function startVocabHoot() {
            hideAllViews();
            const hootView = document.getElementById('hootView');
            hootView.style.display = 'flex';
            hootView.classList.add('active');
            hootQuestionIndex = 0;
            hootScore = 0;
            document.getElementById('hootScore').textContent = 'Score: 0';
            
            // Start after a delay
            document.getElementById('hootQuestion').textContent = 'Get Ready!';
            document.getElementById('hootOptions').innerHTML = '';
            
            setTimeout(() => {
                showHootQuestion();
            }, 1500);
        }

        function showHootQuestion() {
            if (!vocabulary || vocabulary.length === 0 || hootQuestionIndex >= Math.min(vocabulary.length * 2, 20)) {
                endHootGame();
                return;
            }

            const correctIndex = Math.floor(Math.random() * vocabulary.length);
            const correct = vocabulary[correctIndex];
            
            // Random question type
            const questionType = Math.random() < 0.5 ? 'word' : 'meaning';
            
            if (questionType === 'word') {
                document.getElementById('hootQuestion').textContent = correct.word;
            } else {
                document.getElementById('hootQuestion').textContent = correct.meaning;
            }

            // Generate options
            const options = [correct];
            const usedIndices = [correctIndex];
            
            while (options.length < 4 && options.length < vocabulary.length) {
                const randomIndex = Math.floor(Math.random() * vocabulary.length);
                if (!usedIndices.includes(randomIndex)) {
                    options.push(vocabulary[randomIndex]);
                    usedIndices.push(randomIndex);
                }
            }

            // Shuffle options
            options.sort(() => Math.random() - 0.5);

            // Display options
            const optionsContainer = document.getElementById('hootOptions');
            optionsContainer.innerHTML = '';
            
            options.forEach((option, index) => {
                const text = questionType === 'word' ? option.meaning : option.word;
                const optDiv = document.createElement('div');
                optDiv.className = 'hoot-option';
                optDiv.textContent = text;
                optDiv.onclick = () => checkHootAnswer(option.word, correct.word);
                optionsContainer.appendChild(optDiv);
            });

            // Start timer
            hootTimeLeft = 7;
            startHootTimer();
        }

        function startHootTimer() {
            const timerBar = document.getElementById('hootTimerBar');
            timerBar.style.width = '100%';
            
            if (hootTimer) clearInterval(hootTimer);
            
            hootTimer = setInterval(() => {
                hootTimeLeft -= 0.1;
                timerBar.style.width = `${(hootTimeLeft / 7) * 100}%`;
                
                if (hootTimeLeft <= 0) {
                    clearInterval(hootTimer);
                    timeOutHoot();
                }
            }, 100);
        }

        function checkHootAnswer(selected, correct) {
            clearInterval(hootTimer);
            
            const options = document.querySelectorAll('.hoot-option');
            const correctItem = vocabulary.find(v => v.word === correct);
            const selectedItem = vocabulary.find(v => v.word === selected);
            
            options.forEach(option => {
                option.onclick = null;
                if (correctItem && (option.textContent === correctItem.meaning || option.textContent === correct)) {
                    option.classList.add('correct');
                } else if (selectedItem && selected !== correct && 
                          (option.textContent === selectedItem.meaning || option.textContent === selected)) {
                    option.classList.add('wrong');
                }
            });

            if (selected === correct) {
                hootScore += Math.round((hootTimeLeft / 7) * 100) + 100;
                document.getElementById('hootScore').textContent = `Score: ${hootScore}`;
            }

            setTimeout(() => {
                hootQuestionIndex++;
                showHootQuestion();
            }, 1500);
        }

        function timeOutHoot() {
            const options = document.querySelectorAll('.hoot-option');
            options.forEach(option => {
                option.onclick = null;
            });

            setTimeout(() => {
                hootQuestionIndex++;
                showHootQuestion();
            }, 1500);
        }

        function endHootGame() {
            document.getElementById('hootQuestion').textContent = `Game Over! Final Score: ${hootScore}`;
            document.getElementById('hootOptions').innerHTML = '<button class="control-btn btn-primary" onclick="startVocabHoot()">Play Again</button>';
        }

        // Quiz functions
        function startQuiz(type) {
            quizType = type;
            generateQuiz();
            showQuizScreen();
        }

        function generateQuiz() {
            currentQuestions = [];
            const shuffled = [...vocabulary].sort(() => Math.random() - 0.5);
            
            shuffled.forEach((item, index) => {
                let questionType = quizType;
                if (quizType === 'mixed') {
                    questionType = Math.random() > 0.5 ? 'type1' : 'type2';
                }
                
                currentQuestions.push({
                    id: index,
                    type: questionType,
                    word: item.word,
                    meaning: item.meaning,
                    ipa: item.ipa || ''
                });
            });
        }

        function showQuizScreen() {
            hideAllViews();
            const quizScreen = document.getElementById('quizScreen');
            quizScreen.style.display = 'flex';
            quizScreen.classList.add('active');
            
            const typeNames = {
                'type1': 'üìù Fill in the Word',
                'type2': 'üî§ Fill in the Meaning',
                'mixed': 'üé≤ Mixed Quiz'
            };
            
            document.getElementById('quizTitle').textContent = typeNames[quizType];
            document.getElementById('total').textContent = currentQuestions.length;
            
            displayQuestions();
        }

        function displayQuestions() {
            const grid = document.getElementById('questionsGrid');
            grid.innerHTML = currentQuestions.map(q => {
                if (q.type === 'type1') {
                    // Show meaning, hide word
                    return `
                        <div class="vocab-card">
                            <div class="card-number">${q.id + 1}</div>
                            <div class="vocab-content">
                                <div class="vocab-row">
                                    <span class="vocab-label">Word:</span>
                                    <div class="blank-space" id="blank-${q.id}">
                                        <span class="blank-placeholder">___________</span>
                                        <div class="answer-text word-answer" id="answer-${q.id}">${q.word}</div>
                                    </div>
                                </div>
                                <div class="vocab-row">
                                    <span class="vocab-label">Meaning:</span>
                                    <div class="vocab-value meaning-text">${q.meaning}</div>
                                </div>
                                ${q.ipa ? `
                                <div class="ipa-row">
                                    <span class="ipa-label">IPA:</span>
                                    <div class="ipa-text">${q.ipa}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Show word, hide meaning
                    return `
                        <div class="vocab-card">
                            <div class="card-number">${q.id + 1}</div>
                            <div class="vocab-content">
                                <div class="vocab-row">
                                    <span class="vocab-label">Word:</span>
                                    <div class="vocab-value word-text">${q.word}</div>
                                </div>
                                <div class="vocab-row">
                                    <span class="vocab-label">Meaning:</span>
                                    <div class="blank-space" id="blank-${q.id}">
                                        <span class="blank-placeholder">___________</span>
                                        <div class="answer-text meaning-answer" id="answer-${q.id}">${q.meaning}</div>
                                    </div>
                                </div>
                                ${q.ipa ? `
                                <div class="ipa-row">
                                    <span class="ipa-label">IPA:</span>
                                    <div class="ipa-text">${q.ipa}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            answersVisible = false;
            updateToggleButton();
        }

        function toggleAnswers() {
            answersVisible = !answersVisible;
            
            currentQuestions.forEach(q => {
                const answerEl = document.getElementById(`answer-${q.id}`);
                const blankEl = document.getElementById(`blank-${q.id}`);
                const placeholderEl = blankEl.querySelector('.blank-placeholder');
                
                if (answersVisible) {
                    answerEl.classList.add('show');
                    blankEl.classList.add('revealed');
                    placeholderEl.style.opacity = '0';
                } else {
                    answerEl.classList.remove('show');
                    blankEl.classList.remove('revealed');
                    placeholderEl.style.opacity = '1';
                }
            });
            
            updateToggleButton();
        }

        function updateToggleButton() {
            const btn = document.getElementById('toggleBtn');
            if (answersVisible) {
                btn.textContent = 'üôà Hide Answers';
                btn.className = 'control-btn hide-btn';
            } else {
                btn.textContent = 'üëÅ Show Answers';
                btn.className = 'control-btn reveal-btn';
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('quizScreen').classList.contains('active')) {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        toggleAnswers();
                        break;
                    case 'Escape':
                        backToHub();
                        break;
                    case 'f':
                    case 'F':
                        toggleFullscreen();
                        break;
                }
            } else if (document.getElementById('flashcardView').classList.contains('active')) {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        flipCard();
                        break;
                    case 'ArrowRight':
                        nextCard();
                        break;
                    case 'ArrowLeft':
                        previousCard();
                        break;
                }
            }
        });
    </script>
</body>
</html>